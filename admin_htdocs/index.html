<html>
<head>
    <title>PyRar Admin</title>
    <meta charSet="utf-8"/>
    <script src="/usr/theme.js"></script>
    <script src="/usr/punycode.js"></script>
    <script src="/usr/lib.js"></script>
    <script src="/usr/picklists.js"></script>
    <script src="/usr/countries.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = false;

const pow10 = { 0:1, 1:10, 2:100, 3:1000, 4:10000, 5:10000, 6:100000, 7:1000000, 8:10000000, 9:100000000 };

const pre_get_elm = [ "emailSearch","domainSearch","topMsg","myMsgPop","userInfo","moreInfo","businessName" ];
const money_format = [ "acct_current_balance","acct_previous_balance","acct_overdraw_limit","acct_warn_low_balance",
	"amount","pre_balance","post_balance","price_charged","price_paid"];

const list_columns = {
	"events": [ "when_dt","who_did_it","event_type","notes" ],
	"actions": [ "execute_dt","action"],
	"sales": [ "created_dt","sales_type","num_years","price_charged","price_paid" ],
	"transactions": [ "created_dt","description","amount","pre_balance","post_balance" ],
	"payments": [ "created_dt","provider","provider_tag" ],
	"domains": ["name","status_id","created_dt","expiry_dt","ns" ],
	"sysadmins": ["login","htpasswd","amended_dt" ]
	};

const order_by = {
	"events" : "event_id desc",
	"actions": "execute_dt",
	"sales": "sales_item_id desc",
	"transactions": "acct_sequence_id desc",
	"sysadmins": "login"
	};

const table_desc = {
	"actions" : "Actions to apply to a domain in the future",
	"backend" : "Actions to ask a registry to apply to a domain now",
	"contacts" : "Unused, but maybe needed",
	"deleted_domains" : "Domains that have been deleted",
	"domains" : "SLDs owned by users",
	"events" : "Recorded events applied to tables / users",
	"orders" : "Orders from users waiting to be paid for",
	"payments" : "Information abou how users pay",
	"sales" : "Domain sales we have made to users",
	"session_keys" : "Key for user's login session",
	"sysadmins" : "Logins for the admin system",
	"transactions" : "Credit / Debit transactions on a user's account",
	"users" : "Users in the system / logins",
	"zones" : "TLDs we sell"
	};

linked_tables = {};
elm = {};
gbl = {
    theme: window.localStorage.theme,
    url_prefix: "/adm/v1/",

    tick: "&#x2611;",
    cross: "&#x2612;",
    timer: "&#x23f3;",
    cut: "&#x2702;",
    waste: "&#x1F5D1;",
    warn: "&#x26a0;",
    page: "&#x1F5CE;",
    nsec: "&#x1F512;",
    nsec3: "&#x1F510;",
    clip: "&#x1F4CE;",
    cart: "&#128722;",
    email: "&#128231;",
    copy: "&#x2398",
    credit: "&#x1F4B3;",
    lock: "&#x1F512;",

    gap: "<div style='height: 7px;'></div>",
    settings_spacer: "<tr><td><div style='height: 70px;'></div></td></tr>",

    def_max_checks: 2
    };

ctx = {};
gbl.head = document.head || document.getElementsByTagName('head')[0];

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
    gbl.theme="default";
    window.localStorage.setItem("theme",gbl.theme);
    }

changeTheme(gbl.theme);
if (window.location.pathname!="/") {
    window.localStorage.setItem("router_path",window.location.pathname);
    window.location = window.location.origin;
    }

function toggleTheme() { togglePopUp("themePopup",5000); }

function hideAllPopUp()
{
    hidePopUp();
    ["loginPopup","registerPopup","themePopup"].forEach(item => {
        let popup = document.getElementById(item);
        popup.classList.remove("show")
        });
}


function clr_lazy_hide()
{
    if (!ctx.popup) return;
    if (ctx.popup.timer) clearTimeout(ctx.popup.timer);
    delete ctx.popup;
}



function registry_type(domain)
{
	function find_tld(tld)
	{
		for(let i of gbl.config.zones)
			if (i.name==tld) return i;
		return null;
	}

	let pos = domain.indexOf(".");
	if (pos<0) return null;
	let tld = find_tld(domain.slice(pos+1));
	if (tld===null) return null;
	if (tld.registry in gbl.config.registry)
		return gbl.config.registry[tld.registry].type;
	return null;
}



function togglePopUp(name,tmout)
{
    if ("popup" in ctx) {
        let save_name = ctx.popup.name;
        hidePopUp();
        if (save_name==name) { unerrMsg(); return; }
        }

    let popup = document.getElementById(name);
    if (popup) popup.classList.toggle("show");

    let hide_now = null;
    if (tmout) {
        hide_now = setTimeout(hidePopUp,tmout);
        }

    ctx.popup = { "timer": hide_now, "name": name }

    let e = null;
	if (name=="AddSysAdmin") e = document.getElementById("sysadm_login");
    if (e) { e.focus(); e.select(); }

    return false;
}



function hidePopUp()
{
    if (!("popup" in ctx)) return;
    let popup = document.getElementById(ctx.popup.name);
    if (popup) popup.classList.remove("show")
    clr_lazy_hide();
}

function do_theme_change(value)
{
    clr_lazy_hide();
    if (value in theme_colours) changeTheme(value);
    let popup = document.getElementById("themePopup");
    popup.classList.remove("show")
}


function pretty_prompt(tag)
{
	let s = tag.split("_");
	for(let i in s)
		s[i] = s[i][0].toUpperCase() + s[i].substr(1);
	return s.join(" ");
}



function table_col_val(col,val)
{
	let s = col.split(".");
	return push_table_link(s[0],{ "where": { "=":{ [s[1]]:val } } });
}



function tableLink(table,where)
{
	callApi("data/"+table,(ok,reply) => {
		if (!ok) return def_errMsg(`Error loading ${table} '${JSON.stringify(where)}'`,reply,"userInfo");

		let data = reply[table];

		if ((!data)||(!data.length)) {
			errMsg(`Record search '${table}': '${JSON.stringify(where)}' not found`,"userInfo");
			if ((table=="users")&&(elm.emailSearch.value!="")) elm.emailSearch.focus();
			return;
			}

		if (table=="users") elm.emailSearch.value="";
		if (table=="domains") elm.domainSearch.value="";

		elm.moreInfo.innerHTML = html_one_record(table,data[0]);

		},{ json: where});

	return false;
}



function link_col_val(col,val)
{
	let s = col.split(".");
	let where = { "where": { "=":{ [s[1]] : val } } }
	if (s[0] in order_by) where["order"] = order_by[s[0]];
	return linkedData(s[0],where);
}



function best_where(table,db_rec)
{
	let clause = {};
	let t = gbl.config.schema[table];
	for(let i of t.indexes[t.best_index].columns) 
		if (i in db_rec) clause[i] = db_rec[i];
	return JSON.stringify(clause);
}



function sysadmins()
{
	linkedData("sysadmins",{"order":order_by["sysadmins"]},"moreInfo");
}

function do_add_sys_admin()
{
	let f = document.addSysAdm;
	if (!(f.sysadm_login.value)||(!f.sysadm_password.value)) {
		f.sysadm_login.focuds();
		return errMsg("Please fill out all the fields","AddSysAdmin"); }

	insert_data = {
		"login":f.sysadm_login.value,
		"htpasswd":f.sysadm_password.value,
		"amended_dt":null,
		"created_dt":null
		};

	callApi("data/sysadmins",(ok,reply) => {
		if (!ok) return def_errMsg("Adding sysadmin user failed",reply,AddSysAdmin);

		hidePopUp();
		sysadmins();

		},{ json:{"set":insert_data}, method: "PUT" });

	return false;
}



function add_sysadmin_form()
{
	let x = "<form action=# onSubmit='return do_add_sys_admin();' name=addSysAdm><table>";
	x += settings_prompt("Login")+"<input id=sysadm_login onkeyUp='keyEsc(event);' style='width:250px;'></td></tr>";
	x += settings_prompt("Password")+"<input id=sysadm_password type=password onkeyUp='keyEsc(event);' autocomplete='new-password' style='width:250px;'></td></tr>";
	x += "<tr><td colspan=2 class=btmBtnBar id=crdb_btns>";
	x += "<input type=button onClick='hidePopUp();' class=myBtn style='width: 150px' value='Cancel'>";
	x += "<input type=submit class=myBtn style='width: 150px' value='OK'>";
	x += "</td></tr></form>";
	x += "</table>";
	return x;
}

function keyEsc(e) { if (e.key == "Escape") hidePopUp(); }


function linkedData(table,where,location)
{
	callApi("data/"+table,(ok,reply) => {
		if (!ok) return def_errMsg(`Error loading ${table} '${JSON.stringify(where)}'`,reply,"btnBarMore");

		let data = reply[table];
		if ((!data)||(!data.length)) return errMsg("No Data","btnBarMore");

		let x = "<table border=0 cellspacing=1 cellpadding=1 width=100%>";
		if (table == "sysadmins") {
			x += `<tr><td colspan=${list_columns[table].length} class=btmBtnBar>`;
			x += generic_popup_btn({
				"name": "AddSysAdmin",
				"label": "Add SysAdmin",
				"width": 100,
				"timeout": null,
				"title": "Add a System Administrator",
				"internal": add_sysadmin_form,
				"style": "overflow: auto; margin-left: -300;"
				});
			x += "</td></tr>";
			x += "<tr><td>"+gbl.gap+"</td></tr>";
			}
		x += "<tr>";
		for(let col of list_columns[table])
			x += `<th>${pretty_prompt(col)}</th>`;
		x += "</tr>";

		for(let i of data) {
			sub_where = `{"where": { "=": ${best_where(table,i)} } }`;
			x += `<tr onClick='push_table_link("${table}",${sub_where});' class=dataRow>`;
			for(let col of list_columns[table]) {
				value = i[col];

				if ((table=="domains")&&(col=="ns")&&(value==gbl.config.policy.dns_servers)) value="Our NS";

				if ((table=="domains")&&(col=="name")) {
					if (hasIDN(value)) value = `${fromPuny(value)} <span style="margin-left: 25px" class=searchRenew>${value}</span>`;
					}

				if ((col=="status_id")&&(value in gbl.config.status)) value = `${gbl.config.status[value]}&nbsp;&nbsp;(${value})`;
				if (col.slice(-3)=="_dt") value = value.split(" ")[0];
				if (money_format.includes(col))
					x += `<td align=right>${format_amount(value)}</td>`;
				else
					x += `<td>${value}</td>`;
				}
			x += "</tr>";
			}
		x += "</table>";

		let e = null;
		if (location === undefined)
			e = document.getElementById("moreData");
		else {
			if (location in elm) e = elm[location];
			else e = document.getElementById(location);
			}

		e.innerHTML = x;
		unerrMsg();

		},{ json: where});
}



function show_dns_data(domain)
{
	if (domain.slice(-1)!=".") domain += ".";

	callApi("dns/"+domain,(ok,reply) => {
        if (!ok) return def_errMsg("No DNS Data found for this domain",reply,"userInfo");

        if ((!reply)||(!reply.dns)||(!reply.dns.rrsets)||(!reply.dns.rrsets.length))
            return errMsg("No DNS Data found for this domain","userInfo");

        sort_rr_sets(reply);

		let x = "<table border=0 cellspacing=1 cellpadding=0 width=100%>";
		x += "<tr><th>Host</th><th>Type</th><th>TTL</th><th>Value</th></tr>";

		for(let i in reply.dns.rrsets) {
			let rrs = reply.dns.rrsets[i];
			for(let c in rrs.records) {
			let each_rr = rrs.records[c];
			let func = "edit_rr";

			let show_name = clean_host_name(domain,rrs.name);

			x += `<tr class=dataRow>`;
			x += `<td title='${rrs.name}'>${show_name}</td><td>${rrs.type}</td><td>${rrs.ttl}</td><td class=dnsData>${each_rr.content}</td></tr>`;

			if ((rrs.type=="SOA")&&(reply.dns.dnssec)&&(reply.dns.ds))
				x += `<tr class=dataRow><td>@</td><td>DS</td><td>${rrs.ttl}</td><td>${reply.dns.ds}</td></tr>`;
			}
		}

		x += "</table>";
		let e = document.getElementById("moreData");
		e.innerHTML = x;

		});
}


function show_regs_data(domain)
{
	callApi("regs/"+domain,(ok,reply) => {
		if (!ok) return def_errMsg("No DNS Data found for this domain",reply,"userInfo");

		let x = "<table border=0 cellspacing=1 cellpadding=0 width=100%>";
		x += "<tr><th>Registry Data</th></tr>"
		x += "<tr><td><xmp>"+JSON.stringify(reply, null, 3)+"</xmp></td></tr></table>";

		let e = document.getElementById("moreData");
		e.innerHTML = x;
		});
}



function prettyAmount(event,amt)
{
	let e = document.getElementById("pretty_amount");
	if ((!amt.value)||(isNaN(amt.value))) { e.innerHTML = "Invalid"; return; }

	let f = parseFloat(amt.value)*pow10[gbl.config.default_currency.decimal];
	if (f>0) pfx="Credit"; else pfx="Debit";
	e.innerHTML = pfx+"&nbsp;"+format_amount(Math.round(f));
}



function cancel_crdb()
{
	let e = document.getElementById("moreData");
	e.innerHTML = "";
}


function post_crdb(user_id)
{
	let amt = document.getElementById("crdb_amnt");
	if ((!amt.value)||(isNaN(amt.value))) {
		errMsg("Invalid amount field","crdb_btns");
		amt.focus(); return; }

	let desc = document.getElementById("crdb_desc");
	if (desc.value=="") {
		errMsg("You must give a description","crdb_btns");
		desc.focus(); return; }

	callApi("user/transaction",(ok,reply) => {
		if (!ok) return def_errMsg("Transaction failed to post",reply,"crdb_btns");
		linkedData("transactions", {"where":{"=":{"user_id":user_id}},"order":order_by["transactions"]});
		},{ json: {
			"user_id":user_id,
			"amount":amt.value,
			"description":desc.value
			}});
}



function user_cr_db(user_id)
{
	let e = document.getElementById("moreData");
	if ((e.innerHTML!="")&&(e.innerHTML.indexOf("crdb_amnt")>=0)) { e.innerHTML = ""; return; }

	let x = "<table border=0 cellspacing=2 cellpadding=2 style='min-width:600px;' align=center>";
	x += "<colgroup><col width=30%/><col/></colgroup>";
	x += settings_prompt("Description")+"<input placeholder='Description user will see' style='width: 350px' id=crdb_desc></td></tr>";
	x += settings_prompt("Amount")+gbl.config.default_currency.symbol;
	x += "<input onkeyup='prettyAmount(event,this);' placeholder='-ve=debit +ve=credit' style='width: 200px' id=crdb_amnt>"
	x += "<span style='padding-left: 50px' id=pretty_amount></span></td></tr>";

	x += "<tr><td colspan=2 class=btmBtnBar id=crdb_btns>";
	x += "<input type=button onClick='cancel_crdb();' class=myBtn style='width: 150px' value='Cancel'>";
	x += `<input type=button onClick='post_crdb(${user_id});' class=myBtn style='width: 150px' value='OK'>`;
	x += "</td></tr>";
	x += "</table>";

	e.innerHTML = x;

	e = document.getElementById("crdb_desc");
	e.focus();
}


function html_one_record(table, db_rec)
{
	let x = "<table border=0 cellspacing=0 cellpadding=1 align=center width=75%>";
	x += "<colgroup><col width=90%/><col/></colgroup>";
	x += `<tr><td colspan=2 class=settingsBanner>${pretty_prompt(table)}</td></tr>`;

	x += "<tr><td><table border=0 cellspacing=0 cellpadding=1 align=center width=100%>";
	x += "<colgroup><col width=30%/><col/></colgroup>";

	for(let i in db_rec) {
		if (i.slice(0,1)==":") continue;

		let value = db_rec[i];
		if (i=="name") value = `${fromPuny(value)} <span style="margin-left: 25px" class=searchRenew>${value}</span>`;

		if (money_format.includes(i)) value = format_amount(value);
		if (i in gbl.config.schema[":more:"].joins)
			value = `<a href=# onClick='return table_col_val("${gbl.config.schema[":more:"].joins[i]}","${value}");'>${value}</a>`;

		value = find_pick_value(table,i,value);
		if ((i=="ds")||(i=="ns")) value = value.split(",").join("<br>");
		x += `<tr class=dataRow><td align=right>${pretty_prompt(i)}&nbsp;:&nbsp;</td><td>${value}</td></tr>`;
		}

	x += "</table></td>";

	x += "<td id=btnBarMore><table>";
	x += `<tr><td><button style="width:140px" class=myBtn>Delete</button></td></tr>`;
	x += "<tr><td>"+gbl.gap+"</td></tr>";

	if (table in linked_tables) {

		let add_ending = false;

		if (table=="domains") {
			if (registry_type(db_rec.name)=="epp")
				x += `<tr><td><button style="width:140px" onClick="show_regs_data('${db_rec.name}');" class=myBtn>Reg's Data</button></td></tr>`;
			x += `<tr><td><button style="width:140px" onClick="show_dns_data('${db_rec.name}');" class=myBtn>P/DNS Data</button></td></tr>`;
			add_ending = true; }

		if (table=="sales"){
			x += `<tr><td><button style="width:140px" class=myBtn>Refund</button></td></tr>`;
			add_ending = true; }

		if (table=="users"){
			x += `<tr><td><button onClick="user_cr_db(${db_rec.user_id});" style="width:140px" class=myBtn>Credit/Debit</button></td></tr>`;
			add_ending = true; }

		if (add_ending) x += "<tr><td>"+gbl.gap+"</td></tr>";
	
		for(let i of linked_tables[table]) {
			s = i[1].split(".");
			x += `<tr><td><button style="width:140px" title="${table_desc[s[0]]}" onClick='link_col_val("${i[1]}",${db_rec[i[0]]});' class=myBtn>${pretty_prompt(s[0])}</button></td></tr>`;
			}
		}
	x += "</table></td>";

	x += "</tr>";
	x += "<tr><td colspan=2><div id=moreData></div></td></tr>";
	return x+"</table>";
}


function searchUser(email)
{
	if (isNaN(email)) return push_table_link("users",{ "where": { "=": { "email": email } } });
	return push_table_link("users",{ "where": { "=": { "user_id": email } } });
}


function searchDomain(domain)
{
	if (isNaN(domain)) {
		let as_puny = toASCII(domain);
		if ((as_puny!=domain)&&(hasIDN(as_puny))) domain = as_puny;
		return push_table_link("domains", { "where": { "=": { "name":domain } } });
		}
	return push_table_link("domains", { "where": { "=": { "domain_id":domain } } });
}


function push_table_link(table,where)
{
	push_hist({"func":"table_link","data":{"table":table,"where":where}});
	return tableLink(table,where);
}



function key_down(event,input_id)
{
	if (event.key!="Enter") return;
	let e = document.getElementById(input_id);
	if (input_id=="domainSearch") return searchDomain(e.value);
	if (input_id=="emailSearch") return searchUser(e.value);
}



function history_back(event)
{
	function pop_table_link(data)
	{
		tableLink(data.table,data.where);
	}

	let router = {
		"start": go_welcome,
		"table_link": pop_table_link
		};

	if ((event.state.func)&&(event.state.func in router)) {
		router[event.state.func](event.state.data);
		}

	return true;
}



function startUp()
{
	window.addEventListener('popstate',history_back);
	go_welcome(true);
}

function push_hist(data)
{
	window.history.pushState(data,"");
}



function best_index(indexes)
{
	let best_name = Object.keys(indexes)[0];
	let best_idx = indexes[best_name];
	for(let i in indexes) {
		if ((indexes[i].columns.length == best_idx.columns.length)&&(indexes[i].unique)&&(!best_idx.unique)) { best_name = i; best_idx = indexes[i]; }
		if (indexes[i].columns.length < best_idx.columns.length) { best_name = i; best_idx = indexes[i]; }
		}
	return best_name;
}


function go_welcome(with_push)
{
	if (with_push) push_hist({"func":"start"});
	pre_get_elm.forEach(i => { elm[i] = document.getElementById(i); } );
	callApi("config",(ok,reply) => {
		if (!ok) return def_errMsg("Error contacting servers",reply,"userInfo");

		gbl.config = reply;
		gbl.currency = policy("currency",gbl.config.default_currency);

		let my_icon = policy("icon",null);
		let site_name = "Admin: "+policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			site_name = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		elm.businessName.innerHTML = `<a href="${policy('website_name')}">${site_name}</a>`;

		linked_tables = {};
		for(let i in gbl.config.schema) {
			if ((i[0]!=':')&&(gbl.config.schema[i].indexes)&&(Object.keys(gbl.config.schema[i].indexes).length)) {
				gbl.config.schema[i].best_index = best_index(gbl.config.schema[i].indexes);
				}

			for(let col in gbl.config.schema[i].columns) {
				if (col in gbl.config.schema[":more:"].joins) {
					full_col = i+"."+col;
					if (full_col == gbl.config.schema[":more:"].joins[col]) continue;
					s = gbl.config.schema[":more:"].joins[col].split(".");

					if (!(s[0] in linked_tables)) linked_tables[s[0]] = [];
					if (i.slice(0,8)!="deleted_")
						linked_tables[s[0]].push([ s[1], full_col ]);
					}
				}
			}
		elm.moreInfo.innerHTML = "<h2>Welcome</h2>";
		});
}

</script>

<body onLoad="startUp();">

<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<colgroup><col width=40%/><col width=200px/><col width=40%/></colgroup>
<tr>
<td align=left><span id="businessName" class="businessName">PyRar Admin</span></td>
<td rowspan=2 align=center><div style="width: 200px margin:20px; font-size: 20px;" id="topMsg">&nbsp;</div></td>
<td align=right>
<span onClick="sysadmins()" style='width: 110px;' class=myBtn>SysAdmins</span>
<a href="/pdns.html" target=_window><span name=hitMe style='width: 110px;' class=myBtn>PowerDNS</span></a>

</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 85px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
</div>
</td>
<td><span style="width:100px" id="userInfo">&nbsp;</span>
DOM:<input onKeyDown="key_down(event,'domainSearch');" id=domainSearch style="width:250px">
USR:<input onKeyDown="key_down(event,'emailSearch');" id=emailSearch style="width:250px">
</td></tr>
</table>
</div>


<div id="lowerSpan">
    <div style='height: 10px;'></div>
	<div class=botSapce id="moreInfo">&nbsp;</div>
</div>

<div onClick="unerrMsg();" id=myMsgPop class='msgPop msgPopNo'></div>
