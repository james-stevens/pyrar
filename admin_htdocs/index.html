<html>
<head>
    <title>PyRar Admin</title>
    <meta charSet="utf-8"/>
    <script src="/usr/theme.js"></script>
    <script src="/usr/punycode.js"></script>
    <script src="/usr/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = false;

const pre_get_elm = [ "emailSearch","domainSearch","topMsg","myMsgPop","userInfo","moreInfo","businessName" ];
const money_format = [ "acct_current_balance","acct_previous_balance","acct_overdraw_limit","acct_warn_low_balance",
	"price_charged","price_paid"];

elm = {};
gbl = {
    theme: window.localStorage.theme,
    url_prefix: "/adm/v1/",

    tick: "&#x2611;",
    cross: "&#x2612;",
    timer: "&#x23f3;",
    cut: "&#x2702;",
    waste: "&#x1F5D1;",
    warn: "&#x26a0;",
    page: "&#x1F5CE;",
    nsec: "&#x1F512;",
    nsec3: "&#x1F510;",
    clip: "&#x1F4CE;",
    cart: "&#128722;",
    email: "&#128231;",
    copy: "&#x2398",
    credit: "&#x1F4B3;",
    lock: "&#x1F512;",

    gap: "<div style='height: 7px;'></div>",
    settings_spacer: "<tr><td><div style='height: 70px;'></div></td></tr>",

    def_max_checks: 2
    };

ctx = {};
gbl.head = document.head || document.getElementsByTagName('head')[0];

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
    gbl.theme="default";
    window.localStorage.setItem("theme",gbl.theme);
    }

changeTheme(gbl.theme);
if (window.location.pathname!="/") {
    window.localStorage.setItem("router_path",window.location.pathname);
    window.location = window.location.origin;
    }

function toggleTheme() { togglePopUp("themePopup",5000); }

function hideAllPopUp()
{
    hidePopUp();
    ["loginPopup","registerPopup","themePopup"].forEach(item => {
        let popup = document.getElementById(item);
        popup.classList.remove("show")
        });
}


function clr_lazy_hide()
{
    if (!ctx.popup) return;
    if (ctx.popup.timer) clearTimeout(ctx.popup.timer);
    delete ctx.popup;
}




function togglePopUp(name,tmout)
{
    if ("popup" in ctx) {
        let save_name = ctx.popup.name;
        hidePopUp();
        if (save_name==name) { unerrMsg(); return; }
        }

    let popup = document.getElementById(name);
    if (popup) popup.classList.toggle("show");

    let hide_now = null;
    if (tmout) {
        hide_now = setTimeout(hidePopUp,tmout);
        }

    ctx.popup = { "timer": hide_now, "name": name }

    let e = null;
	// focus on edit box, if you want
    if (e) { e.focus(); e.select(); }

    return false;
}



function hidePopUp()
{
    if (!("popup" in ctx)) return;
    let popup = document.getElementById(ctx.popup.name);
    if (popup) popup.classList.remove("show")
    clr_lazy_hide();
}

function do_theme_change(value)
{
    clr_lazy_hide();
    if (value in theme_colours) changeTheme(value);
    let popup = document.getElementById("themePopup");
    popup.classList.remove("show")
}


function pretty_prompt(tag)
{
	let s = tag.split("_");
	for(let i in s)
		s[i] = s[i][0].toUpperCase() + s[i].substr(1);
	return s.join(" ");
}



function tableLink(col,val)
{
	if (col=="domains.domain_id") return searchDomain(null,val);

	let s = col.split(".");
	let where = { "where": { "=":{} } }
	where.where["="][s[1]] = val;

	callApi("data/"+s[0],(ok,reply) => {
		if (!ok) return def_errMsg(`Error loading ${s[0]} '${s[1]}'`,reply,"userInfo");

		let data = reply[s[0]];

		if ((!data)||(!data.length)) {
			errMsg(`Record search: ${col}='${val}' not found`,"userInfo");
			if ((s[0]=="users")&&(elm.emailSearch.value!="")) elm.emailSearch.focus();
			return;
			}

		elm.moreInfo.innerHTML = html_one_record(s[0],data[0]);

		if (s[0]=="users") elm.emailSearch.value="";

		},{ json: where});

	return false;
}



function html_one_record(table, db_rec)
{
	let x = "<table border=0 cellspacing=0 cellpadding=1 align=center width=75%>";

	let buttons = {};
	if (table in buttons) {
		x += "<tr><td colspan=2 class=btmBtnBar>";
		for(let i of buttons[table]) x += "";
		x += "</td></tr>";
		}

	x += "<colgroup><col width=30%/><col/></colgroup>";
	for(let i in db_rec) {
		if (i.slice(0,1)!=":") {
			let value = db_rec[i];
			if (i=="name") value = `${fromPuny(value)} <span style="margin-left: 25px" class=searchRenew>${value}</span>`;
			if ((i=="status_id")&&(value in gbl.config.status)) value = `${gbl.config.status[value]}&nbsp;&nbsp;(${value})`;

			if (money_format.includes(i)) value = format_amount(value);
			if (i in gbl.schema[":more:"].joins)
				value = `<a href=# onClick='return tableLink("${gbl.schema[":more:"].joins[i]}","${value}");'>${value}</a>`;

			x += `<tr class=dataRow><td align=right>${pretty_prompt(i)}&nbsp;:&nbsp;</td><td>${value}</td></tr>`;
			}
		}
	x += "<tr><td colspan=2><div id=domSales></div></td></tr></table>";
	return x;
}


function sales_records(sales)
{
	let x = "<table border=0 cellspacing=1 cellpadding=1 width=100%>";
	x += "<tr><td colspan=5>"+gbl.gap+"</td></tr>";
	x += "<tr><th colspan=5>Sales Records</th></tr>";
	x += "<tr>"
	for(let i of ["When","What","Yrs","Cost","Paid"]) x += `<th>${i}</th>`;
	x += "</tr>"
	for(let i of sales) {
		x += `<tr onClick='tableLink("sales.sales_item_id","${i.sales_item_id}");' class=dataRow>`;
		x += `<td align=center>${i.created_dt}</td>`;
		x += `<td align=center>${i.sales_type}</td>`;
		x += `<td align=center>${i.num_years}</td>`;
		x += `<td align=right>${format_amount(i.price_charged)}</td>`;
		x += `<td align=right>${format_amount(i.price_paid)}</td>`;
		x += "</tr>";
		}
	x += "</table>";
	return x;
}



function searchDomain(domain,id)
{
	let where = {"where": { "=": { "domain_id": id } } };
	if ((!id)&&(domain)) {
		let as_puny = toASCII(domain);
		if ((as_puny!=domain)&&(hasIDN(as_puny))) domain = as_puny;
		where = {"where": { "=": { "name": domain } } };
		}

	callApi("data/domains",(ok,reply) => {
		if (!ok) return def_errMsg(`Error loading domain '${domain}'`,reply,"userInfo");

		if ((!reply.domains)||(!reply.domains.length)) {
			errMsg(`Domain '${domain}' not found`,"domainSearch");
			elm.domainSearch.focus();
			return;
			}

		elm.moreInfo.innerHTML = html_one_record("domains",reply.domains[0]);
		elm.domainSearch.value="";

		callApi("data/sales",(ok,reply) => {
			if (!ok) return def_errMsg(`Error loading sales on domain '${domain}'`,reply,"userInfo");

			let e = document.getElementById("domSales");
			if (e) e.innerHTML = sales_records(reply.sales);

			}, { json: {"where": { "=": { "domain_id": reply.domains[0].domain_id } } } });

		},{ json: where });
}



function key_down(event,input_id)
{
	if (event.key!="Enter") return;
	let e = document.getElementById(input_id);
	if (input_id=="domainSearch") return searchDomain(e.value);
	if (input_id=="emailSearch") return tableLink("users.email",e.value);
}



function startUp()
{
	go_welcome(true);
}


function go_welcome(with_push)
{
	pre_get_elm.forEach(i => { elm[i] = document.getElementById(i); } );
	callApi("config",(ok,reply) => {
		if (!ok) return def_errMsg("Error contacting servers",reply,"userInfo");

		gbl.config = reply;
		gbl.currency = policy("currency",gbl.config.default_currency);

		let my_icon = policy("icon",null);
		let site_name = "Admin: "+policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			site_name = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		elm.businessName.innerHTML = `<a href="${policy('website_name')}">${site_name}</a>`;

		callApi("meta/schema",(ok,reply) => {
			if (!ok) return def_errMsg("Error contacting servers",reply,"userInfo");
			gbl.schema = reply;
			});
		});
}

</script>

<body onLoad="startUp();">

<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<colgroup><col width=40%/><col width=200px/><col width=40%/></colgroup>
<tr>
<td align=left><span id="businessName" class="businessName">PyRar Admin</span></td>
<td rowspan=2 align=center><div style="width: 200px margin:20px; font-size: 20px;" id="topMsg">&nbsp;</div></td>
<td align=right>
<a href="/pdns.html" target=_window><span name=hitMe style='width: 110px;' class=myBtn>PowerDNS</span></a>

</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 85px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
</div>
</td>
<td><span style="width:100px" id="userInfo">&nbsp;</span>
DOM:<input onKeyDown="key_down(event,'domainSearch');" id=domainSearch style="width:250px">
USR:<input onKeyDown="key_down(event,'emailSearch');" id=emailSearch style="width:250px">
</td></tr>
</table>
</div>


<div id="lowerSpan">
    <div style='height: 10px;'></div>
	<div class=botSapce id="moreInfo"><h2>Hello</h2></div>
</div>

<div onClick="unerrMsg();" id=myMsgPop class='msgPop msgPopNo'></div>
