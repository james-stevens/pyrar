#! /bin/sh
# (c) Copyright 2019-2022, James Stevens ... see LICENSE for details
# Alternative license arrangements possible, contact me for more information

lvl="$(jq .loglevel_nginx ${BASE}/etc/policy.json)"
if test "${lvl}" = "null"; then lvl="info"; fi

fac="$(jq .facility_nginx ${BASE}/etc/policy.json)"
if test "${fac}" = "null"; then fac="local0"; fi


{
echo "
worker_processes  3;
pid /run/nginx.pid;

events { worker_connections  1024; }

user nginx;
error_log syslog:server=unix:/dev/log,facility=${fac},tag=nginx error;

http {
	access_log syslog:server=unix:/dev/log,facility=${fac},tag=nginx,severity=${lvl};

	include         mime.types;
	default_type    application/octet-stream;
	sendfile        on;
	keepalive_timeout  65;

	upstream wsgi_checker {
		server unix:/run/wsgi_checker.sock;
		}
	server {
		listen 80;
		location /api {
			proxy_pass http://wsgi_checker/api;
			}
		root ${BASE}/htdocs;
		}
"

awk '{
	printf "\tupstream epp_%s {\n",$1
	printf "\t\tserver unix:/run/epp/wsgi_epprest_%s_1.sock;\n",$1
	print "\t\t}"
	printf "\tserver {\n\t\tlisten %d;\n\t\tlocation / {\n",$2
	printf "\t\t\tproxy_pass http://epp_%s;\n",$1;
	print "\t\t\t}\n\t\t}\n"
	}' /run/prov_ports

echo "}"

} > /run/nginx.conf
