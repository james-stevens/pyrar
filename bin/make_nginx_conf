#! /bin/sh
# (c) Copyright 2019-2022, James Stevens ... see LICENSE for details
# Alternative license arrangements possible, contact me for more information

facility="local0"

mkdir -p /run/epp

{
echo "
worker_processes  3;
pid /run/nginx.pid;

events { worker_connections  1024; }

user nginx;
error_log syslog:server=unix:/dev/log,facility=${facility},tag=nginx error;

http {
	access_log syslog:server=unix:/dev/log,facility=${facility},tag=nginx,severity=info;

	include         mime.types;
	default_type    application/octet-stream;
	sendfile        on;
	keepalive_timeout  65;
"

flat ${BASEDIR}/etc/providers.json | awk -F. '{ print $1 }' | sort -u | \
awk '{
	printf "\tupstream epp_%s {\n",$0
	printf "\t\tserver unix:/run/epp/wsgi_epprest_%s_1.sock;\n",$0
	print "\t\t}"
	printf "\tserver {\n\t\tlisten %d;\n\t\tlocation / {\n",9999+NR
	printf "\t\t\tproxy_pass http://epp_%s;\n",$0;
	print "\t\t\t}\n\t\t}\n"
	}'

echo "}"

} > /run/nginx.conf
