#! /bin/sh
# (c) Copyright 2019-2022, James Stevens ... see LICENSE for details
# Alternative license arrangements possible, contact me for more information

if test "${SYSLOG_SERVER}"
	then
		echo "*.* @${SYSLOG_SERVER}"
	else
		echo "*.* -/dev/console"
	fi > /run/syslog.conf

export BASE="/opt/pyrar"

/usr/local/bin/make_inittab

if test -d /etc/start.d
	then
		for file in /etc/start.d/*
			do
				. ${file}
			done
	fi

mkdir -p /run/epp
mkdir /run/nginx; chown nginx: /run/nginx

flat ${BASE}/etc/providers.json | awk -F. 'BEGIN { n=10000 }
	{ if (have[$1]=="") have[$1]=n++; }
	/\.sessions=/ { ses[$1]=substr($0,index($0,"=")+1) } 
	END {
		for(x in have) {
			if (ses[x]=="") n=3; else n=ses[x];
			print x,have[x],n 
			}
		}' > /run/prov_ports

exec /sbin/init
