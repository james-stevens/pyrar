#! /bin/sh
# (c) Copyright 2019-2022, James Stevens ... see LICENSE for details
# Alternative license arrangements possible, contact me for more information

export BASE="/opt/pyrar"
export PYTHONPATH=${BASE}/python

syslog="$(jq .syslog_server ${BASE}/etc/policy.json | tr -d '"')"

if test "${syslog}" = "null"
	then
		echo "*.* -/dev/console"
	else
		echo "*.* @${syslog}"
	fi > /run/syslog.conf

mkdir -p /run/epp
mkdir /run/nginx; chown nginx: /run/nginx

mkdir ${BASE}/storage ${BASE}/storage/perm ${BASE}/storage/perm/email
mkdir ${BASE}/storage/shared ${BASE}/storage/shared/signals


flat ${BASE}/etc/registry.json | awk -F. 'BEGIN { n=10000 }
	{ if (have[$1]=="") have[$1]=n++; }
	/\.sessions=/ { ses[$1]=substr($0,index($0,"=")+1) } 
	/\.type=/ { typ[$1]=substr($0,index($0,"=")+1) } 
	END {
		for(x in have) {
			if (typ[x]!="epp") continue;
			if (ses[x]=="") n=3; else n=ses[x];
			print x,have[x],n 
			}
		}' > /run/regs_ports


if test "${PDNS_API_KEY}"
	then
		echo "${PDNS_API_KEY}" > /run/pdns_api_key
	else
		export PDNS_API_KEY="$(dd if=/dev/urandom bs=1 count=50 2>/dev/null | base64 | tr -d $'\n +=./')"
		echo "${PDNS_API_KEY}" > /run/pdns_api_key
		chmod 400 /run/pdns_api_key
	fi

${BASE}/python/bin/policy_subst.py

/usr/local/bin/make_inittab

exec /sbin/init
