<html>
<head>
    <title>Python Registrar</title>
    <meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'></style>
<script language="Javascript">

debugAPI = true;


gbl = {
	"server": window.location.host,
	"theme": window.localStorage.getItem("theme"),

    tick: "&#x2611;",
    cross: "&#x2612;",
    timer: "&#x23f3;",
    bin: "&#x2702;",
    warn: "&#x26a0;",
    page: "&#x1F5CE;",
    nsec: "&#x1F512;",
    nsec3: "&#x1F510;",
    clip: "&#x1F4CE;",

    gap: "<div style='height: 7px;'></div>",

    max_per_search: 5
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="dark";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);

function errMsg(line) { console.log("errMsg",line); }
function msg(line) { console.log("msg",line); }

function bodyLoaded()
{
	callApi("zones",data => { gbl.zones = data; });
}



function fromIDN()
{
	let f = document.form1;
	f.puny.value = toASCII(f.idn.value);
	f.idn.value = "";
}



function fromPuny()
{
	let f = document.form1;
	f.idn.value = toUnicode(f.puny.value);
	f.puny.value = "";
}



function btn(call,txt,hlp,sz) {
    let ex=""
    if (sz != null) ex = `style='width: ${sz}px;'`
    return `<span ${ex} title="${hlp}" class=myBtn onClick="${call}; return false;">${txt}</span>`;
}



function showSearch(data)
{
	let e = document.getElementById("output");

	if ("error" in data) {
		e.innerHTML = "<h2>" + data.error + "</h2>";
		return;
		}

	gbl.search.result = gbl.search.result.concat(data);

	let x = "<table align=center>";
	for(let item of gbl.search.result) {
		if (item.name=="-") {
			x += "<tr><td colspan=4><hr></td></tr>";
			continue;
			}

		if (!item.avail) continue;

		x += "<tr>";
		x += `<td>${fromPuny(item.name)}</td>`;
		if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
		else {
			if ("create" in item) {
				x += "<td align=right>";
				x += btn(`buyOneName('${item.name}')`,`BUY $${item.create}`,"Buy this domain",120);
				x += "</td>";
				}
			if ("renew" in item) x += `<td align=right>renew $${item.create}</td>`;
			}
		x += "</tr>";
		}

	e.innerHTML = x + "</table>";

	if (("search" in gbl)&&("todo" in gbl.search)) {
		if (gbl.search.todo.length <= 0) delete gbl.search; else searchNext();
		}
	else {
		gbl.search.result.push({"name":"-"});
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buyOneName(name)
{
	callApi("domain/check",(data) => {

		let item = data.shift();
		let e = document.getElementById("output");
		e.innerHTML = `<h2>Buy '${item.name}' for $${item.create}</h2>`;

		}, { json: { "domain" : name }}); 
}



function searchNext()
{
	let first = gbl.search.todo.shift();
	let srch = [ gbl.search.term + "." + first.name ];

	while((gbl.search.todo.length > 0)&&(srch.length < gbl.max_per_search)&&(first.provider == gbl.search.todo[0].provider)) {
		let nxt = gbl.search.todo.shift();
		srch.push(gbl.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}



function fromPuny(fqdn)
{
	if ((fqdn.substr(0,4)=="xn--")||(fqdn.indexOf(".xn--") > 0))
		return toUnicode(fqdn);
	return fqdn;
}



function multiSearch(srch,not_me_tld)
{
	gbl.search.todo = [];
	gbl.search.term = srch;
	for(x of gbl.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) gbl.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
    delete gbl.search;

	let e = document.getElementById("output");
	e.innerHTML = "";

    gbl.search = {};
    gbl.search.result = [];

    f = document.searchForm;
    let srch = toASCII(f.search.value);

    if (srch.indexOf(".") >= 0)
		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
	else
		multiSearch(srch,null);

    f.search.focus();
    f.search.select();
    return false;
}



</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% height=100%><tr><Td>Title</td></tr></table>
</div>
<table align=center>
<form name=searchForm onSubmit="return doSearch();">
<tr><td><input autofocus class=searchBox name=search size=50></td></tr>
</form>
</table>
<div id="output"></div>
</body>
</html>
