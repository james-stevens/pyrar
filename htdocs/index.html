<html>
<head>
	<title>Python Registrar</title>
	<meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = false;

elm = {};
gbl = {
	"theme": window.localStorage.theme,

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	cut: "&#x2702;",
	waste: "&#x1F5D1;",
	warn: "&#x26a0;",
	page: "&#x1F5CE;",
	nsec: "&#x1F512;",
	nsec3: "&#x1F510;",
	clip: "&#x1F4CE;",
	cart: "&#128722;",
	email: "&#128231;",
	copy: "&#x2398",
	credit: "&#x1F4B3;",
	lock: "&#x1F512;",
	unlock: "&#x1F513;",

	gap: "<div style='height: 7px;'></div>",
	settings_spacer: "<tr><td><div style='height: 70px;'></div></td></tr>",

	def_max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="default";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);

let basket = window.localStorage.basket;
if (basket) {
	gbl.basket = JSON.parse(basket);
	}


if (window.location.pathname!="/") {
	window.localStorage.setItem("router_path",window.location.pathname);
	window.location = window.location.origin;
	}


gbl.head = document.head || document.getElementsByTagName('head')[0];

function keyEsc(e) {
    if (e.key == "Escape") {
    	hideAllPopUp();
    	unerrMsg();
		if (elm.search.style.display != "none")
			document.searchForm.searchEdit.focus();
    	}
}



function hideAllPopUp()
{
	hidePopUp();
	["loginPopup","registerPopup","themePopup"].forEach(item => {
		let popup = document.getElementById(item);
		popup.classList.remove("show")
		});
}


function clr_lazy_hide()
{
	if (!ctx.popup) return;
	if (ctx.popup.timer) clearTimeout(ctx.popup.timer);
	delete ctx.popup;
}


function togglePopUp(name,tmout)
{
	if ("popup" in ctx) {
		let save_name = ctx.popup.name;
		hidePopUp();
		if (save_name==name) { unerrMsg(); return; }
		}

	let popup = document.getElementById(name);
	if (popup) popup.classList.toggle("show");

	let hide_now = null;
	if (tmout) {
		hide_now = setTimeout(hidePopUp,tmout);
		}

	ctx.popup = { "timer": hide_now, "name": name }

	let e = null;
	if (name=="loginPopup") e = document.formLogin.email;
	if (name=="registerPopup") e = document.formRegister.email;
	if (name=="AddNSPopup") e = document.getElementById("inputNS");
	if (name=="AddDSPopup") e = document.getElementById("inputDS");
	if (name=="AddRRwin") e = document.getElementById("rr_name");
	if (e) { e.focus(); e.select(); }

	return false;
}



function hidePopUp()
{
	if (!("popup" in ctx)) return;
	let popup = document.getElementById(ctx.popup.name);
	if (popup) popup.classList.remove("show")
	clr_lazy_hide();
}



function do_theme_change(value)
{
	clr_lazy_hide();
	if (value in theme_colours) changeTheme(value);
	let popup = document.getElementById("themePopup");
	popup.classList.remove("show")
	if (elm.search.style.display != "none") document.searchForm.searchEdit.focus();
}


function toggleLogin() { togglePopUp("loginPopup",30000); }
function toggleRegister() { togglePopUp("registerPopup",30000); }
function toggleTheme() { togglePopUp("themePopup",5000); }



function show_one_space(name)
{
	for (let item of ["userSpace","marketPlace","search","basketSpace"]) {
		if (item != name) elm[item].style.display = "none";
		};
	elm[name].style.display = "block";
}

function size_one_space() { setTimeout(do_size_one_space,250); }
function do_size_one_space()
{
	let sz = 0;
	for (let item of ["userSpace","marketPlace","search","basketSpace"])
		if (elm[item].style.display != "none") {
			sz = elm[item].clientHeight+400;
			}

    if (sz < window.innerHeight) sz = window.innerHeight;
    document.body.style.height = sz;
}


function goSearch(with_push)
{
	if (with_push) push_hist("goSearch");
	show_one_space("search");
	document.searchForm.searchEdit.focus();
	size_one_space();
}


function loggedIn()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "none";
	e = document.getElementById("isLoggedIn");
	e.style.display = "block";
	if (elm.userSpace.style.display == "block") goSearch(true);
	user_info();
}


function emptyCart()
{
	delete gbl.basket;
	user_info();
	errMsg(`${gbl.cut} basket emptied`,"errorSpan");
	if (elm.basketSpace.style.display == "block") goSearch(true);
}



function removeBasketItem(i)
{
	if (gbl.basket.length == 1) {
		delete gbl.basket;
		if ((elm.basketSpace.style.display == "block")||(elm.userSpace.style.display == "block"))
			goSearch(true);
		}
	else gbl.basket.splice(i,1);

	if ((ctx.popup)&&(ctx.popup.name)&&(ctx.popup.name=="basketPopup")) {
		if (ctx.popup.timer) clearTimeout(ctx.popup.timer);
		delete ctx.popup.timer;
		}

	user_info()
	if (elm.basketSpace.style.display == "block") basketCheckout(true);
}



function start_basket_table(show_failed)
{
	let x = '<tr><th>Domain</th><th>Action</th><th>Yrs</th><th>Cost</th></tr>';
	for(let i in gbl.basket) {
		let item = gbl.basket[i];
		x += `<tr onClick="removeBasketItem(${i});" title="Remove this item" class=dataRow>`
		x += `<td>${fromPuny(item.domain)}</td><td align=center>${item.action}</td>`;
		x += `<td align=center>${item.num_years}</td><td align=right>${format_amount(item.cost)}</td>`;
		if ((show_failed)&&(item.failed)) {
			x += `<td align=center>${item.failed}</td>`;
			delete item.failed;
			}
		x += "</tr>";
		}
	return x;
}



function user_info()
{
	basket_changed();

	if ((ctx.user)&&(!ctx.user.email_verified)) elm.emailIcon.style.display="block";
	else elm.emailIcon.style.display="none";

	if (ctx.orders&&ctx.orders.length) elm.ordersIcon.style.display="block";
	else elm.ordersIcon.style.display="none";

	if (("user" in ctx)&&("name" in ctx.user)) {
		elm.userInfo.innerHTML = `Logged in as: <b>${ctx.user.name}</b>`;
		}
}



function confirmEmail()
{
	let x = "<h2>Click to send a verification email to your address</h2>";
	x += "<center><input type=button onClick='send_confirm_email();' value='Send EMail' class=myBtn></center>";
	elm.userSpace.innerHTML = x;
	show_one_space("userSpace");
}



function send_confirm_email()
{
	callApi("send/verify",(ok,reply) => {
		if (!ok) return def_errMsg("Failed to send verification email",reply,"errorSpan");
		elm.userSpace.innerHTML = "<h2>"+gbl.tick+"&nbsp;Verification email sent</h2>";
		});
}



function doRegister()
{
	function regErr(err)
	{
		errMsg(err,"registerPopup");
		clr_lazy_hide();
		item.focus();
	}

	let f = document.formRegister;

	if (f.password.value != f.confirm.value) return regErr("Passwords do not match");
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address");

	let data = {
		"name":f.name.value,
		"email":f.email.value,
		"password":f.password.value
		};

	callApi("users/register",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();
		catch_user_data(reply);
		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.searchEdit.focus();

		f.email.value = "";
		f.password.value = "";
		f.confirm.value = "";
		f.name.value = "";

		}, { json: data });
}


function doLogin()
{
	function regErr(err,item)
	{
		errMsg(err,"loginPopup");
		clr_lazy_hide();
		item.focus();
		return false;
	}

	let f = document.formLogin;
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",f.email);

	let data = { "email":f.email.value, "password":f.password.value };

	callApi("users/login",(ret,reply) => {
		if (!ret) {
			let msg="Error logging in";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();
		catch_user_data(reply);
		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.searchEdit.focus();
		if (elm.basketSpace.style.display != "none") basketCheckout(false);

		f.email.value = "";
		f.password.value = "";

		}, { json: data });

	return false;
}



function doLogOut()
{
	ctx = {};
	callApi("users/logout",(ret,reply) => {});
	show_one_space("search");
	document.searchForm.searchEdit.focus();
	loggedOut();
}



function loggedOut()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "block";
	e = document.getElementById("isLoggedIn");
	e.style.display = "none";
	elm.userInfo.innerHTML = "";

	elm.emailIcon.style.display="none";
	elm.ordersIcon.style.display="none";

	goSearch(true);
}



function basket_changed()
{
	if (gbl.basket) {
		elm.basketIcon.style.display = "block";
		let x = '<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>' + start_basket_table(false)
		x += `<tr><td colspan=4>${gbl.gap}</td></tr>`;
		x += "<tr><Td class=btmBtnBar colspan=4 align=center>";
		x += "<button style='width: 110px;' onClick='emptyCart();' class=myBtn>Empty</button>";
		x += "<button style='width: 110px;' onClick='basketCheckout(true);' class=myBtn>Checkout</button></td></tr>";
		x += "</table>";
		elm.basketPopup.innerHTML = x;
        window.localStorage.setItem("basket",JSON.stringify(gbl.basket));
		}
	else {
		elm.basketIcon.style.display = "none";
		window.localStorage.removeItem("basket");
		}
}


function history_back(event)
{
	let router = {
		"resend_password": resend_password,
		"basketCheckout": basketCheckout,
		"payment_methods": payment_methods,
		"domain_dns": go_domain_dns,
		"domain_transfer_options": go_domain_transfer_options,
		"domain_settings": go_domain_settings,
		"show_one_domain": go_show_one_domain,
		"user_statement": go_user_statement,
		"user_settings": user_settings,
		"myAccount": myAccount,
		"myDomains": myDomains,
		"goSearch": goSearch,
		"welcome": go_welcome
		};

	let rest = null;
	let func_name = event.state;
	if (func_name.indexOf("/")>=0) {
		let parts = event.state.split("/");
		func_name = parts[0];
		rest = parts.slice(1);
		}

	if (func_name in router) router[func_name](false,rest);
	return true;
}



function bodyLoaded()
{
	window.addEventListener('popstate',history_back);
	go_welcome(true);
}



function push_hist(data)
{
	window.history.pushState(data,"",policy("website_name"));
}


function go_welcome(with_push)
{
	["myMsgPop","errorSpan","emailIcon","ordersIcon","basketIcon","userInfo","marketPlace","basketSpace","basketPopup",
	"userSpace","output","topSpan","search","businessName"].forEach(i => {
		elm[i] = document.getElementById(i);
		} );

	show_one_space("search");
	let mainDiv = document.getElementById("allBottom");
	mainDiv.onclick = function (e) { if (e.target !== this) return; hidePopUp(); }
	let srchDiv = document.getElementById("search");
	srchDiv.onclick = function (e) { if (e.target !== this) return; hidePopUp(); }

	callApi("config",(ok,reply) => {
		if (!ok) return def_errMsg("Error contacting servers",reply,"searchEdit");
		gbl.config = reply;
		gbl.config.ok_tlds = {};
		gbl.currency = policy("currency",gbl.config.default_currency);
		for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;

		let my_icon = policy("icon",null);
		let site_name = policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			site_name = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		elm.businessName.innerHTML = `<a href="${policy('website_name')}">${site_name}</a>`;

		elm.output.innerHTML = `<div class=userMsg>${policy("user_message","Welcome")}</div>`;
		size_one_space();
		basket_changed();
		document.searchForm.searchEdit.focus();
		if (with_push) push_hist("welcome");

		if (ctx.session) {
			callApi("users/details",(ok,reply) => {
				if (ok) {
					catch_user_data(reply);
					loggedIn();
					}
				check_router_path();
				});
			} else { loggedOut(); check_router_path(); }
		});
}



function router_user_email_verify(params)
{
	callApi("users/verify",(ok,reply) => {
		if (!ok) return def_errMsg("Failed to verify email",reply,"errorSpan");

		elm.userSpace.innerHTML="<h2>Email Address Verified</h2>";
		show_one_space("userSpace");
		elm.emailIcon.style.display="none";

		}, { json: {
			"user_id":parseInt(params[0]),
			"hash":params[1]
			}})
}



function user_err(pfx,msg,reply)
{
	if (reply.error) msg=reply.error;
	elm.userSpace.innerHTML = `<h2>${pfx}: ${msg}</h2>`;
	show_one_space("userSpace");
}


function router_renew_domain(params)
{
	buy_one_name(params[0],"renew",false);
}


function router_reset_password(params)
{
	if (params[0].length!=30) {
		elm.userSpace.innerHTML = "Invalid reset code";
		show_one_space("userSpace");
		return;
		}

	if (ctx.session) {
		elm.userSpace.innerHTML = "<h2>You are already logged in</h2>";
		show_one_space("userSpace");
		return;
		}

	let x = "";
	x += "<form name=resetPass action=# method=post onSubmit='return do_reset_password();'><table width=75% id='reset_table' align=center border=0>";
	x += "<tr><th colspan=2>Reset your password</th></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += `<input type=hidden name=reset_code value='${params[0]}'>`;
	x += '<tr><td class=formPrompt>&nbsp;Reset PIN Number:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 100px;" id="reset_pin">&nbsp;</td></tr>';
	x += '<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input autocomplete="new-password" onkeydown="keyEsc(event);" style="width: 250px;" type=password id="reset_password">&nbsp;</td></tr>';
	x += '<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input autocomplete="new-password" onkeydown="keyEsc(event);" style="width: 250px;" type=password id="reset_confirm">&nbsp;</td></tr>';
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += '<tr><td class=btmBtnBar colspan=2>';
	x += '<span style="width: 75px;" tabindex=0 title="Cancel" class=myBtn onClick="goSearch();">Cancel</span>';
	x += '<input style="width: 110px;" tabindex=0 type=submit title="Reset your password" class=myBtn value="Reset">';
	x += '</td>';
	x += '</tr></form></table>';

	elm.userSpace.innerHTML = x;
	show_one_space("userSpace");
	let e = document.getElementById("reset_pin");
	if (e) e.focus();
}



function do_reset_password()
{
	send_json = {
		"pin": document.resetPass.reset_pin.value,
		"code": document.resetPass.reset_code.value,
		"password": document.resetPass.reset_password.value,
		"confirm": document.resetPass.reset_confirm.value
		};

	if (send_json.code.length != 30) { goSearch(); return false; }
	if (send_json.pin.length != 4) {
		errMsg("Invalid PIN Number");
		document.resetPass.reset_pin.focus();
		document.resetPass.reset_pin.select();
		return false;
		}

	if ((!send_json.password.length)||(!send_json.confirm.length)||(send_json.password != send_json.confirm)) {
		errMsg("Password and confirm do not match or are invalid","reset_table");
		document.resetPass.reset_password.focus();
		document.resetPass.reset_password.select();
		return false;
		}

	callApi("users/reset",(ok,reply) => {
		if (!ok) def_errMsg("Password reset failed",reply,"reset_table");
		else elm.userSpace.innerHTML = "<h2>Your password has been reset</h2>";
		}, { json: send_json });

	return false;
}


function check_router_path()
{
	if (!window.localStorage.router_path) return;

	let router = {
		"verify": router_user_email_verify,
		"pass_reset": router_reset_password,
		"mailpass": resend_password,
		"renew": router_renew_domain
		};

	let router_path = window.localStorage.router_path;
	window.localStorage.removeItem("router_path");

	let path_parts = router_path.split("/").slice(1);
	if (!(path_parts[0] in router)) return;

	let fn_call = router[path_parts[0]];
	fn_call(path_parts.slice(1));
}



function catch_user_data(reply)
{
	["failed_basket","transactions","user","domains","orders"].forEach((item) => {
		if (item in reply) ctx[item] = reply[item];
		})
}



function one_search_line(item,block_not_avail)
{
	if (block_not_avail) {
		if ((!("for_sale_msg" in item))&&(!item.avail)) return "";
		}

	let x = "<tr class=searchDomain>";
	x += `<td><span title="${item.name}">${fromPuny(item.name)}</span>`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${format_amount(item.renew)}</span>`;
	x += "</td>";

	if ("for_sale_msg" in item) x += `<td colspan=2>${item.for_sale_msg}</td>`;
	else if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td style='vertical-align: middle; text-align: right;'>";
			let amt = format_amount(item.create);
			x += btn(`buy_one_name('${item.name}','create',true)`,`<b>BUY ${amt}</b>`,`Buy '${item.name}' for ${amt}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(ret,data)
{
	let is_multi_search = (("search" in ctx)&&("todo" in ctx.search));

	if (!ret) return def_errMsg("Search failed",data,"searchEdit");

	if ((!is_multi_search)&&(data.length==1)&&(data[0].yours)) { myDomains(true); return; }

	for(let item of data) ctx.search.result += one_search_line(item,is_multi_search);
	elm.output.innerHTML = "<table border=0 cellspacing=0 width=100%>" + ctx.search.result + "</table>";
	size_one_space()

	if (is_multi_search) {
		if (ctx.search.todo.length <= 0) delete ctx.search.todo; else searchNext();
		}
	else {
		ctx.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.slice(0,pos),name.slice(pos+1));
		}
}



function buy_one_name(domain,action,show_basket)
{
	let qry = { "domain" : domain, "num_years": 1 }

	if ("basket" in gbl) {
		for(let item of gbl.basket) {
			if ((item.domain==domain)&&(item.action==action))
				qry.num_years = item.num_years + 1;
			}
		}

	callApi("domain/check",(ret,data) => {
		if (!ret) {
			errMsg("Unexpected price error","userInfo");
			return;
			}

		let found_it = false;
		let dom = data.shift();

		if (!(action in dom)) {
			let msg = "an error occured";
			if ((action+":err") in dom) msg = dom[action+":err"];
			errMsg(msg,"basketIcon");
			return;
			}

		let new_item = {
			"domain": dom.name,
			"num_years": dom.num_years,
			"cost": dom[action],
			"action": action
			};

		let max_basket_size = policy("max_basket_size",10);
		if (!("basket" in gbl)) { gbl.basket = [new_item]; }
		else {
			for(let item of gbl.basket) {
				if ((item.domain==dom.name)&&(item.action==action)) {
					item.num_years = dom.num_years
					item.cost = dom[action];
					found_it = true;
					}
				}

			if (!found_it) {
				if (gbl.basket.length >= max_basket_size) {
					errMsg("Basket full, please checkout","basketPopup");
					}
				else gbl.basket.push(new_item);
				}
			}

		basket_changed();
		user_info();
		clr_lazy_hide();

		if ((show_basket)&&(max_basket_size > 1)) {
			elm.basketPopup.classList.add("show");
			ctx.popup = { "timer": setTimeout(hidePopUp,2500), "name": "basketPopup" };
		} else {
			if ((gbl.basket)&&(gbl.basket.length)) basketCheckout();
			}

		}, { json: qry });
}



function searchNext()
{
	let first = ctx.search.todo.shift();
	let srch = [ ctx.search.term + "." + first.name ];

	let max = gbl.def_max_checks;

	if ((first.registry in gbl.config.registry)&&("max_checks" in gbl.config.registry[first.registry]))
		max = gbl.config.registry[first.registry].max_checks;

	while((ctx.search.todo.length > 0)&&(srch.length < max)&&(first.registry == ctx.search.todo[0].registry)) {
		let nxt = ctx.search.todo.shift();
		srch.push(ctx.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}



function multiSearch(srch,not_me_tld)
{
	ctx.search.todo = [];
	ctx.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) ctx.search.todo.push(x);
		}
	searchNext();
}



function doSearch()
{
	function do_end() {
		f.searchEdit.focus();
		f.searchEdit.select();
		return false;
		}

	delete ctx.search;

	elm.output.innerHTML = "";

	ctx.search = {};
	ctx.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

	let f = document.searchForm;
	let srch = toASCII(f.searchEdit.value);

	if (srch.indexOf(".") >= 0) {
		if (!fqdnCheck.test(srch)) {
			errMsg("Invalid domain name","searchEdit");
			return do_end(); }

		if (!supported_tld(srch)) {
			errMsg("Not a supported TLD","searchEdit");
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		errMsg("Invalid domain name","searchEdit");
	else
		multiSearch(srch,null);

	return do_end();
}


function userDomainList()
{
	if (ctx.domains.length <= 0) return "<h2>You have no domains ... yet</h2>";
	let default_dns_servers = policy("dns_servers",null);

	let x = "<table width=75% align=center cellspacing=1 cellpadding=0 border=0>";
	x += "<tr><th colspan=2>Domain Name</th><th>Auto</th><th>Expiry Date</th><th>Name Servers</th></tr>";
	if (ctx.domains.length < 30) cls="dataRowBig"; else cls="dataRow";

	for(let i in ctx.domains) {
		let dom = ctx.domains[i];
		x += `<tr onClick="push_show_one_domain(${i});" class=${cls}>`;
		if (dom.ds) x += "<td title='DNSSEC Secured'>"+gbl.lock+"</td>"; else x += "<td></td>";
		x += `<td title="${dom.name}">${dom.display_name}</td>`;

		let auto_renew = gbl.cross;
		if (dom.auto_renew) auto_renew = gbl.tick;
		x += `<td title="Auto-Renew Status" align=center>${auto_renew}</td>`;
		if (dom.status_id == 1)
			x += `<td align=center>${dom.expiry_dt.split(" ")[0]}</td>`;
		else
			x += `<td align=center>${dom.status_desc}</td>`;

		if (dom.ns == default_dns_servers) x += "<td align=center>DNS hosted here</td>"; else x += `<td>${dom.ns.slice(0,40)}</td>`;

		x += "</tr>";
		}
	return x + "</table>";
}



function preset_domain_extras(dom)
{
	dom.display_name = fromPuny(dom.name);
	dom.status_desc = dom.status_id;
	if (dom.status_id in gbl.config.status)
		dom.status_desc = gbl.config.status[dom.status_id];
}



function load_domains_list(success_fn)
{
	callApi("users/domains",(ret,reply) => {
		if ((ret)&&(reply.domains)) {
			ctx.domains = reply.domains;
			for(let dom of ctx.domains) preset_domain_extras(dom);
			success_fn(true);
			}
		else delete ctx.domains;
		});
}



function show_domains_list()
{
	elm.userSpace.innerHTML = userDomainList()
    size_one_space()
}



function myDomains(with_push)
{
	if (with_push) push_hist("myDomains");
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";
	load_domains_list(show_domains_list)
	return false;
}



function postUserDetails()
{
	let f = document.editUserDetails;
	function regErr(err,item) { errMsg(err,"editUserDetails"); item.focus(); return false; }

	let data = {
		"name": f.user_name.value,
		"email": f.user_email.value,
		"default_auto_renew": parseInt(f.elements["default_auto_renew"].value)
		};

	if (!valid_email.test(data.email)) return regErr("Invalid email address",f.user_email);

	callApi("users/update",(ret,reply) => {
		if (ret) {
			if ("user" in reply) {
				ctx.user = reply.user;
				user_info();
				elm.userSpace.innerHTML = userDetails();
				size_one_space();
				}
			}
		else def_errMsg("Failed",reply,"editUserDetails");
		}, { json: data });

	return false;
}


function postUserPassword()
{
	let f = document.editUserPassword;
	function regErr(err,item) { errMsg(err,"editUserPassword"); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);
	if (f.new_password.value=="") return regErr("New password missing",f.new_password);
	if (f.confirm_password.value=="") return regErr("Confirm password missing",f.confirm_password);

	if (f.new_password.value != f.confirm_password.value)
		return regErr("Passwords do not match",f.new_password);

	let data = {
		"password": f.password.value,
		"new_password": f.new_password.value,
		};

	callApi("users/password",(ret,reply) => {
		if (ret) {
			errMsg("Password changed","userInfo");
			user_info();
			elm.userSpace.innerHTML = userDetails();
			size_one_space();
			}
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			return regErr(msg);
			}
		}, { json: data });

	return false;
}


function postCloseAccount()
{
	let f = document.editCloseAccount;
	function regErr(err,item) { errMsg(err,"editCloseAccount"); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);

	callApi("users/close",(ret,reply) => {
		if (ret) goSearch(true);
		else def_errMsg("failed",reply,"editCloseAccount");
		}, { json: { "password": f.password.value }});

	return false;
}



function goMarketPlace()
{
	errMsg("Not yet implemented","marketPlaceBtn");
}



function enable_two_fa()
{
	errMsg("Not yet implemented","edit2FA");
}


function settings_header(title,spacer)
{
	let x = "";
	if (!spacer) x = gbl.settings_spacer;
	x += `<tr><td class=settingsBanner>${title}</td></tr><tr><td>`;
	return x;
}
function settings_prompt(txt) { return `<tr><td class=formPrompt>${txt} :</td><td>`; }



function user_settings(with_push)
{
	if (with_push) push_hist("user_settings");
	let x="<table align=center border=0>";
	x += settings_header("Change User Details",true);
	x += "<form name=editUserDetails method=post action=# onSubmit='postUserDetails(); return false;'>";
	x += "<table id=editUserDetails width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += settings_prompt("E-Mail")+`<input style="width: 300px;" id='user_email' value='${ctx.user.email}'></td></tr>`;
	x += settings_prompt("Name")+`<input style="width: 300px;" id='user_name' value='${ctx.user.name}'></td></tr>`;
    x += settings_prompt("Default Auto Renew")+`<select id='default_auto_renew'>`;

    let yes_chk="",no_chk="";
    if (ctx.user.default_auto_renew) yes_chk="selected"; else no_chk="selected";
    x += `<option ${yes_chk} value=1>Yes<option ${no_chk} value=0>No</select></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += settings_header("Control Two-Factor Authentication");
	x += "<table id=edit2FA width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	if (("two_fa" in ctx.user) && (ctx.user.two_fa != null) && (ctx.user.two_fa != "")) {
		x += "<tr><td colspan=2>Disable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Disable 2FA","Disable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	else {
		x += "<tr><td colspan=2>Enable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Enable 2FA","Enable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	x += "</table></form></td></tr>";


	x += settings_header("Change Your Password");
	x += "<form name=editUserPassword method=post action=# onSubmit='postUserPassword(); return false;'>";
	x += "<table id=editUserPassword width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += settings_prompt("Current Password");
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += settings_prompt("New Password");
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Your new password" type=password id='new_password'></td></tr>`;
	x += settings_prompt("Confirm Password");
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Confirm your new password" type=password id='confirm_password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += settings_header("Close This Account");
	x += "<form name=editCloseAccount method=post action=# onSubmit='postCloseAccount(); return false;'>";
	x += "<table id=editCloseAccount width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += "<tr><td colspan=2>To close your account, please enter your current password</td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += settings_prompt("Current Password");
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Close Account'></td></tr>";
	x += "</table></form></td></tr>";

	elm.userSpace.innerHTML = x+"</table>";
	size_one_space();

	document.editUserDetails.user_email.focus();
}


function go_user_statement() { return user_statement(false,true); }


function user_statement(with_push,from_start)
{
	if (with_push) push_hist("user_statement");
	let num = policy("trans_per_page",25);
	let limit = null;

	if (from_start) delete ctx.transactions;
	else {
		if (ctx.transactions)
			limit = { "limit":num,"skip":ctx.transactions.length };
		}

	callApi("users/transactions",(ok,reply) => {
		if (!ok) return def_errMsg("Error submitting basket",reply,"userBtnBar")

		if (!reply.transactions) return errMsg("No transactions found","userBtnBar")

		if (!ctx.transactions) catch_user_data(reply);
		else {
			if (reply.transactions) ctx.transactions.push(...reply.transactions);
			}

		show_transactions(reply.transactions.length==num);
		}, { json: limit});
}



function show_transactions(with_more)
{
	let x = "<table align=center width=100% border=0>";
	x += "<tr>";
	["When","Description","Credit","Debit","Balance"].forEach((item) => { x += `<th>${item}</th>`; })
	x += "</tr>";
	for(let trans of ctx.transactions) {
		x += `<tr><Td align=center>${trans.created_dt.slice(0,16)}</td>`;
		x += `<td>${trans.description}</td>`;
		if (trans.amount > 0)
			x += `<td align=right>${format_amount(trans.amount)}</td><td></td>`;
		else
			x += `<td></td><td align=right>${format_amount(-1*trans.amount)}</td>`;
		x += `<td align=right>${format_amount(trans.post_balance)}</td>`;
		}
	if (with_more) {
		x += "<tr><td>"+gbl.gap+"</td></tr>";
		x += "<tr><td colspan=2><td id=moreTransBtn class=btmBtnBar align=right colspan=3>";
		x += btn("user_statement(true,false)","More >>>","Load more transations");
		x += "</td></tr>";
		}
	elm.userSpace.innerHTML = x+"</table>";

    size_one_space()
}



function click_add_payment()
{
	let data = {}
	for(let i of ["provider","provider_tag","single_use","can_pull"]) {
		let e = document.getElementById("pay."+i);
		if (!e) {
			errMsg("Failure in payment plugin, see console","add_pay_div");
			console.log(`ERROR: Field 'pay.${i}' is missing from the plug-in HTML`);
			return; }

		data[i] = e.value;
		}

	callApi("payments/store",(ok,reply) => {
		if (ok) return payment_methods(true);
		def_errMsg("Error adding this payment",reply,"add_pay_div");
		}, { json: data })
}



function add_payment()
{
	hidePopUp();

	let e = document.getElementById("add_payment_type");
	if (!e) return;

	callApi("payments/html",(ok,reply) => {
		let p = document.getElementById("add_pay_div");
		if ((ok)&&(p)) {
			let x="<table align=center border=0>";
			x += settings_header(`Add Payment Method - ${gbl.config.payments[e.value]}`)+"<tr><td>"+reply+"</td></tr></table>";
			p.innerHTML = x;
			let f = document.getElementById("pay.provider_tag");
			if (f) f.focus();
			return;
			}
		def_errMsg("Error getting HTML for payment",reply,"add_pay_div");
		},{ json: {"method":e.value}});
}



function add_payment_form()
{
	let x = "<table>";
	x += "<tr><td class=fpormPromt>Select method to add:</td>";
	x += "<td><select id=add_payment_type>"
	for(let i in gbl.config.payments) {
		x += `<option value='${i}'>${gbl.config.payments[i]}`;
		}
	x += "</select></td></tr>";
	x += "<tr><td colspan=2 class=btmBtnBar>"+btn("add_payment()","Add","Add payment method",75)+"</td></tr>";
	return x +"</table>";
}



function remove_payment(provider,provider_tag)
{
	callApi("payments/delete",(ok,reply) => {
		if (!ok) return def_errMsg("Delete payment method failed",reply,"add_pay_div");
		payment_methods(true);
		}, { json: { "provider":provider, "provider_tag":provider_tag }});
}



function payment_methods(with_push)
{
	if (with_push) push_hist("payment_methods");
	callApi("payments/list",(ok,reply) => {
		let x="<table width=75% align=center cellspacing=1 cellpadding=0 border=0>";
		x += "<tr><td class=btmBtnBar>";
		x += generic_popup_btn({
			"name": "AddPayment",
			"label": "Add Payment",
			"width": 100,
			"timeout": null,
			"title": "Add a payment method",
			"internal": add_payment_form,
			"style": "overflow: auto; margin-left: -250;"
			});
		x += "</td></tr></table>";
		x += "<div id='add_pay_div'>"+gbl.gap;
		if (reply.length>0) {
			x += "<table width=75% align=center cellspacing=1 cellpadding=0 border=0>";
			x += "<tr><th>Payment Method</th><th>Payment Data</th></tr>"
			for(let i of reply) {
				x += `<tr onClick='remove_payment("${i.provider}","${i.provider_tag}");' class=dataRow title="Click to remove this payment method"><td>${gbl.config.payments[i.provider]}</td>`;
				x += `<td>${i.provider_tag}</td></tr>`;
				}
			x += "</table>";
			}
		else x += "<h2>No payment methods set up yet</h2>";
		x += "</div>";
	    elm.userSpace.innerHTML = x;
		size_one_space();
		});
}


function userDetails()
{
	let auto_renew = gbl.cross;
	let verified = gbl.cross;
	let has_twofa = gbl.cross;
	if (ctx.user.default_auto_renew) auto_renew = gbl.tick;
	if (ctx.user.email_verified) verified = gbl.tick;
	if (ctx.user.two_fa) has_twofa = gbl.tick;

	let x = "<table align=center width=75% border=0>";
	x += "<tr><td id=userBtnBar class=btmBtnBar>";

	if (!ctx.user.email_verified) 
		x += btn("send_confirm_email()","Resend Verify","Resend e-mail verification",100);

	x += btn("user_statement(true,true)","Statement","View a statement of all your transactions",100)
	x += btn("payment_methods(true)","Payment","View / maintain your payment methods",100)
	x += btn("user_settings(true)","Settings","Change this accounts settings",100)
	x += "</td></tr>";

	x += "<tr><td>"+gbl.gap+"</td></tr><tr><td><table width=100%>";
	x += `<tr><td class=promptCell>E-Mail :</td><td class=dataCell>${ctx.user.email}</td></tr>`;
	x += `<tr><td class=promptCell>E-Mail Verified :</td><td class=dataCell>${verified}</td></tr>`;
	x += `<tr><td class=promptCell>Name :</td><td class=dataCell>${ctx.user.name}</td></tr>`;
	x += `<tr><td class=promptCell>Last Login :</td><td class=dataCell>${ctx.user.last_login_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${ctx.user.amended_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Created :</td><td class=dataCell>${ctx.user.created_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Defaut Auto-Renew :</td><td class=dataCell>${auto_renew}</td></tr>`;

	let show_bal = format_amount(ctx.user.acct_current_balance);
	if (ctx.user.acct_on_hold) show_bal = "Account on hold";
	x += `<tr><td class=promptCell>Account Balance :</td><td class=dataCell>${show_bal}</td></tr>`;
	x += "</td></tr></table>";

	if ((ctx.orders)&&(ctx.orders.length > 0)) x += order_details(false);

	return x + "</table>"
}


function cancel_order(order_item_id)
{
	callApi("orders/cancel",(ok,reply) => {
		if (!ok) return def_errMsg("Error cancelling order",reply,`orderRow${order_item_id}`)
		myAccount(true);
		},{json:{"order_item_id":order_item_id}});
}



function order_details(as_first)
{
	let x = settings_header("Pending Orders",as_first);
	x += "<table width=100%>";
	x += "<tr><th colspan=2>Domain</th><th>When</th><th>Type</th><th>Yrs</th><th>Amount</th></tr>";
	let total = 0;
	for(let order of ctx.orders) {
		total += order.price_paid;
		let dom = domain_of(order.domain_id);
		x += `<tr id=orderRow${order.order_item_id} onClick="cancel_order(${order.order_item_id});" title='Click to cancel this order' class=dataRow>`;
		x += "<td align=center>"+gbl.cut+"</td>";
		x += `<td align=center>${dom.display_name}</td>`
		x += `<td align=center>${order.created_dt}</td>`
		x += `<td align=center>${order.order_type}</td>`
		x += `<td align=center>${order.num_years}</td>`
		x += `<td align=right>${format_amount(order.price_paid)}</td>`
		x += "</tr>";
		}

	x += `<tr><td colspan=6><div class="line"/></td></tr>`;
	x += `<tr><td colspan=5 class=promptCell>Order Total :</td><td align=right>${format_amount(total)}</td></tr>`;
	x += `<tr><td colspan=5 class=promptCell>Account Balance :</td><td align=right>${format_amount(ctx.user.acct_current_balance)}</td></tr>`;
	if (total > ctx.user.acct_current_balance)
		x += `<tr><td colspan=5 class=promptCell>Amount to Pay :</td><td align=right>${format_amount(total-ctx.user.acct_current_balance)}</td></tr>`;
	x += `<tr><td colspan=6><div class="line"/></td></tr>`;

	return x+"</table></td></tr>";
}



function domain_of(domain_id)
{
	if (!ctx.domains) return {"name":"Unk1"};
	for(let dom of ctx.domains)
		if (dom.domain_id == domain_id) return dom;
	return {"name":"Unk2"};
}


function check_login_for_order()
{
	function complete_place_order(reply)
	{
		catch_user_data(reply);
		loggedIn();
		elm.basketSpace.innerHTML = html_for_basket(true)
		place_order()
	}

	if (!gbl.basket) return errMsg("Basket is empty","placeOrderBtn");

	let login = {};

	for(let i of ["email","password","confirm"]) {
		let e = document.getElementById("reg_pay_"+i);
		if (!e) return errMsg("Error: login field ${i} missing","placeOrderBtn");
		login[i] = e.value;
		}

	callApi("users/login",(ret,reply) => {
			if (ret) return complete_place_order(reply);

			if ((!login.password.length)||(!login.confirm.length)||(login.password!=login.confirm))
				return errMsg("Password / Confirm missing or do not match","placeOrderBtn")

			callApi("users/register",(ret,reply) => {
				if (ret) return complete_place_order(reply);
				def_errMsg("Error in registration",reply,"placeOrderBtn");
				}, { json: login });
		}, { json: login });
}



function place_order()
{
	if (!gbl.basket) return errMsg("Basket is empty","placeOrderBtn");

	callApi("basket/submit",(ok,reply) => {
		if (!ok) return def_errMsg("Error submitting basket",reply,"placeOrderBtn")
		catch_user_data(reply);
		show_one_space("userSpace");
		delete gbl.basket;

		if ((ctx.failed_basket)&&(ctx.failed_basket.length >= 1)) {
			gbl.basket = ctx.failed_basket;
			delete ctx.failed_basket
			}

		user_info();
		let fn = show_new_orders
		if ((ctx.orders.length==0)&&(!gbl.basket)) {
			delete ctx.orders;
			fn = show_all_orders_processed;
			}
		load_domains_list(fn);
		}, { json: gbl.basket });
}



function show_all_orders_processed()
{
	let x = "<table align=center width=50% border=0><tr><td>"
	x += "<h2>All orders processed</h2></td></tr></table>";
	elm.userSpace.innerHTML = x;
	size_one_space();
}



function show_new_orders()
{
	let x = "<table align=center width=75% border=0>";
	x += order_details(true);

	if (gbl.basket) {
		x += settings_header("Items that failed")
		x += html_for_basket(false)
		x += "</td></tr>";
		}
	x += "</table>";
	elm.userSpace.innerHTML = x;
	size_one_space();
}



function basketCheckout(with_push)
{
	if (with_push) push_hist("basketCheckout");
	hidePopUp();
	show_one_space("basketSpace");
	elm.basketSpace.innerHTML = html_for_basket(true)
	size_one_space();
}



function html_for_basket(with_place_order)
{
	if (with_place_order) width="75%"; else width="100%";
	let x = `<table align=center width=${width} border=0 cellspacing=2 cellpadding=5>`;
	let fn = "place_order()";

	if ((with_place_order)&&(!ctx.session)) {
		x += "<tr><td colspan=4>";
		x += "<table width=100%>";
		x += "<colgroup><col width=30%/><col width=70%/></colgroup>";
		x += "<tr><Td colspan=2><div style='height: 15px;'></div></td></tr>";
		x += "<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input style='width: 250px;' id='reg_pay_email'>&nbsp;</td></tr>";
		x += "<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input style='width: 250px;' type=password id='reg_pay_password'>&nbsp;</td></tr>";
		x += "<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input style='width: 250px;' type=password id='reg_pay_confirm'>&nbsp;</td></tr>";
		x += "<tr><td colspan=2><div style='height: 7px;'></div></td></tr>";
		x += "</table></td></tr>";
		fn = "check_login_for_order()";
	}

	x += start_basket_table(!with_place_order);
	let total = 0;
	for(let i of gbl.basket) total += i.cost;

	x += `<tr><td colspan=4><div class="line"/></td></tr>`;
	x += `<tr><td colspan=3 class=promptCell>Order Total :</td><td align=right>${format_amount(total)}</td></tr>`;

	if (with_place_order) {
		let btn_txt = "Place Order >>>";
		if (ctx.user) {
			x += `<tr><td colspan=3 class=promptCell>Account Balance :</td><td align=right>${format_amount(ctx.user.acct_current_balance)}</td></tr>`;
			if (total > ctx.user.acct_current_balance) {
				x += `<tr><td colspan=3 class=promptCell>Amount to Pay :</td><td align=right>${format_amount(total-ctx.user.acct_current_balance)}</td></tr>`;
				btn_txt = "Place Order & Pay >>>";
				}
			}
		x += `<tr><td colspan=4><div class="line"/></td></tr>`;
		x += "<tr><td id=placeOrderBtn colspan=4 align=right>"+btn(fn,btn_txt,"Please this order & pay for it, if necessary")+"</td></tr>";
		}
	else
		x += `<tr><td colspan=4><div class="line"/></td></tr>`;

	return x+"</table>"
}



function myAccount(with_push)
{
	if (with_push) push_hist("myAccount");
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";
	size_one_space();
	callApi("users/details",(ok,reply) => {
		if (!ok) {
			goSearch(true);
			return def_errMsg("Error in setting your data",reply,"searchEdit");
			}
		catch_user_data(reply);
		user_info();
		elm.userSpace.innerHTML = userDetails();
		size_one_space();
		});
}


function NSkeyDown(event,idx) {
	if (event.key=="Escape") return hidePopUp();
	if (event.key=="Enter") return doAddNS(idx);
	}
function DSkeyDown(event,idx) {
	if (event.key=="Escape") return hidePopUp();
	if (event.key=="Enter") return doAddDS(idx);
	}

function doAddNS(idx)
{
	let e = document.getElementById("inputNS");
	if (!fqdnCheck.test(e.value)) {
		errMsg("Invalid host name","AddNSPopup");
		e.focus(); return; }

	hidePopUp();

	let dom = ctx.domains[idx];

	let ns = "";
	if (dom.ns) ns = dom.ns.split(",");
	if (!ns.find(data => { return (data == e.value); })) {
		if (dom.ns=="") dom.ns = e.value;
		else dom.ns += ","+e.value;
		dom.unsaved = true;
		push_domain_settings(idx);
		}
	else {
		errMsg("Name server already present","AddNSPopup");
		e.focus(); return; }
}


function validate_ds_rec(ds_rec)
{
	return true;
}



function doAddDS(idx)
{
	let e = document.getElementById("inputDS");
	if (!validate_ds_rec(e.value)) {
		errMsg("Invalid DS Record","AddDSPopup");
		e.focus(); return; }

	hidePopUp();

	let dom = ctx.domains[idx];
	let ds = []
	if (dom.ds) ds = dom.ds.split(",");
	if (!ds.find(data => { return (data == e.value); })) {
		if (!dom.ds) dom.ds = e.value;
		else dom.ds += ","+e.value;
		dom.unsaved = true;
		push_domain_settings(idx);
		}
	else {
		errMsg("DS already present","AddDSPopup");
		e.focus(); return; }
}



function do_change_ns(dest_dom,src_dom)
{
	let default_dns_servers = policy("dns_servers",null);
	let dom = ctx.domains[dest_dom];

	if ((src_dom >= 0)&&(src_dom < ctx.domains.length)
		&&(dom.ns != ctx.domains[src_dom].ns))
		{
		dom.ns = ctx.domains[src_dom].ns;
		dom.unsaved = true;
		}
	else if ((src_dom==-1)&&(default_dns_servers)
		&&(dom.ns!=default_dns_servers))
		{
		dom.ns = default_dns_servers;
		dom.unsaved = true;
		}

	hidePopUp();
	push_domain_settings(dest_dom);
}


function generic_popup_btn(config)
{
	/* config: width, style, title, name, label, internal(), param */
	let style_width="",pop_style="";
	if ("width" in config) style_width = `style='width: ${config["width"]}px;'`;
	if ("style" in config) pop_style = `style='${config["style"]}'`;

	let timeout = 30000;
	if ("timeout" in config) timeout = config.timeout;

	let x = `<div class="popup">`;
	x += `<span ${style_width}75px;' tabindex=0 title="${config["title"]}" `;
	x += `class=myBtn onClick="togglePopUp('${config["name"]}',${timeout});">${config["label"]}</span>`;
	x += `<span class="popuptext" ${pop_style} id="${config["name"]}">`;
	x += config["internal"](config["param"]);
	return x + `</span></div>`;
}



function copy_btn_internal(param)
{
	let default_dns_servers = policy("dns_servers",null);
	let seen_ns = { };
	if (default_dns_servers) seen_ns[default_dns_servers] = true;
	let idx=param["idx"];
	seen_ns[ctx.domains[idx].ns] = true;

	let x = '<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>';
	x += `<tr class=dataRow onClick='do_change_ns(${idx},-1);'><td>Our NS</td></tr>`;

	for(let dom_loop in ctx.domains) {
		let dom = ctx.domains[dom_loop];
		if (!seen_ns[dom.ns]) {
			x += `<tr class=dataRow onClick='do_change_ns(${idx},${dom_loop});'><td>Copy ${dom.display_name}</td></tr>`;
			seen_ns[dom.ns] = true;
			}
		}

	return x + "</table>";
}



function add_copy_btn(idx)
{
	return generic_popup_btn({
		"name": "CopyNSPopup",
		"label": "Copy NS",
		"width": 75,
		"style": "overflow: auto; max-height: 250px; margin-left: -120;",
		"title": "Copy the NS records from elsewhere",
		"internal": copy_btn_internal,
		"param": {"idx":idx}
		});
}



function inside_ns(param)
{
	let idx = param["idx"];
	let x = "<table>" + settings_prompt(`Enter NS`);
	x += `<input id=inputNS onkeydown="NSkeyDown(event,${idx});" size=40></td>`;
	x += `<td><input type=button style='width: 110px;' onClick="doAddNS(${idx});" class=myBtn value="Add"></td>`;
	return x+"</tr></table>";
}

function inside_ds(param)
{
	let idx = param["idx"];
	let x = "<table>" + settings_prompt(`Enter DS`);
	x += `<input id=inputDS onkeydown="DSkeyDown(event,${idx});" size=40></td>`;
	x += `<td><input type=button style='width: 110px;' onClick="doAddDS(${idx});" class=myBtn value="Add"></td>`;
	return x+"</tr></table>";
}


function add_rec_type_btn(rec_type,idx,inside_func)
{
	return generic_popup_btn({
		"name": `Add${rec_type}Popup`,
		"label": `Add ${rec_type}`,
		"width": 75,
		"title": `Add a ${rec_type} record`,
		"internal": inside_func,
		"param": {"idx":idx}
		});
}



function saveDomDetails(idx)
{
	let dom = ctx.domains[idx];
	callApi("domain/update",(ok,reply) => {
		if (!ok) return def_errMsg("Domain save failed",reply,"saveButton");
		delete dom.unsaved;
		myDomains(true);
		}, { json: dom });
}



function removeNS(idx,ns_name)
{
	let dom = ctx.domains[idx];
	let ns = dom.ns.split(",");

	function find_ns() {
		for(let i in ns) {
			if (ns[i]==ns_name) return i;
			}
		return null;
		}
	let pos = find_ns()
	if (!pos) {
		errMsg("Name server not found","AddNSPopup");
		return; }
	ns.splice(pos,1);
	dom.ns = ns.join(",");
	dom.unsaved = true;
	push_domain_settings(idx);
}



function removeDS(idx,ds_data)
{
	let dom = ctx.domains[idx];
	let ns = dom.ds.split(",");

	function find_ds() {
		for(let i in ds) {
			if (ds[i]==ds_data) return i;
			}
		return null;
		}
	let pos = find_ds()
	if (!pos) {
		errMsg("DS Record not found","AddDSPopup");
		return; }
	ds.splice(pos,1);
	dom.ds = ds.join(",");
	dom.unsaved = true;
	push_domain_settings(idx);
}



function push_domain_transfer_options(idx) { push_hist(`domain_transfer_options/${idx}`); return domain_transfer_options(idx); }
function go_domain_transfer_options(with_push,rest) { domain_transfer_options(parseInt(rest[0])); }

function domain_transfer_options(idx)
{
	let dom = ctx.domains[idx];

	let x="<table width=75% align=center border=0>";
	x += `<tr><td title="${dom.name}" class=pageHeading>Domain Transfer Options For - ${dom.display_name}</td></tr>`;
	x += "<tr><td><div style='height: 50px;'></div></td></tr>";

	x += settings_header(`Get AuthCode`,true);
	x += "<table width=100% border=0><colgroup><col width=100%/><col/></colgroup>";
	x += "<tr><td>Click to get the transfer AuthCode for this domain</td></tr>";
	x += "<tr><Td><div id='showAuthCode'></div></td>";
	x += "<td align=right>"+btn(`getAuthCode(${idx})`,"Get AuthCode","Get the transfer AuthCode for this domain",110)+"</td>";
	x += "</tr></table>";
	x += "</td></tr>";

	x += settings_header("Push / Gift Domain");
	x += "<table width=100% border=0><colgroup><col width=100%/><col/></colgroup>";
	x += "<tr><td>Push or Gift this domain to another user at this registrar.<p>"
	x += "To transfer the domain to a user in a different registrar,<br>you need to give them the AuthCode "
	x += "and they need<br>to request the transfer from their registrar.</td></tr>";
	x += "<tr><td>Destination E-Mail : <input id='giftDomainDest' style='width: 300px;'></td>";
	x += "<td align=right>"+btn(`giftDomain(${idx})`,"Send Domain","Send this domain to another user",110)+"</td>";
	x += "</tr></table>";
	x += "</td></tr>";
	elm.userSpace.innerHTML = x+gbl.settings_spacer+"</table>";
	size_one_space();
}


function domAutoRenew(idx)
{
	let dom = ctx.domains[idx];
	let e = document.getElementById("dom_auto_renew");
	if (e) {
		dom.auto_renew = (e.value==1);
		dom.unsaved = true;
		push_domain_settings(idx);
		}
}


function push_domain_settings(idx) { push_hist(`domain_settings/${idx}`); return domain_settings(idx); }
function go_domain_settings(with_push,rest) { domain_settings(parseInt(rest[0])); }


function domain_settings(idx)
{
	let dom = ctx.domains[idx];
	let have_locks = {};
	if (dom.client_locks) { for(let i of dom.client_locks.split(",")) have_locks[i] = true }

	let x="<table width=75% align=center border=0>";
	x += `<tr><td title="${dom.name}" class=pageHeading>Domain Settings For - ${dom.display_name}</td></tr>`;
	x += "<tr><td><div style='height: 50px;'></div></td></tr>";
	x += settings_header(`Change Parent Zone Records`,true);
	x += "<table border=0 width=100%><colgroup><col width=30%/><col width=70%/></colgroup>";

    x += `<tr><td class=promptCell>Auto Renew :</td><td><select onChange='domAutoRenew(${idx});' id=dom_auto_renew>`;
    let yes_chk="",no_chk="";
    if (dom.auto_renew) yes_chk="selected"; else no_chk="selected";
    x += `<option ${yes_chk} value=1>Yes<option ${no_chk} value=0>No</select></td></tr>`;

	if (dom.ns) {
		x += "<tr><td class=promptCell>Name Servers : </td><td>";
		ns = dom.ns.split(",").sort();
		for(let i in ns) {
			if (!have_locks.UpdateProhibited)
				x += `<a title="Remove this NS" onClick="removeNS(${idx},'${ns[i]}');" href=#>&nbsp;${gbl.cut}&nbsp;</a>`;
			x += `${ns[i]}<br>`;
			}
		x += "</td></tr>";
		}

	if (dom.ds) {
		x += "<tr><td class=promptCell>DS Records : </td><td>";
		ds = dom.ds.split(",").sort();
		for(let i in ds) {
			if (!have_locks.UpdateProhibited)
				x += `<a title="Remove this DS" onClick="removeDS(${idx},'${ds[i]}');" href=#>&nbsp;${gbl.cut}&nbsp;</a>`;
			x += `${ds[i]}<br>`;
			}
		x += "</td></tr>";
		}
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";

	if (!have_locks.UpdateProhibited) {
		x += "<tr><td colspan=2>";
		x +=    "<table width=100%>";
		x +=    "<tr><td align=left>";
		x +=    add_copy_btn(idx);
		x +=    add_rec_type_btn("NS",idx,inside_ns);
		x +=    add_rec_type_btn("DS",idx,inside_ds);
		x +=    "</td><td align=right>"

		if ("unsaved" in dom)
			x += `&nbsp;<input style='width: 110px;' onClick='saveDomDetails(${idx});' id="saveButton" type=button class=myBtn value='Save'>`;

		x +=    "</td></tr></table>";
		}

	x += "</td></tr></table>";
	x += "</td></tr>";

	if ((dom.registry in gbl.config.registry)&&(gbl.config.registry[dom.registry].locks)) {
		let dom_reg = gbl.config.registry[dom.registry];
		x += settings_header(`Domain Lock Flags`,false);
		x += "<table id='flagsTable' border=0 width=100%><colgroup><col width=40%/><col width=60%/></colgroup>";
		for(let i of dom_reg.locks) {
			img = gbl.tick, flip_to = "Blocked";
			if (have_locks[i]) { img = gbl.cross; flip_to = "Allowed"; }
			x += `<tr><td style="padding-top: 5px;" class=promptCell>Can ${i.slice(0,-10)} : </td><td>${img}&nbsp;`
			if ((!have_locks.UpdateProhibited)||(i=="UpdateProhibited"))
				x += btn(`flip_flag(${idx},'${i}',${(!(have_locks[i]))})`,"Change to "+flip_to,"Set this flag to "+flip_to,150);
			x += "</td></tr>";
			}
		x += "</table></td></tr>";
		}

	elm.userSpace.innerHTML = x+gbl.settings_spacer+"</table>";
	size_one_space();
}


function flip_flag(idx,flag_name,switch_to)
{
	let dom = ctx.domains[idx];
	callApi("domain/flags",(ok,reply) => {
		if (!ok) return def_errMsg("Change domain flag failed",reply,"flagsTable");
		if ("client_locks" in reply) dom.client_locks = reply.client_locks;
		domain_settings(idx);
		},{json:{"domain_id":dom.domain_id,"name":dom.name,"flag":flag_name,"state":switch_to}});
}


function giftDomain(idx)
{
	let e = document.getElementById("giftDomainDest");
	let dom = ctx.domains[idx];

	if (!valid_email.test(e.value)) {
		errMsg("Invalid email address","giftDomainDest");
		e.focus();
		return;
		}

	dom["dest_email"] = e.value;
	callApi("domain/gift",(ok, reply) => {
		if (ok) {
			errMsg(gbl.tick+" Domain gifted","userInfo");
			myDomains(true);
			}
		else {
			def_errMsg("Domain gifting failed",reply,"giftDomainDest");
			e.focus();
			}
		}, { json: dom });
}



function hideAuthCode()
{
	let e = document.getElementById("showAuthCode");
	if (e) e.innerHTML = "";
}


function copyToClip(data)
{
	let ac = document.getElementById("editAuthCode");
	navigator.clipboard.writeText(data).then(
		() => {
			errMsg("AuthCode copied to clipboard","editAuthCode")
			let e = document.getElementById("showAuthCode");
			if (e) e.innerHTML = "";
			},
		() => errMsg("Copy to clipboard failed","editAuthCode")
		);

	return false;
}


function getAuthCode(idx)
{
	let dom = ctx.domains[idx];
	let e = document.getElementById("showAuthCode");

	function show_auth_code(code) {
		dom.authcode = code;
		let x = `<input id="editAuthCode" style="width: 250px;" value="${code}">`;
		x += `<a href=# onClick="copyToClip('${code}');">&nbsp;${gbl.copy}</a>`;

		e.innerHTML = x;
		setTimeout(hideAuthCode,10000);
		let ac = document.getElementById("editAuthCode");
		if (ac) { ac.focus(); ac.select(); }
		}

	if ((e)&&(e.innerHTML!="")) { e.innerHTML = ""; return; }
	if (dom.authcode) return show_auth_code(dom.authcode);

	callApi("domain/authcode",(ok, reply) => {
		if ((ok)&&("auth_code" in reply)) {
			show_auth_code(reply["auth_code"]);
			}
		else def_errMsg("Get AuthCode failed",reply,"showAuthCode");
		}, { json: dom });
}


function tick_cross(value)
{
	return (value)?gbl.tick:gbl.cross;
}



function push_domain_dns(idx) { push_hist(`domain_dns/${idx}`); return domain_dns(idx); }
function go_domain_dns(with_push,rest) { domain_dns(parseInt(rest[0])); }

function domain_dns(idx)
{
	let dom = ctx.domains[idx];

	callApi("dns/load",(ok,reply)=>{
		if (!ok) return def_errMsg("DNS Data failed to load",reply,"dnsBtnBar")

		if ((!reply)||(!reply.dns)||(!reply.dns.rrsets)||(!reply.dns.rrsets.length))
			return errMsg("Failed to read DNS Data","domainBtnBar");

		reply.dns.rrsets.sort((a,b) => {
			if ((a.name == reply.dns.name)&&(b.name == reply.dns.name)) {
				for(tag of ["SOA","NS","MX"]) {
					if (a.type == tag) return -1;
					if (b.type == tag) return 1;
					}
				}
			else {
				if (a.name == reply.dns.name) return -1;
				if (b.name == reply.dns.name) return 1;
				if (a.name < b.name) return -1;
				if (a.name > b.name) return 1;
				}
			if (a.type < b.type) return -1;
			if (a.type > b.type) return 1;
			return 0;
			})

		if (reply.domain) {
			preset_domain_extras(reply.domain);
			ctx.domains[idx] = reply.domain;
			}

		ctx.dns = reply.dns;
		show_dns_data(idx);

		},{ json: { "name":dom.name }})
}



function sign_zone(idx)
{
	let dom = ctx.domains[idx];

	callApi("dns/sign",(ok,reply)=>{
		if (!ok) return def_errMsg("Domain failed to sign",reply,"dnsBtnBar")

		if (reply.domain) {
			preset_domain_extras(reply.domain);
			ctx.domains[idx] = reply.domain;
			}
		if (reply.dns) ctx.dns = reply.dns;
		
		show_dns_data(idx);
		},{ json: { "name": dom.name }})
}



function drop_zone(idx)
{
	let dom = ctx.domains[idx];

	hideAllPopUp();

	callApi("dns/drop",(ok,reply)=>{
		if (!ok) return def_errMsg("DNS Data failed to drop",reply,"dnsBtnBar")

		delete ctx.dns;
		push_show_one_domain(idx);
		},{ json: { "name": dom.name }})
}



function process_add_rr(idx,rrs_id,rec_id)
{
	let dom = ctx.domains[idx];

	let old_content = null;
	if ((rrs_id>=0)&&(rec_id>=0)) {
		rrs = ctx.dns.rrsets[rrs_id];
		old_content = rrs.records[rec_id].content;
		}

	let add_rr = {}, elems = {};
	for(let i of ["rr_name","rr_type","rr_ttl","rr_data"]) {
		elems[i] = document.getElementById(i);
		add_rr[i.slice(3)] = elems[i].value;
		};

    add_rr.ttl = parseInt(add_rr.ttl);
    if ((add_rr.name == "")||(add_rr.name == "@"))
    	add_rr.name = dom.name + ".";
	else {
		let as_puny = toASCII(add_rr.name);
		if ((as_puny != add_rr.name)&&(hasIDN(as_puny)))
			add_rr.name = as_puny;

		if (!hostnameCheck.test(add_rr.name)) {
			errMsg("Invalid host name","AddRRwin");
			elems.rr_name.focus();
			return;
			}

		add_rr.name = `${add_rr.name}.${dom.name}.`;
		}

	if (isNaN(add_rr.ttl)) {
		errMsg("Invalid TTL value","AddRRwin");
		elems.rr_ttl.focus();
		return;
		}

	let val_rr = "rr" + add_rr.type;

	if ((add_rr.type=="TXT")&&(add_rr.data.slice(0,1)!='"')&&(add_rr.data.slice(-1)!='"'))
		add_rr.data = `"${add_rr.data}"`;

	if (val_rr in validations) {
		if (!validations[val_rr].test(add_rr.data)) {
			errMsg("RR data failed validation test","AddRRwin")
			elems.rr_data.focus();
			return; }
		}

	if ((val_rr in autoAddDot)&&(add_rr.data.slice(-1)!=".")) add_rr.data += ".";

	let prev_rr_data = add_rr["data"];
	add_rr["data"] = [ add_rr["data"] ];

	for(let i of ctx.dns.rrsets) {
		if ((i.name==add_rr.name)&&(i.type==add_rr.type)) {
			for(let c of i.records) {
				if ((prev_rr_data != c.content)&&(old_content!=c.content))
					add_rr.data.push(c.content)
				}
			}
		}

	callApi("dns/update",(ok,reply) => {
		if (!ok) return def_errMsg("DNS Data failed to update",reply,"AddRRwin")
		hideAllPopUp();
		domain_dns(idx);
		}, { json: { "name":dom["name"], "rr": add_rr }} );
}



function AddkeyDown(event,idx,rrs_id,rec_id) {
	if (event.key=="Escape") return hideAllPopUp();
	if (event.key=="Enter") return process_add_rr(idx,rrs_id,rec_id);
}



function edit_rr(idx,rrs_id,rec_id)
{
	let rrs = ctx.dns.rrsets[rrs_id];
	ctx.last_rr = {
		"rr_name": rrs.name,
		"rr_type": rrs.type,
		"rr_ttl": rrs.ttl,
		"rr_data": rrs.records[rec_id].content,
		"rrs_id": rrs_id,
		"rec_id": rec_id
		}

	document.getElementById("AddRRwin").innerHTML = add_rr_form({"idx":idx});
	togglePopUp("AddRRwin",0);
}



function delete_rr(idx,rrs_id,rec_id)
{
	let dom = ctx.domains[idx];
	let rrs = ctx.dns.rrsets[rrs_id];

	rr_data = []
	for(let i in rrs.records)
		if (i!=rec_id) rr_data.push(rrs.records[i].content);

	del_rr = {
		"name": dom["name"],
		"rr": {
			"name":rrs.name,
			"type":rrs.type,
			"ttl": rrs.ttl,
			"data": rr_data
			}
		};

	hideAllPopUp();

	callApi("dns/update",(ok,reply) => {
		if (!ok) return def_errMsg("DNS Data failed to update",reply,`rrs_${rrs_id}_${rec_id}`);
		domain_dns(idx);
		}, { json: del_rr });
}



function rr_type_select(name,val)
{
	let x = "";
	[ "A", "AAAA", "MX", "NS", "TXT", "A6", "ADDR", "AFSDB", "ALIAS", "CAA", "CDNSKEY", "CDS",
	"CERT", "CNAME", "DHCID", "DLV", "DNAME", "DNSKEY", "DS", "EUI48", "EUI64", "HINFO", "IPSECKEY",
	"KEY", "KX", "LOC", "LUA", "MAILA", "MAILB", "MB", "MG", "MINFO", "MR", "MX", "NAPTR", "NS",
	"OPENPGPKEY", "OPT", "PTR", "RKEY", "RP", "RRSIG", "SIG", "SMIMEA", "SOA", "SPF", "SRV", "SSHFP",
	"TKEY", "TLSA", "TXT", "URI", "WKS" ].forEach((i) => { 
		if (val==i) x+= "<option selected>"+i; else x += "<option>"+i;
		});

	return `<select id=${name}>${x}</select>`;
}



function clean_host_name(dom_name,hostname)
{
	if (!hostname) return "";
	if (hostname==dom_name) return '@';
	if (hostname.slice(-1*dom_name.length)==dom_name) hostname = hostname.slice(0,-1*(dom_name.length+1))
	if (hasIDN(hostname)) hostname = fromPuny(hostname);
	return hostname;
}



function add_rr_form(params)
{
	let have_last_rr = false;
	let last_rr = { "rrs_id":-1,"rec_id":-1,"rr_name":"","rr_type":"A","rr_data":"","rr_ttl":policy("default_ttl",86400) };
	if (ctx.last_rr) {
		last_rr = ctx.last_rr;
		delete ctx.last_rr;
		last_rr.rr_data = last_rr.rr_data.replace(/'/g, "&apos;");
		have_last_rr = true;
		}

	let idx = params.idx;
	let dom = ctx.domains[idx];
	let dom_name = dom["name"]+".";

	let add_key = `onkeydown="AddkeyDown(event,${idx},${last_rr.rrs_id},${last_rr.rec_id});"`
	let x = "<table cellspacing=1 cellpadding=0 border=0>";
	x += `<tr><td class=formPrompt>Record Name :</td><Td><input value="${clean_host_name(dom_name,last_rr.rr_name)}" id=rr_name ${add_key} style="width: 250px;"></td></tr>`;
	x += `<tr><td class=formPrompt>Record Type :</td><Td>` + rr_type_select("rr_type",last_rr.rr_type) + "</td></tr>";
	x += `<tr><td class=formPrompt>TTL :</td><Td><input value="${last_rr.rr_ttl}" id=rr_ttl ${add_key} style="width: 100px;"></td></tr>`;
	x += `<tr><td class=formPrompt>RR Data :</td><Td><input value='${last_rr.rr_data}' id=rr_data ${add_key} style="width: 250px;"></td></tr>`;
	x += "<tr><td>"+gbl.gap+"</td></tr>";
	x += "<tr><td colspan=2 class=btmBtnBar>"
	if (have_last_rr) {
		x += btn(`cancel_rr(${idx})`,"Cancel","Cancel changing this RR",75);
		x += btn(`delete_rr(${idx},${last_rr.rrs_id},${last_rr.rec_id})`,"Delete RR","Delete this RR from the zone",75);
		x += btn(`process_add_rr(${idx},${last_rr.rrs_id},${last_rr.rec_id})`,"Update RR","Update this RR back into the zone",75);
	} else {
		x += btn(`cancel_rr(${idx})`,"Cancel","Cancel adding this RR",75);
		x += btn(`process_add_rr(${idx},-1,-1)`,"Add RR","Add this RR",75);
	}
	x += "</table>";

	return x;
}



function cancel_rr(idx)
{
	document.getElementById("AddRRwin").innerHTML = add_rr_form({"idx":idx});
	hideAllPopUp();
}



function unsign_zone(idx)
{
	let dom = ctx.domains[idx];
	callApi("dns/unsign",(ok,reply)=>{
		if (!ok) return def_errMsg("Domain failed to unsign",reply,"dnsBtnBar")

		if (reply.domain) {
			preset_domain_extras(reply.domain);
			ctx.domains[idx] = reply.domain;
			}
		if (reply.dns) ctx.dns = reply.dns;

		show_dns_data(idx);
		},{ json: { "name": dom.name }})
}



function drop_data_confirm(param)
{
	let x = "<table>"
	x += "<tr><th>Are you sure you want to drop all this data?</th></tr>";
	x += "<tr><td class=btmBtnBar>"
	x += btn("hideAllPopUp()","Cancel","Cancel dropping this data",100);
	x += btn(`drop_zone(${param.idx})`,"Drop all Data","Drop all RR data show here",100);
	x += "</table>";
	return x;
}



function show_dns_data(idx)
{
	let dom = ctx.domains[idx];
	let dom_name = dom["name"]+".";

	let x="<table width=75% align=center cellspacing=1 cellpadding=0 border=0>";
	x += "<tr><td align=center><table width=100%><tr><td class=btmBtnBar><span id=dnsBtnBar>"

    x += generic_popup_btn({
        "name": "DropDataWin",
        "label": "Drop this Data",
        "width": 100,
        "timeout": null,
        "title": "Drop sub-domain data for this domain",
        "internal": drop_data_confirm,
		"style": "overflow: auto; margin-left: -250;",
        "param": {"idx":idx}
        });

	if (!ctx.dns.dnssec)
		x += btn(`sign_zone(${idx})`,`Sign Zone`,"DNSSEC sign this domain",100)
	else
		x += btn(`unsign_zone(${idx})`,`Unsign Zone`,"Remove DNSSSEC signing on this domain",100)

    let last_rr = ctx.last_rr;
    x += generic_popup_btn({
        "name": "AddRRwin",
        "label": "Add RR",
        "width": 100,
        "timeout": null,
        "title": "Add a DNS record to this domain",
        "internal": add_rr_form,
		"style": "overflow: auto; margin-left: -250;",
        "param": {"idx":idx}
        });

	x += "</td></tr></table></td></tr>";

	if (policy("dns_servers",null) != dom.ns) {
		x += "<tr><th>Warning: this data may not be public until<br>you set this zone to use our name servers</th></tr>";
		}

	x += settings_header(`DNS Data for - ${dom.display_name}`,true);
	x += "<table width=100%>";

	for(let i in ctx.dns.rrsets) {
		let rrs = ctx.dns.rrsets[i];
		for(let c in rrs.records) {
		let each_rr = rrs.records[c];
		let func = "edit_rr";

		let show_name = clean_host_name(dom_name,rrs.name);
		if ((show_name=="@")&&((rrs.type=="NS")||(rrs.type=="SOA"))) func = "rr_locked";

		x += `<tr title='Click to delete / edit this record' onClick="${func}(${idx},${i},${c});" id="rrs_${i}_${c}" class=dataRow>`;
		x += `<td title='${rrs.name}'>${show_name}</td><td>${rrs.type}</td><td>${rrs.ttl}</td><td>${each_rr.content}</td></tr>`;

		if ((rrs.type=="SOA")&&(ctx.dns.dnssec)&&(ctx.dns.ds))
			x += `<tr onClick="rr_locked(${idx},'ds',0);" id="rrs_ds_0" class=dataRow><td>@</td><td>DS</td><td>${rrs.ttl}</td><td>${ctx.dns.ds}</td></tr>`;
		}
	}

	x += "</table></td></tr></table>";
	elm.userSpace.innerHTML = x;
}


function rr_locked(idx,i,c) { return errMsg("That record is locked",`rrs_${i}_${c}`) }


function one_domain_html(idx)
{
	let dom = ctx.domains[idx];
	let have_locks = {};
	if (dom.client_locks) { for(let i of dom.client_locks.split(",")) have_locks[i] = true }

	let auto_renew = gbl.cross;
	if (dom.auto_renew) auto_renew = gbl.tick;

	let x = "<table align=center width=75% border=0>";

	x += "<tr><td colspan=4 class=btmBtnBar><span id=domainBtnBar>"

	if ((dom.status_id in {1:true,20:true})&&(!have_locks.RenewProhibited))
		x += btn(`buy_one_name('${dom.name}','renew',true)`,`Renew`,"Renew this domain",100)

	if ((dom.is_live)&&(!have_locks.TransferProhibited))
		x += btn(`push_domain_transfer_options('${idx}')`,"Transfer",`Options for transferring this domain to another owner`,100)

	if (dom.status_id != 20) {
		x += btn(`push_domain_dns('${idx}')`,"DNS Data",`Edit the DNS Data for ${dom.display_name}`,100)
		x += btn(`push_domain_settings('${idx}')`,"Settings",`Edit the settings for ${dom.display_name}`,100)
		}

	x += "</span></td></tr>";
	x += "<tr><td colspan=4>"+gbl.gap+"</td></tr>";
	let puny = "";
	if (dom.display_name != dom.name) puny = `&nbsp;&nbsp;<span class=searchRenew>${dom.name}</span>`;
	x += `<tr title="${dom.name}"><td class=promptCell>Name :</td><td class=dataCell>${dom.display_name}${puny}</td></tr>`;
	x += `<tr><td class=promptCell>Is Live :</td><td class=dataCell>${tick_cross(dom.is_live)}</td></tr>`;
	x += `<tr><td class=promptCell>Status :</td><td class=dataCell>${dom.status_desc}</td></tr>`;

	locks = "None";
	if (dom.client_locks) locks = dom.client_locks;
	x += `<tr><td class=promptCell>Locks :</td><td class=dataCell>${locks}</td></tr>`;

	x += `<tr><td class=promptCell>Expiry Date :</td><td class=dataCell>${dom.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Create Date :</td><td class=dataCell>${dom.created_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${dom.amended_dt}</td></tr>`;
	if (dom.ns) {
		let ns = dom.ns.toLowerCase().split(",").sort().join("<br>")
		x += `<tr><td class=promptCell>Name Servers :</td><td class=dataCell>${ns}</td></tr>`;
		}
	if (dom.ds) {
		let ds = dom.ds.toLowerCase().split(",").sort().join("<br>")
		x += `<tr><td class=promptCell>DS Records :</td><td class=dataCell>${ds}</td></tr>`;
		}
	x += `<tr><td class=promptCell>Auto Renew :</td><td class=dataCell>${auto_renew}</td></tr>`;
	return x + "</table>";
}



function push_show_one_domain(idx) { push_hist(`show_one_domain/${idx}`); return show_one_domain(idx); }
function go_show_one_domain(with_push,rest) { show_one_domain(parseInt(rest[0])); }

function show_one_domain(idx)
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = one_domain_html(idx);
	size_one_space();
}


function submit_resend()
{
	send_json = {
		"email": document.resendPass.email.value,
		"pin":document.resendPass.pin.value
		};

	if (!valid_email.test(send_json.email)) {
		errMsg("Email address is invalid",'resend_table');
		document.resendPass.email.focus();
		return false;
		}

	callApi("request/reset",(ok,reply) => {
		if (!ok) {
			def_errMsg("Reset password request failed",reply,"resend_table");
			return false;
			}

		elm.userSpace.innerHTML = "<h2>Reset request processed</h2><P>"
			+"<center>If a matching account has been found<br>you will receive an email with a reset link<P>"
			+`<P>Don't forget you will need your PIN number<P><h2>${send_json.pin}</h2></center>`;

		},{ json: send_json });

	return false;
}


function resend_password(with_push)
{
	if (with_push) push_hist("resend_password");
	hideAllPopUp()
	pin_code = (Math.trunc(Math.random()*1000000)).toString().slice(-4);
	let x = "<form name=resendPass action=# method=post onSubmit='return submit_resend();'><table width=75% id='resend_table' align=center border=0>";
	x += settings_header("Reset Password",true);
	x += "Enter your email address below and we will email you a link to reset your password</td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += "<tr><Td style='white-space: normal;'>When you click the password reset link in the email, you will be asked for the PIN number shown below. ";
	x += "You will <B>NOT</b> be able to reset your password without this PIN Number</td></tr>"
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += `<tr><td><h2>${pin_code}</h2></td></tr>`;
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += "<tr><td><table width=100%><tr><td class=formPrompt>Your email address:</td>";
	x += `<input type=hidden name=pin value='${pin_code}'>`;
	x += "<td><input autofocus style='width: 350px;' name=email></td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += "<tr><td class=btmBtnBar colspan=2><input type=submit value='Reset Password' class=myBtn></td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += "</form></table></td></tr></table>";
	elm.userSpace.innerHTML = x;
	show_one_space("userSpace");
	document.resendPass.email.focus();
	return false;
}


</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<colgroup><col width=70%/><col/></colgroup>
<tr>
<td align=left><span id="businessName" class="businessName">Registrar</span></td>
<td align=right>

<span style="display: none;" id="noLoginBtns">

<div class="popup">
<span style='width: 75px;' tabindex=0 title="Register me" class=myBtn onClick="toggleRegister(); return false;">Register</span>
<span class="popuptext" id="registerPopup">
<form onSubmit='doRegister(); return false;' method=submit action='#' name=formRegister><table>
<tr onClick="toggleRegister();"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Name:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="name">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="confirm">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleRegister();">Cancel</span>
		<input style='width: 110px;' tabindex=0 type=submit title="Register" class=myBtn value="Register">
	</td>
</tr></form></table>
</span></div>


<div class="popup">
<span style='width: 75px;' tabindex=0 title="Get me logged in" class=myBtn onClick="toggleLogin(); return false;">Login</span>
<span class="popuptext" id="loginPopup">
	<table>
		<form onSubmit='return doLogin();' action="#" method=post name=formLogin>
		<tr onClick="toggleLogin()"><Td colspan=2><div style="height: 15px;"></div></td></tr>
			<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
			<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
		<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
		<tr><td align=center colspan=2><a href=# onClick="return resend_password(true);">Forgotton</a> your password</td></tr>
		<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
		<tr>
			<td class=btmBtnBar colspan=2>
				<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleLogin()">Cancel</span>
				<input style='width: 110px;' tabindex=0 type=submit title="Login" class=myBtn value="OK">
			</td>
		</tr>
		</form>
	</table>
</span>
</div>
</span>

<span style="display:none;" id="isLoggedIn">
	<span style='width: 75px;' tabindex=0 title="List my domains" id="myDomainsBtn" class=myBtn onClick="return myDomains(true);">Domains</span>
	<span style='width: 75px;' tabindex=0 title="My account details" id="myAccountBtn" class=myBtn onClick="load_domains_list(myAccount); return false;">Account</span>
	<span style='width: 75px;' tabindex=0 title="Log me out" class=myBtn onClick="doLogOut(); return false;">Logout</span>
</span>
</td></tr>
</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 85px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
<span style='width: 85px;' tabindex=0 title="Domain name search" class=myBtn onClick="goSearch(true);">Search</span>
<span id=marketPlaceBtn style='width: 85px;' tabindex=0 title="Go to the domain market place" class=myBtn onClick="goMarketPlace();">Marketplace</span>
</div>
</td>

<td align=right><table width=100% border=0>
<colgroup><col width=20%/><col width=20%/><col width=60%/></colgroup>
<tr><td><span id="errorSpan">&nbsp;</span></td>
<td><span title="Please confirm your email address" id=emailIcon class=userIcons style="display: none;" onClick="confirmEmail();">&#128231;</span></td>
<td><span title="You have orders waiting to be paid for" id="ordersIcon" class=userIcons style="display: none;" onClick="load_domains_list(myAccount);">&#x1F4B3;</span></td>
<td align=center>
<span id="basketIcon" style="display: none;" class="popup">
<span class=userIcons title="You have items waiting to checkout" ${style} onClick='togglePopUp("basketPopup",30000);'>&#128722;</span>
<span style="margin-left: -250px;" class="popuptext" id="basketPopup">
</span></span></td><td align=center><span id="userInfo"></span></td></tr></table></td>
</tr></table>
</div>

<div id="allBottom">
	<div style='height: 30px;'></div>
	<div id="search">
		<div style='height: 30px;'></div>
		<table align=center width=40% border=0>
		<form action="#" name=searchForm onSubmit="return doSearch();">
			<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox id=searchEdit></td></tr>
		</form>
			<tr><td><div id="output"></div></td></tr>
		</table>
	</div>
	<span class="botSapce" id="userSpace" style="display: none;"></span>
	<span class="botSapce" id="basketSpace" style="display: none;"></span>
	<span class="botSapce" id="marketPlace" style="display: none;"></span>
</div>

<div><table><tr><td><div onClick="unerrMsg();" id=myMsgPop class='msgPop msgPopNo'></div></td></tr></table></div>
</body>
</html>
