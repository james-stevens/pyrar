<html>
<head>
	<title>Python Registrar</title>
	<meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = false;


elm = {};
gbl = {
	"theme": window.localStorage.getItem("theme"),

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	bin: "&#x2702;",
	warn: "&#x26a0;",
	page: "&#x1F5CE;",
	nsec: "&#x1F512;",
	nsec3: "&#x1F510;",
	clip: "&#x1F4CE;",
	cart: "&#128722;",
	email: "&#128231;",
	copy: "&#x2398",

	cur: "$",
	cur_iso: "USD",

	gap: "<div style='height: 7px;'></div>",
	settings_spacer: "<tr><td><div style='height: 70px;'></div></td></tr>",

	def_max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="default";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);


gbl.head = document.head || document.getElementsByTagName('head')[0];

function keyEsc(e) {
    if (e.key == "Escape") {
    	hideAllPopUp();
    	unerrMsg();
		if (elm.search.style.display != "none") document.searchForm.search.focus();
    	}
}


function hideAllPopUp()
{
	hidePopUp();
	["loginPopup","registerPopup","themePopup"].forEach(item => {
		let popup = document.getElementById(item);
		popup.classList.remove("show")
		});
}


function changeFavicon(src) {
	var link = document.createElement('link'),
		oldLink = document.getElementById('dynamic-favicon');

	link.id = 'dynamic-favicon';
	link.rel = 'shortcut icon';
	link.href = src;
	if (oldLink) gbl.head.removeChild(oldLink);
	gbl.head.appendChild(link);
	}



function clr_lazy_hide()
{
	if (!ctx.popup) return;
	if (ctx.popup.timer) clearTimeout(ctx.popup.timer);
	delete ctx.popup;
}


function togglePopUp(name,tmout)
{
	if ("popup" in ctx) {
		let save_name = ctx.popup.name;
		hidePopUp();
		if (save_name==name) { unerrMsg(); return; }
		}

	let popup = document.getElementById(name);
	if (popup) popup.classList.toggle("show");

	hide_now = setTimeout(hidePopUp,tmout);
	ctx.popup = { "timer": hide_now, "name": name }

	let e = null;
	if (name=="loginPopup") e = document.formLogin.email;
	if (name=="registerPopup") e = document.formRegister.email;
	if (name=="AddNSPopup") e = document.getElementById("inputNS");
	if (name=="AddDSPopup") e = document.getElementById("inputDS");
	if (e) { e.focus(); e.select(); }

	return false;
}



function hidePopUp()
{
	if (!("popup" in ctx)) return;
	let popup = document.getElementById(ctx.popup.name);
	if (popup) popup.classList.remove("show")
	clr_lazy_hide();
}



function do_theme_change(value)
{
	clr_lazy_hide();
	if (value in theme_colours) changeTheme(value);
	let popup = document.getElementById("themePopup");
	popup.classList.remove("show")
	if (elm.search.style.display != "none") document.searchForm.search.focus();
}


function toggleLogin() { togglePopUp("loginPopup",30000); }
function toggleRegister() { togglePopUp("registerPopup",30000); }
function toggleTheme() { togglePopUp("themePopup",5000); }



function show_one_space(name)
{
	for (let item of ["userSpace","marketPlace","search","basketSpace"]) {
		if (item != name) elm[item].style.display = "none";
		};
	elm[name].style.display = "block";
}



function goSearch()
{
	show_one_space("search");
	document.searchForm.search.focus();
}


function loggedIn()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "none";
	e = document.getElementById("isLoggedIn");
	e.style.display = "block";
	user_info();
}


function emptyCart()
{
	delete gbl.basket;
	user_info();
	errMsg(`${gbl.bin} basket emptied`,elm.errorSpan);
	if (elm.basketSpace.style.display == "block") goSearch();
}



function removeBasketItem(i)
{
	if (gbl.basket.length == 1) {
		delete gbl.basket;
		if (elm.basketSpace.style.display == "block") goSearch();
		}
	else gbl.basket.splice(i,1);

	if (("popup" in ctx)&&("name" in ctx.popup)&&(ctx.popup.name=="basketPopup")) {
		clearTimeout(ctx.popup.timer);
		delete ctx.popup.timer;
		}

	user_info()
	if (elm.basketSpace.style.display == "block") basketCheckout();
}



function start_basket_table()
{
	let x = '<tr><th>Domain</th><th>Action</th><th>Yrs</th><th>Cost</th></tr>';
	for(let i in gbl.basket) {
		let item = gbl.basket[i];
		x += `<tr onClick="removeBasketItem(${i});" title="Remove this item" class=dataRow>`
		x += `<td>${fromPuny(item.domain)}</td><td align=center>${item.action}</td>`;
		x += `<td align=center>${item.num_years}</td><td align=right>${gbl.cur}${item.cost}</td></tr>`;
		}
	return x;
}



function user_info()
{
	if (gbl.basket) {
		elm.basketIcon.style.display = "block";
		let x = '<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>' + start_basket_table()
		x += `<tr><td colspan=4>${gbl.gap}</td></tr>`;
		x += "<tr><Td class=btmBtnBar colspan=4 align=center>";
		x += "<button style='width: 110px;' onClick='emptyCart();' class=myBtn>Empty</button>";
		x += "<button style='width: 110px;' onClick='basketCheckout();' class=myBtn>Checkout</button></td></tr>";
		x += "</table>";
		elm.basketPopup.innerHTML = x;
		}
	else
		elm.basketIcon.style.display = "none";

	if (("user" in ctx)&&("name" in ctx.user)) {
		elm.userInfo.innerHTML = `Logged in as: <b>${ctx.user.name}</b>`;
		}
}



function doRegister()
{
	let p = document.getElementById("registerPopup");

	function regErr(err,item)
	{
		errMsg(err,p);
		clr_lazy_hide();
		item.focus();
	}

	let f = document.formRegister;

	if (f.password.value != f.confirm.value) return regErr("Passwords do not match",p);
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",p);

	data = {
		"name":f.name.value,
		"email":f.email.value,
		"password":f.password.value
		};

	callApi("users/register",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";
		f.confirm.value = "";
		f.name.value = "";

		}, { json: data });
}


function doLogin()
{
	function regErr(err,item)
	{
		errMsg(err,document.getElementById("loginPopup"));
		clr_lazy_hide();
		item.focus();
		return false;
	}

	let f = document.formLogin;
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",f.email);

	data = { "email":f.email.value, "password":f.password.value };

	callApi("users/login",(ret,reply) => {
		if (!ret) {
			let msg="Error logging in";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";

		}, { json: data });

	return false;
}



function doLogOut()
{
	ctx = {};
	callApi("users/logout",(ret,reply) => {});
	show_one_space("search");
	document.searchForm.search.focus();
	loggedOut();
}



function loggedOut()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "block";
	e = document.getElementById("isLoggedIn");
	e.style.display = "none";
	elm.userInfo.innerHTML = "";
}



function bodyLoaded()
{
	["myMsgPop","errorSpan","basketIcon","userInfo","marketPlace","basketSpace","basketPopup",
	"userSpace","output","topSpan","search","businessName"].forEach(i => {
		elm[i] = document.getElementById(i);
		} );

	let mainDiv = document.getElementById("allBottom");
	mainDiv.onclick = function (e) { if (e.target !== this) return; hidePopUp(); }
	let srchDiv = document.getElementById("search");
	srchDiv.onclick = function (e) { if (e.target !== this) return; hidePopUp(); }

	callApi("config",(ret,reply) => {
		if (!ret) {
			let msg = "Error contacting servers";
			if ("error" in reply) msg = reply["error"];
			return errMsg(msg,document.searchForm.search);
			}

		gbl.config = reply;
		gbl.config.ok_tlds = {};
		for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;

		let my_icon = policy("icon",null);
		let site_name = policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			elm.businessName.innerHTML = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		else elm.businessName.innerHTML = site_name;

		gbl.cur = policy("currency_symbol","$");
		gbl.cur_iso = policy("currency_iso","USD");

		elm.output.innerHTML = `<div class=userMsg>${policy("user_message","Welcome")}</div>`;

		if ("session" in ctx) {
			callApi("users/details",(ret,reply) => {
				if (ret) {
					if ("user" in reply) ctx.user = reply.user;
					if ("domains" in reply) ctx.domains = reply.domains;
					loggedIn();
					}
				});
			} else { loggedOut(); }
		});
}


function one_search_line(item,block_not_avail)
{
	if (block_not_avail) {
		if ((!("for_sale_msg" in item))&&(!item.avail)) return "";
		}

	let x = "<tr class=searchDomain>";
	x += `<td><span title="${item.name}">${fromPuny(item.name)}</span>`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${gbl.cur}${item.renew}</span>`;
	x += "</td>";

	if ("for_sale_msg" in item) x += `<td colspan=2>${item.for_sale_msg}</td>`;
	else if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td style='vertical-align: middle; text-align: right;'>";
			x += btn(`buy_one_name('${item.name}','create')`,`<b>BUY ${gbl.cur}${item.create}</b>`,`Buy '${item.name}' for ${gbl.cur}${item.create}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(ret,data)
{
	let is_multi_search = (("search" in ctx)&&("todo" in ctx.search));

	if ((!ret)&&("error" in data)) { errMsg(data.error,document.searchForm.search); return; }

	for(let item of data) ctx.search.result += one_search_line(item,is_multi_search);
	elm.output.innerHTML = "<table border=0 cellspacing=0 width=100%>" + ctx.search.result + "</table>";

	if (is_multi_search) {
		if (ctx.search.todo.length <= 0) delete ctx.search.todo; else searchNext();
		}
	else {
		ctx.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buy_one_name(domain,action)
{
	let qry = { "domain" : domain, "num_years": 1 }

	if ("basket" in gbl) {
		for(let item of gbl.basket) {
			if ((item.domain==domain)&&(item.action==action))
				qry.num_years = item.num_years + 1;
			}
		}

	callApi("domain/check",(ret,data) => {
		if (!ret) {
			errMsg("Unexpected price error",elm.userInfo);
			console.log("PRICE ERROR:",data);
			return;
			}

		let found_it = false;
		let dom = data.shift();

		if (!(action in dom)) {
			let msg = "an error occured";
			if ((action+":err") in dom) msg = dom[action+":err"];
			errMsg(msg,elm.basketIcon);
			return;
			}

		let new_item = {
			"domain": dom.name,
			"num_years": dom.num_years,
			 "cost": dom[action],
			 "action": action
			 };

		if (!("basket" in gbl)) { gbl.basket = [new_item]; }
		else {
			for(let item of gbl.basket) {
				if ((item.domain==dom.name)&&(item.action==action)) {
					item.num_years = dom.num_years
					item.cost = dom[action];
					found_it = true;
					}
				}

			if (!found_it) {
				if (gbl.basket.length >= policy("max_basket_size",10)) {
					errMsg("Basket full, please checkout",elm.basketPopup);
					}
				else gbl.basket.push(new_item);
				}
			}

		user_info();
		clr_lazy_hide();
		elm.basketPopup.classList.add("show");
		ctx.popup = { "timer": setTimeout(hidePopUp,2500), "name": "basketPopup" };

		}, { json: qry });
}



function searchNext()
{
	let first = ctx.search.todo.shift();
	let srch = [ ctx.search.term + "." + first.name ];

	let max = gbl.def_max_checks;

	if ((first.registry in gbl.config.registry)&&("max_checks" in gbl.config.registry[first.registry]))
		max = gbl.config.registry[first.registry].max_checks;

	while((ctx.search.todo.length > 0)&&(srch.length < max)&&(first.registry == ctx.search.todo[0].registry)) {
		let nxt = ctx.search.todo.shift();
		srch.push(ctx.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}



function multiSearch(srch,not_me_tld)
{
	ctx.search.todo = [];
	ctx.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) ctx.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
	function do_end() {
		f.search.focus();
		f.search.select();
		return false;
		}

	delete ctx.search;

	elm.output.innerHTML = "";

	ctx.search = {};
	ctx.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

	let f = document.searchForm;
	let srch = toASCII(f.search.value);

	if (srch.indexOf(".") >= 0) {
		if (!fqdnCheck.test(srch)) {
			errMsg("Invalid domain name",document.searchForm.search);
			return do_end(); }

		if (!supported_tld(srch)) {
			errMsg("Not a supported TLD",document.searchForm.search);
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		errMsg("Invalid domain name",document.searchForm.search);
	else
		multiSearch(srch,null);

	return do_end();
}


function userDomainList()
{
	if (ctx.domains.length <= 0) return "<h2>You have no domains ... yet</h2>";

	let x = "<table width=75% align=center border=0>";
	x += "<tr><th>Domain Name</th><th>Expiry Date</th><th>Name Servers</th></tr>";
	if (ctx.domains.length < 30) cls="dataRowBig"; else cls="dataRow";
	for(let i in ctx.domains) {
		let item = ctx.domains[i];
		x += `<tr onClick="show_one_domain(${i});" class=${cls}><td title="${item.name}">${item.display_name}</td>`;
		x += `<td align=center>${item.expiry_dt.split(" ")[0]}</td>`
		x += `<td>${item.name_servers.substr(0,40)}</td>`;
		x += "</tr>";
		}
	return x + "</table>";
}


function myDomains()
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";

	callApi("users/domains",(ret,reply) => {
		if (!ret) {
			let msg="Error getting your domain data";
			if ("error" in reply) msg = reply["error"];
			goSearch();
			return errMsg(msg,document.searchForm.search);
			}
		if ("domains" in reply) {
			ctx.domains = reply.domains;
			for(let dom of ctx.domains) {
				dom.display_name = fromPuny(dom.name);
				}
			}
		else delete ctx.domains;
		elm.userSpace.innerHTML = userDomainList()
		});
	return false;
}



function postUserDetails()
{
	let f = document.editUserDetails;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	data = {
		"name": f.user_name.value,
		"email": f.user_email.value,
		"auto_renew_all": parseInt(f.elements["user_auto_renew_all"].value)
		};

	if (!valid_email.test(data.email)) return regErr("Invalid email address",f.user_email);

	callApi("users/update",(ret,reply) => {
		if (ret) {
			if ("user" in reply) {
				ctx.user = reply.user;
				user_info();
				elm.userSpace.innerHTML = userDetails();
				}
			}
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: data });

	return false;
}


function postUserPassword()
{
	let f = document.editUserPassword;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);
	if (f.new_password.value=="") return regErr("New password missing",f.new_password);
	if (f.confirm_password.value=="") return regErr("Confirm password missing",f.confirm_password);

	if (f.new_password.value != f.confirm_password.value)
		return regErr("Passwords do not match",f.new_password);

	data = {
		"password": f.password.value,
		"new_password": f.new_password.value,
		};

	callApi("users/password",(ret,reply) => {
		if (ret) {
			errMsg("Password changed",elm.userInfo);
			user_info();
			elm.userSpace.innerHTML = userDetails();
			}
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: data });

	return false;
}


function postCloseAccount()
{
	let f = document.editCloseAccount;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);

	callApi("users/close",(ret,reply) => {
		if (ret) goSearch();
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: { "password": f.password.value }});

	return false;
}



function goMarketPlace()
{
	errMsg("Not yet implemented",document.getElementById("marketPlaceBtn"));
}



function enable_two_fa()
{
	errMsg("Not yet implemented",document.getElementById("edit2FA"));
}


function settings_header(title,spacer)
{
	let x = "";
	if (!spacer) x = gbl.settings_spacer;
	x += `<tr><td class=settingsBanner>${title}</td></tr><tr><td>`;
	return x;
}
function settings_prompt(txt) { return `<tr><td class=formPrompt>${txt} :</td><td>`; }



function user_settings()
{
	let x="<table align=center border=0>";
	x += settings_header("Change User Details",true);
	x += "<form name=editUserDetails method=post action=# onSubmit='postUserDetails(); return false;'>";
	x += "<table width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += settings_prompt("E-Mail")+`<input style="width: 300px;" id='user_email' value='${ctx.user.email}'></td></tr>`;
	x += settings_prompt("Name")+`<input style="width: 300px;" id='user_name' value='${ctx.user.name}'></td></tr>`;
    x += settings_prompt("Auto Renew All")+`<select id='user_auto_renew_all'>`;

    let yes_chk="",no_chk="";
    if (ctx.user.auto_renew_all) yes_chk="selected"; else no_chk="selected";
    x += `<option ${yes_chk} value=1>Yes<option ${no_chk} value=0>No</select></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += settings_header("Control Two-Factor Authentication");
	x += "<table id=edit2FA width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	if (("two_fa" in ctx.user) && (ctx.user.two_fa != null) && (ctx.user.two_fa != "")) {
		x += "<tr><td colspan=2>Disable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Disable 2FA","Disable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	else {
		x += "<tr><td colspan=2>Enable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Enable 2FA","Enable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	x += "</table></form></td></tr>";


	x += settings_header("Change Your Password");
	x += "<form name=editUserPassword method=post action=# onSubmit='postUserPassword(); return false;'>";
	x += "<table width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += settings_prompt("Current Password");
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += settings_prompt("New Password");
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Your new password" type=password id='new_password'></td></tr>`;
	x += settings_prompt("Confirm Password");
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Confirm your new password" type=password id='confirm_password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += settings_header("Close This Account");
	x += "<form name=editCloseAccount method=post action=# onSubmit='postCloseAccount(); return false;'>";
	x += "<table width=100%><colgroup><col width=30%/><col/><col width=10%/></colgroup>";
	x += "<tr><td colspan=2>To close your account, please enter your current password</td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += settings_prompt("Current Password");
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Close Account'></td></tr>";
	x += "</table></form></td></tr>";

	elm.userSpace.innerHTML = x+"</table>";

	document.editUserDetails.user_email.focus();
}



function userDetails()
{
	let auto_renew = gbl.cross;
	let verified = gbl.cross;
	let has_twofa = gbl.cross;
	if (ctx.user.auto_renew_all) auto_renew = gbl.tick;
	if (ctx.user.email_verified) verified = gbl.tick;
	if (ctx.user.two_fa) has_twofa = gbl.tick;

	let x = "<table align=center width=50% border=0>";
	x += "<tr><td colspan=2 class=btmBtnBar>";

	if (!ctx.user.email_verified) 
		x += btn("resend_verify_email()","Resend Verify","Resend e-mail verification",100);

	x += btn("user_settings()","Settings","Change this accounts settings",100)
	x += "</td></tr>";

	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += `<tr><td class=promptCell>E-Mail :</td><td class=dataCell>${ctx.user.email}</td></tr>`;
	x += `<tr><td class=promptCell>E-Mail Verified :</td><td class=dataCell>${verified}</td></tr>`;
	x += `<tr><td class=promptCell>Name :</td><td class=dataCell>${ctx.user.name}</td></tr>`;
	x += `<tr><td class=promptCell>Last Login :</td><td class=dataCell>${ctx.user.last_login_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${ctx.user.amended_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Created :</td><td class=dataCell>${ctx.user.created_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Auto Renew All :</td><td class=dataCell>${auto_renew}</td></tr>`;
	return x + "</table>";
}


function place_order()
{
	errMsg("Not yet implemented",document.getElementById("placeOrderBtn"));
}


function basketCheckout()
{
	hidePopUp();
	show_one_space("basketSpace");
	let x = '<table id=placeOrderBtn align=center style="min-width: 50%;" border=0 cellspacing=2 cellpadding=5>' + start_basket_table();
	let total = 0.0
	for(let item of gbl.basket) {
		total += parseFloat(item.cost);
		}
	x += `<tr><td colspan=4><div class="line"/></td></tr>`;
	x += `<tr><td colspan=3 class=promptCell>Total :</td><td align=right>${gbl.cur}${total.toFixed(2)}</td></tr>`;
	x += `<tr><td colspan=4><div class="line"/></td></tr>`;
	x += "<tr><td colspan=4 align=right>"+btn("place_order()","Place Order & Pay >>>","Please this order & pay")+"</td></tr>";
	elm.basketSpace.innerHTML = x+"</table>"
}



function myAccount()
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";
	callApi("users/details",(ret,reply) => {
		if (!ret) {
			let msg="Error in etting your data";
			if ("error" in reply) msg = reply["error"];
			goSearch();
			return errMsg(msg,document.searchForm.search);
			}
		if ("user" in reply) ctx.user = reply.user; else delete ctx.user;
		elm.userSpace.innerHTML = userDetails();
		});
}

function NSkeyDown(event,idx) {
	if (event.key=="Escape") return hidePopUp();
	if (event.key=="Enter") return doAddNS(idx);
	}
function DSkeyDown(event,idx) {
	if (event.key=="Escape") return hidePopUp();
	if (event.key=="Enter") return doAddDS(idx);
	}

function doAddNS(idx)
{
	let e = document.getElementById("inputNS");
	if (!fqdnCheck.test(e.value)) {
		errMsg("Invalid host name",document.getElementById("AddNSPopup"));
		e.focus(); return; }

	hidePopUp();

	let dom = ctx.domains[idx];

	let ns = dom.name_servers.split(",");
	if (!ns.find(data => { return (data == e.value); })) {
		if (dom.name_servers=="") dom.name_servers = e.value;
		else dom.name_servers += ","+e.value;
		dom.unsaved = true;
		domain_settings(idx);
		}
	else {
		errMsg("Name server already present",document.getElementById("AddNSPopup"));
		e.focus(); return; }
}


function validate_ds_rec(ds_rec)
{
	return true;
}

function doAddDS(idx)
{
	let e = document.getElementById("inputDS");
	if (!validate_ds_rec(e.value)) {
		errMsg("Invalid DS Record",document.getElementById("AddDSPopup"));
		e.focus(); return; }

	hidePopUp();

	let dom = ctx.domains[idx];
	let ds = dom.ds_recs.split(",");
	if (!ds.find(data => { return (data == e.value); })) {
		if (dom.ds_recs=="") dom.ds_recs = e.value;
		else dom.ds_recs += ","+e.value;
		dom.unsaved = true;
		domain_settings(idx);
		}
	else {
		errMsg("DS already present",document.getElementById("AddDSPopup"));
		e.focus(); return; }
}



function do_change_ns(dest_dom,src_dom)
{
	let default_dns_servers = policy("default_dns_servers",null);
	let dom = ctx.domains[dest_dom];
	if ((src_dom >= 0)&&(src_dom < ctx.domains.length)
		&&(dom.name_servers != ctx.domains[src_dom].name_servers))
		{
		dom.name_servers = ctx.domains[src_dom].name_servers;
		dom.unsaved = true;
		}
	else if ((src_dom==-1)&&(default_dns_servers)
		&&(dom.name_servers!=default_dns_servers))
		{
		dom.name_servers = default_dns_servers;
		dom.unsaved = true;
		}

	hidePopUp();
	domain_settings(dest_dom);
}


function generic_popup_btn(config)
{
	/* config: width, style, title, name, label, internal(), param */
	let style_width="",pop_style="";
	if ("width" in config) style_width = `style='width: ${config["width"]}px;'`;
	if ("style" in config) pop_style = `style='${config["style"]}'`;

	let x = `<div class="popup">`;
	x += `<span ${style_width}75px;' tabindex=0 title="${config["title"]}" `;
	x += `class=myBtn onClick="togglePopUp('${config["name"]}',30000);">${config["label"]}</span>`;
	x += `<span class="popuptext" ${pop_style} id="${config["name"]}">`;
	x += config["internal"](config["param"]);
	return x + `</span></div>`;
}



function copy_btn_internal(param)
{
	let default_dns_servers = policy("default_dns_servers",null);
	let seen_ns = { };
	if (default_dns_servers) seen_ns[default_dns_servers] = true;
	let idx=param["idx"];
	seen_ns[ctx.domains[idx].name_servers] = true;

	let x = '<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>';
	x += `<tr class=dataRow onClick='do_change_ns(${idx},-1);'><td>Our NS</td></tr>`;

	for(let dom_loop in ctx.domains) {
		let dom = ctx.domains[dom_loop];
		if (!seen_ns[dom.name_servers]) {
			x += `<tr class=dataRow onClick='do_change_ns(${idx},${dom_loop});'><td>Copy ${dom.display_name}</td></tr>`;
			seen_ns[dom.name_servers] = true;
			}
		}

	return x + "</table>";
}



function add_copy_btn(idx)
{
	return generic_popup_btn({
		"name": "CopyNSPopup",
		"label": "Copy NS",
		"width": 75,
		"style": "overflow: auto; max-height: 250px; margin-left: -120;",
		"title": "Copy the NS records from elsewhere",
		"internal": copy_btn_internal,
		"param": {"idx":idx}
		});
}



function inside_ns(param)
{
	let idx = param["idx"];
	let x = "<table>" + settings_prompt(`Enter NS`);
	x += `<input id=inputNS onkeydown="NSkeyDown(event,${idx});" size=40></td>`;
	x += `<td><input type=button style='width: 110px;' onClick="doAddNS(${idx});" class=myBtn value="Add"></td>`;
	return x+"</tr></table>";
}

function inside_ds(param)
{
	let idx = param["idx"];
	let x = "<table>" + settings_prompt(`Enter DS`);
	x += `<input id=inputDS onkeydown="DSkeyDown(event,${idx});" size=40></td>`;
	x += `<td><input type=button style='width: 110px;' onClick="doAddDS(${idx});" class=myBtn value="Add"></td>`;
	return x+"</tr></table>";
}


function add_rec_type_btn(rec_type,idx,inside_func)
{
	return generic_popup_btn({
		"name": `Add${rec_type}Popup`,
		"label": `Add ${rec_type}`,
		"width": 75,
		"title": `Add a ${rec_type} record`,
		"internal": inside_func,
		"param": {"idx":idx}
		});
}



function saveDomDetails(idx)
{
	let dom = ctx.domains[idx];
	callApi("domain/update",(ret,reply) => {
		if (ret) {
			delete dom.unsaved;
			myDomains(idx);
			}
		else {
			let e = document.getElementById("saveButton");
			if (e) {
				let msg = "Domain save failed";
				if ("error" in reply) msg = reply["error"];
				errMsg(msg,e);
				}
			}
		}, { json: dom });
}



function removeNS(idx,ns_name)
{
	let dom = ctx.domains[idx];
	let ns = dom.name_servers.split(",");

	function find_ns() {
		for(let i in ns) {
			if (ns[i]==ns_name) return i;
			}
		return null;
		}
	let pos = find_ns()
	if (!pos) {
		errMsg("Name server not found",document.getElementById("AddNSPopup"));
		return; }
	ns.splice(pos,1);
	dom.name_servers = ns.join(",");
	dom.unsaved = true;
	domain_settings(idx);
}



function removeDS(idx,ds_data)
{
	let dom = ctx.domains[idx];
	let ns = dom.ds_recs.split(",");

	function find_ds() {
		for(let i in ds) {
			if (ds[i]==ds_data) return i;
			}
		return null;
		}
	let pos = find_ds()
	if (!pos) {
		errMsg("DS Record not found",document.getElementById("AddDSPopup"));
		return; }
	ds.splice(pos,1);
	dom.ds_recs = ds.join(",");
	dom.unsaved = true;
	domain_settings(idx);
}



function domain_transfer_options(idx)
{
	let dom = ctx.domains[idx];

	let x="<table width=75% align=center border=0>";
	x += `<tr><td title="${dom.name}" class=pageHeading>Domain Transfer Options For - ${dom.display_name}</td></tr>`;
	x += "<tr><td><div style='height: 50px;'></div></td></tr>";

	x += settings_header(`Get AuthCode`,true);
	x += "<table width=100% border=0><colgroup><col width=100%/><col/></colgroup>";
	x += "<tr><td>Click to get the transfer AuthCode for this domain</td></tr>";
	x += "<tr><Td><div id='showAuthCode'></div></td>";
	x += "<td align=right>"+btn(`getAuthCode(${idx})`,"Get AuthCode","Get the transfer AuthCode for this domain",110)+"</td>";
	x += "</tr></table>";
	x += "</td></tr>";

	x += settings_header("Push / Gift Domain");
	x += "<table width=100% border=0><colgroup><col width=100%/><col/></colgroup>";
	x += "<tr><td>Push or Gift this domain to another user at this registrar.<p>"
	x += "To transfer the domain to a user in a different registrar,<br>you need to give them the AuthCode "
	x += "and they need<br>to request the transfer from their registrar.</td></tr>";
	x += "<tr><td>Destination E-Mail : <input id='giftDomainDest' style='width: 300px;'></td>";
	x += "<td align=right>"+btn(`giftDomain(${idx})`,"Send Domain","Send this domain to another user",110)+"</td>";
	x += "</tr></table>";
	x += "</td></tr>";
	elm.userSpace.innerHTML = x+gbl.settings_spacer+"</table>";
}



function domain_settings(idx)
{
	let dom = ctx.domains[idx];

	let x="<table width=75% align=center border=0>";
	x += `<tr><td title="${dom.name}" class=pageHeading>Domain Settings For - ${dom.display_name}</td></tr>`;
	x += "<tr><td><div style='height: 50px;'></div></td></tr>";
	x += settings_header(`Change Domain Records`,true);
	x += "<table width=100%><colgroup><col width=30%/><col/></colgroup>";

	x += "<tr><td class=promptCell>Name Servers : </td><td>";
	if (dom.name_servers != "") {
		ns = dom.name_servers.split(",").sort();
		for(let i in ns)
			x += `<a title="Remove this NS" onClick="removeNS(${idx},'${ns[i]}');" href=#>&nbsp;${gbl.bin}&nbsp;</a>${ns[i]}<br>`;
		}
	x += "</td></tr>";
	x += "<tr><td class=promptCell>DS Records : </td><td>";
	if (dom.ds_recs != "") {
		ds = dom.ds_recs.split(",").sort();
		for(let i in ds)
			x += `<a title="Remove this DS" onClick="removeDS(${idx},'${ds[i]}');" href=#>&nbsp;${gbl.bin}&nbsp;</a>${ds[i]}<br>`;
		}
	x += "</td></tr>";
	x += "<tr><td align=left>"
	x += add_copy_btn(idx);
	x += "</td><td align=right>"
	x += add_rec_type_btn("NS",idx,inside_ns);
	x += add_rec_type_btn("DS",idx,inside_ds);

	if ("unsaved" in dom)
		x += `&nbsp;<input style='width: 110px;' onClick='saveDomDetails(${idx});' id="saveButton" type=button class=myBtn value='Save'>`;

	x += "</td></tr>";
	x += "</table></td></tr>";

	elm.userSpace.innerHTML = x+gbl.settings_spacer+"</table>";
}



function giftDomain(idx)
{
	let e = document.getElementById("giftDomainDest");
	let dom = ctx.domains[idx];

	if (!valid_email.test(e.value)) {
		errMsg("Invalid email address",e);
		e.focus();
		return;
		}

	dom["dest_email"] = e.value;
	callApi("domain/gift",(ok, reply) => {
		if (ok) {
			errMsg(gbl.tick+" Domain gifted",elm.userInfo);
			myDomains();
			}
		else {
			let msg = "Domain gifting failed";
			if ("error" in reply) msg = reply["error"];
			errMsg(msg,e);
			e.focus();
			}
		}, { json: dom });
}



function hideAuthCode()
{
	let e = document.getElementById("showAuthCode");
	if (e) e.innerHTML = "";
}


function copyToClip(data)
{
	let ac = document.getElementById("editAuthCode");
	navigator.clipboard.writeText(data).then(
		() => {
			errMsg("AuthCode copied to clipboard",ac)
			let e = document.getElementById("showAuthCode");
			if (e) e.innerHTML = "";
			},
		() => errMsg("Copy to clipboard failed",ac)
		);

	return false;
}


function getAuthCode(idx)
{
	let dom = ctx.domains[idx];
	let e = document.getElementById("showAuthCode");

	function show_auth_code(code) {
		dom.authcode = code;
		let x = `<input id="editAuthCode" style="width: 250px;" value="${code}">`;
		x += `<a href=# onClick="copyToClip('${code}');">&nbsp;${gbl.copy}</a>`;

		e.innerHTML = x;
		setTimeout(hideAuthCode,10000);
		let ac = document.getElementById("editAuthCode");
		if (ac) { ac.focus(); ac.select(); }
		}

	if ((e)&&(e.innerHTML!="")) { e.innerHTML = ""; return; }
	if (dom.authcode) return show_auth_code(dom.authcode);

	callApi("domain/authcode",(ok, reply) => {
		if ((ok)&&("auth_code" in reply)) {
			show_auth_code(reply["auth_code"]);
			}
		else {
			msg = "Get AuthCode failed";
			if ("error" in reply) msg=reply["error"];
			errMsg(msg,e);
			}
		}, { json: dom });
}



function one_domain_html(idx)
{
	let dom = ctx.domains[idx];
	let auto_renew = gbl.cross;
	if (ctx.user.auto_renew_all) auto_renew = gbl.tick + " by account";
	else if (dom.auto_renew) auto_renew = gbl.tick;

	let x = "<table align=center width=50% border=0>";

	x += "<tr><td colspan=4 class=btmBtnBar>"
		+btn(`buy_one_name('${dom.name}','renew')`,`Renew`,"Renew this domain",100)
		+btn(`domain_transfer_options('${idx}')`,"Transfer",`Options for transferring this domain to another owner`,100)
		+btn(`domain_settings('${idx}')`,"Settings",`Edit the settings for ${dom.display_name}`,100)

	x += "</td></tr>";
	x += "<tr><td colspan=4>"+gbl.gap+"</td></tr>";
	let puny = "";
	let ns = dom.name_servers.toLowerCase().split(",").sort().join("<br>")
	let ds = dom.ds_recs.toLowerCase().split(",").sort().join("<br>")
	if (dom.display_name != dom.name) puny = `&nbsp;&nbsp;<span class=searchRenew>${dom.name}</span>`;
	x += `<tr title="${dom.name}"><td class=promptCell>Name :</td><td class=dataCell>${dom.display_name}${puny}</td></tr>`;
	x += `<tr><td class=promptCell>Expiry Date :</td><td class=dataCell>${dom.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Create Date :</td><td class=dataCell>${dom.created_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${dom.amended_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Name Servers :</td><td class=dataCell>${ns}</td></tr>`;
	x += `<tr><td class=promptCell>DS Records :</td><td class=dataCell>${ds}</td></tr>`;
	x += `<tr><td class=promptCell>Auto Renew :</td><td class=dataCell>${auto_renew}</td></tr>`;
	return x + "</table>";
}



function show_one_domain(idx)
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = one_domain_html(idx);
}



function unerrMsg()
{
	let t1 = elm.myMsgPop.innerHTML;
	let t2 = ctx.lastErrMsg;
	if (t2 == null) t2 = "";
	if (t1 == t2) elm.myMsgPop.className = "msgPop msgPopNo";
	delete ctx.lastErrMsg;
	if ("err_msg_tout" in ctx) clearTimeout(ctx.err_msg_tout);
	delete ctx.err_msg_tout;
}



function errMsg(txt,elem)
{
	if (!elem) elem = elm.userInfo;

	let m = elm.myMsgPop;
	m.style.width = "auto";
	if (txt.substr(0,1)!="&") txt = gbl.warn + " " + txt;
	m.innerHTML = "&nbsp;"+txt+"&nbsp;";

	let p_box = elem.getBoundingClientRect();
	let m_box = m.getBoundingClientRect();
	let m_width = m_box.width;

	if (m_box.width < p_box.width) {
		m.style.width = p_box.width + "px";
		m_width = p_box.width;
		}
	let centre = p_box.x + (p_box.width/2);
	let x_pos = centre - (m_width / 2)
	m.style.left = x_pos + "px";
	m.style.top = p_box.y + p_box.height + "px";

	m.className = 'msgPop msgPopYes';
	ctx.lastErrMsg = m.innerHTML;
	ctx.err_msg_tout = setTimeout(unerrMsg,2500);
}




</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<colgroup><col width=70%/><col/></colgroup>
<tr>
<td align=left><span id="businessName" class="businessName">Registrar</span></td>
<td align=right>

<span style="display: none;" id="noLoginBtns">

<div class="popup">
<span style='width: 75px;' tabindex=0 title="Register me" class=myBtn onClick="toggleRegister(); return false;">Register</span>
<span class="popuptext" id="registerPopup">
<form onSubmit='doRegister(); return false;' method=submit action='#' name=formRegister><table>
<tr onClick="toggleRegister();"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Name:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="name">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="confirm">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleRegister();">Cancel</span>
		<input style='width: 110px;' tabindex=0 type=submit title="Register" class=myBtn value="Register">
	</td>
</tr></form></table>
</span></div>


<div class="popup">
<span style='width: 75px;' tabindex=0 title="Get me logged in" class=myBtn onClick="toggleLogin(); return false;">Login</span>
<span class="popuptext" id="loginPopup">
	<table>
		<form onSubmit='return doLogin();' action="#" method=post name=formLogin>
		<tr onClick="toggleLogin()"><Td colspan=2><div style="height: 15px;"></div></td></tr>
			<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
			<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
		<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
		<tr>
			<td class=btmBtnBar colspan=2>
				<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleLogin()">Cancel</span>
				<input style='width: 110px;' tabindex=0 type=submit title="Login" class=myBtn value="OK">
			</td>
		</tr>
		</form>
	</table>
</span>
</div>
</span>

<span style="display:none;" id="isLoggedIn">
	<span style='width: 75px;' tabindex=0 title="List my domains" id="myDomainsBtn" class=myBtn onClick="return myDomains();">Domains</span>
	<span style='width: 75px;' tabindex=0 title="My account details" id="myAccountBtn" class=myBtn onClick="myAccount(); return false;">Account</span>
	<span style='width: 75px;' tabindex=0 title="Log me out" class=myBtn onClick="doLogOut(); return false;">Logout</span>
</span>
</td></tr>
</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 85px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
<span style='width: 85px;' tabindex=0 title="Domain name search" class=myBtn onClick="goSearch();">Search</span>
<span id=marketPlaceBtn style='width: 85px;' tabindex=0 title="Go to the domain market place" class=myBtn onClick="goMarketPlace();">Marketplace</span>
</div>
</td>

<td align=right><table width=100% border=0>
<colgroup><col width=20%/><col width=20%/><col width=60%/></colgroup>
<tr><td><span id="errorSpan">&nbsp;</span></td>
<td align=center><span id="basketIcon" style="display: none;" class="popup">
<span class=userIcons title="You have items waiting to checkout" ${style} onClick='togglePopUp("basketPopup",30000);'>&#128722;</span>
<span style="margin-left: -250px;" class="popuptext" id="basketPopup">
</span></span></td><td align=center><span id="userInfo"></span></td></tr></table></td>
</tr></table>
</div>

<div id="allBottom">
	<div style='height: 30px;'></div>
	<div id="search">
		<div style='height: 30px;'></div>
		<table align=center width=40% border=0>
		<form action="#" name=searchForm onSubmit="return doSearch();">
			<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox name=search></td></tr>
		</form>
			<tr><td><div id="output"></div></td></tr>
		</table>
	</div>
	<span class="botSapce" id="userSpace" style="display: none;"></span>
	<span class="botSapce" id="basketSpace" style="display: none;"></span>
	<span class="botSapce" id="marketPlace" style="display: none;"></span>
</div>

<div><table><tr><td><div id=myMsgPop class='msgPop msgPopNo'></div></td></tr></table></div>
</body>
</html>
