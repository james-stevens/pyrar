<html>
<head>
    <title>Python Registrar</title>
    <meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = true;


gbl = {
	"theme": window.localStorage.getItem("theme"),

    tick: "&#x2611;",
    cross: "&#x2612;",
    timer: "&#x23f3;",
    bin: "&#x2702;",
    warn: "&#x26a0;",
    page: "&#x1F5CE;",
    nsec: "&#x1F512;",
    nsec3: "&#x1F510;",
    clip: "&#x1F4CE;",

    cur: "$",
    cur_iso: "USD",

    gap: "<div style='height: 7px;'></div>",

    def_max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="dark";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);


gbl.head = document.head || document.getElementsByTagName('head')[0];

function changeFavicon(src) {
	var link = document.createElement('link'),
		oldLink = document.getElementById('dynamic-favicon');

	link.id = 'dynamic-favicon';
	link.rel = 'shortcut icon';
	link.href = src;
	if (oldLink) gbl.head.removeChild(oldLink);
	gbl.head.appendChild(link);
	}


function toggleLogin() {
    var popup = document.getElementById("loginPopup");
    popup.classList.toggle("show");
    for(x of popup.classList)
        if (x == "show") {
            let e = document.formLogin.username;
            e.focus(); e.select();
            }
}


function toggleRegister() {
    var popup = document.getElementById("registerPopup");
    popup.classList.toggle("show");
    for(x of popup.classList)
        if (x == "show") {
            let e = document.formRegister.username;
            e.focus(); e.select();
            }
}


function bodyLoaded()
{
	gbl.elm = {};
	["topSpan","searchForm","businessName"].forEach(i => { gbl.elm[i] = document.getElementById(i); } );

	callApi("config",(ret,data) => {
		if (ret) {
			gbl.config = data;
			gbl.config.ok_tlds = {};
			for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;

			let my_icon = policy("icon",null);
			let site_name = policy("business_name","Registrar");
			document.title = site_name;
			if (my_icon) {
				changeFavicon("/"+my_icon)
				gbl.elm.businessName.innerHTML = `<img height=32 style="vertical-align:bottom" src="/${my_icon}">&nbsp;${site_name}`;
				}
			else gbl.elm.businessName.innerHTML = site_name;

			gbl.cur = policy("currency_symbol","$");
			gbl.cur_iso = policy("currency_iso","USD");
			}
		});
}


/*
function fromIDN()
{
	let f = document.form1;
	f.puny.value = toASCII(f.idn.value);
	f.idn.value = "";
}



function fromPuny()
{
	let f = document.form1;
	f.idn.value = toUnicode(f.puny.value);
	f.puny.value = "";
}
*/


function one_search_line(item,block_not_avail)
{
	if ((block_not_avail)&&(!item.avail)) return "";

	let x = "<tr>";
	x += `<td><span class=searchDomain>${fromPuny(item.name)}`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${gbl.cur}${item.renew}</span>`;
	x += "</td>";

	if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td align=right>";
			x += btn(`buyOneName('${item.name}')`,`<b>BUY ${gbl.cur}${item.create}</b>`,`Buy '${item.name}' for ${gbl.cur}${item.create}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(ret,data)
{
	let is_multi_search = (("search" in ctx)&&("todo" in ctx.search));
	let e = document.getElementById("output");

	if ((!ret)&&("error" in data)) { errMsg(data.error,document.searchForm.search); return; }

	for(let item of data) ctx.search.result += one_search_line(item,is_multi_search);
	e.innerHTML = "<table width=100%>" + ctx.search.result + "</table>";

	if (is_multi_search) {
		if (ctx.search.todo.length <= 0) delete ctx.search.todo; else searchNext();
		}
	else {
		ctx.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buyOneName(name)
{
	callApi("domain/check",(ret,data) => {

		let item = data.shift();
		let e = document.getElementById("output");
		e.innerHTML = `<h2>Buy '${item.name}' for ${gbl.cur}${item.create}</h2>`;

		}, { json: { "domain" : name }}); 
}



function searchNext()
{
	let first = ctx.search.todo.shift();
	let srch = [ ctx.search.term + "." + first.name ];

	let max = gbl.def_max_checks;

	if ((first.provider in gbl.config.providers)&&("max_checks" in gbl.config.providers[first.provider]))
		max = gbl.config.providers[first.provider].max_checks;

	while((ctx.search.todo.length > 0)&&(srch.length < max)&&(first.provider == ctx.search.todo[0].provider)) {
		let nxt = ctx.search.todo.shift();
		srch.push(ctx.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}




function multiSearch(srch,not_me_tld)
{
	ctx.search.todo = [];
	ctx.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) ctx.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
    function do_end() {
		f.search.focus();
		f.search.select();
		return false;
    	}

    delete ctx.search;

	let e = document.getElementById("output");
	e.innerHTML = "";

    ctx.search = {};
	ctx.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

    f = document.searchForm;
    let srch = toASCII(f.search.value);

    if (srch.indexOf(".") >= 0) {
		if (!fqdnCheck.test(srch)) {
			errMsg("Invald domain name",document.searchForm.search);
			return do_end(); }

		if (!supported_tld(srch)) {
			errMsg("Not a supported TLD",document.searchForm.search);
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		errMsg("Invald domain name",document.searchForm.search);
	else
		multiSearch(srch,null);

	return do_end();
}




function unerrMsg()
{
    let m = document.getElementById("myMsgPop");
    let t1 = m.innerHTML;
    let t2 = ctx.lastErrMsg;
    if (t2 == null) t2 = "";
    if (t1 == t2) m.className = "msgPop msgPopNo";
    delete ctx.lastErrMsg;
}



function errMsg(txt,elem,min_width)
{
    let m = document.getElementById("myMsgPop");

	if (elem) {
		let box = elem.getBoundingClientRect();
		m.style.top = box.y + box.height + "px";
		m.style.left = box.x + "px";
		if (!min_width) min_width = box.width - 10;
		m.style.minWidth = min_width + "px";
		m.style.width = min_width + "px";
		console.log(box);
		}

    m.className = 'msgPop msgPopYes';
    m.innerHTML = `${gbl.warn} ${txt}`;
    ctx.lastErrMsg = m.innerHTML;
    setTimeout(unerrMsg,2500);
}




</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% style="margin-top: 30px;">
<tr>
<td align=left><span id="businessName" class="businessName">Registrar</span></td>
<td align=right><span id="noLoginBtns">

<div class="popup">
<span style='width: 75px;' tabindex=0 title="Register me" class=myBtn onClick="toggleRegister(); return false;">Register</span>
<span class="popuptext" id="registerPopup">
<form onSubmit='return doRegister();' method=submit action='#' name=formRegister><table>
<tr onClick="toggleRegister();"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input size=30 name="username">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input size=30 name="password">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input size=30 name="password">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleRegister();">Cancel</span>
		<span style='width: 75px;' tabindex=0 title="Register" class=myBtn onClick="doRegister();">OK</span>
	</td>
</tr></form></table>
</span></div>


<div class="popup">
<span style='width: 75px;' tabindex=0 title="Get me logged in" class=myBtn onClick="toggleLogin(); return false;">Login</span>
<span class="popuptext" id="loginPopup">
<form onSubmit='return doLogin();' method=submit action='#' name=formLogin><table>
<tr onClick="toggleLogin()"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input size=30 name="username">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input size=30 name="password">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleLogin()">Cancel</span>
		<span style='width: 75px;' tabindex=0 title="Login" class=myBtn onClick="doLogin(); return false;">OK</span>
	</td>
</tr></form>
</table>
</span></td></tr></table>
</td></tr></table>

</div>

<div id="searchForm">
<table align=center>
<form action="#" name=searchForm onSubmit="return doSearch();">
<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox name=search size=40></td></tr>
</form>
<tr><td><div id="output"></div></div></td></tr>
</table>

<div id=myMsgPop class='msgPop msgPopNo'></div>

</body>
</html>
