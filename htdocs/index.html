<html>
<head>
	<title>Python Registrar</title>
	<meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = true;


gbl = {
	"theme": window.localStorage.getItem("theme"),

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	bin: "&#x2702;",
	warn: "&#x26a0;",
	page: "&#x1F5CE;",
	nsec: "&#x1F512;",
	nsec3: "&#x1F510;",
	clip: "&#x1F4CE;",
	cart: "&#128722;",
	email: "&#128231;",

	cur: "$",
	cur_iso: "USD",

	gap: "<div style='height: 7px;'></div>",

	def_max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="default";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);


gbl.head = document.head || document.getElementsByTagName('head')[0];

function keyEsc(e) {
    if (e.key == "Escape") {
    	hideAllPopUp();
    	unerrMsg();
		if (gbl.elm.search.style.display != "none") document.searchForm.search.focus();
    	}
}


function hideAllPopUp()
{
	hidePopUp();
	["loginPopup","registerPopup","themePopup"].forEach(item => {
		let popup = document.getElementById(item);
		popup.classList.remove("show")
		});
}


function changeFavicon(src) {
	var link = document.createElement('link'),
		oldLink = document.getElementById('dynamic-favicon');

	link.id = 'dynamic-favicon';
	link.rel = 'shortcut icon';
	link.href = src;
	if (oldLink) gbl.head.removeChild(oldLink);
	gbl.head.appendChild(link);
	}



popup_lazy_hide = popup_lazy_name = null;
function clr_lazy_hide()
{
	if (!popup_lazy_hide) return;
	clearTimeout(popup_lazy_hide);
	popup_lazy_hide = popup_lazy_name = null;
}


function togglePopUp(name,tmout)
{
	clr_lazy_hide();
	let popup = document.getElementById(name);
	if (!popup.classList.toggle("show")) {
		unerrMsg();
		return;
		}

	popup_lazy_hide = setTimeout(hidePopUp,tmout);
	popup_lazy_name = name;

	let e = null;
	if (name=="loginPopup") e = document.formLogin.email;
	if (name=="registerPopup") e = document.formRegister.email;
	if (e) { e.focus(); e.select(); }
}



function hidePopUp()
{
	if (!popup_lazy_hide) return;
	let popup = document.getElementById(popup_lazy_name);
	popup.classList.remove("show")
	clr_lazy_hide();
}



function do_theme_change(value)
{
	clr_lazy_hide();
	if (value in theme_colours) changeTheme(value);
	let popup = document.getElementById("themePopup");
	popup.classList.remove("show")
	if (gbl.elm.search.style.display != "none") document.searchForm.search.focus();
}


function toggleLogin() { togglePopUp("loginPopup",30000); }
function toggleRegister() { togglePopUp("registerPopup",30000); }
function toggleTheme() { togglePopUp("themePopup",5000); }


function goSearch()
{
	gbl.elm.userSpace.style.display = "none";
	gbl.elm.search.style.display = "block";
	document.searchForm.search.focus();
}


function loggedIn()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "none";
	e = document.getElementById("isLoggedIn");
	e.style.display = "block";

	if (("user" in ctx)&&("name" in ctx.user)) {
		let e = document.getElementById("userInfo");

		let x = "",style="class=userIcons";
		if (! ctx.user.email_verified)
			x += `<span title="E-Mail address not yet verified" ${style}>${gbl.email}</span>`;

		x += `<span title="You have items waiting to checkout" ${style}>${gbl.cart}</span>`;

		x += `<span style='margin-right: 10px;'></span>`;
		x += `Logged in as: <b>${ctx.user.name}</b>`;
		e.innerHTML = x;
		}
}



function doRegister()
{
	function regErr(err,item)
	{
		errMsg(err,document.getElementById("registerPopup"));
		clr_lazy_hide();
		item.focus();
	}

	let f = document.formRegister;

	if (f.password.value != f.confirm.value) return regErr("Passwords do not match",f.password);
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",f.email);

	data = {
		"name":f.name.value,
		"email":f.email.value,
		"password":f.password.value
		};

	callApi("users/register",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (gbl.elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";
		f.confirm.value = "";
		f.name.value = "";

		}, { json: data });
}


function doLogin()
{
	function regErr(err,item)
	{
		errMsg(err,document.getElementById("loginPopup"));
		clr_lazy_hide();
		item.focus();
		return false;
	}

	let f = document.formLogin;
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",f.email);

	data = { "email":f.email.value, "password":f.password.value };

	callApi("users/login",(ret,reply) => {
		if (!ret) {
			let msg="Error logging in";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (gbl.elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";

		}, { json: data });

	return false;
}



function doLogOut()
{
	callApi("users/logout",(ret,reply) => {});
	gbl.elm.userSpace.style.display = "none";
	gbl.elm.search.style.display = "block";
	document.searchForm.search.focus();
}



function loggedOut()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "block";
	e = document.getElementById("isLoggedIn");
	e.style.display = "none";
	e = document.getElementById("userInfo");
	e.innerHTML = "";
}



function bodyLoaded()
{
	gbl.elm = {};
	["userSpace","output","topSpan","search","businessName"].forEach(i => {
		gbl.elm[i] = document.getElementById(i);
		} );

	callApi("config",(ret,reply) => {
		if (!ret) {
			let msg = "Error contacting servers";
			if ("error" in reply) msg = reply["error"];
			return errMsg(msg,document.searchForm.search);
			}

		gbl.config = reply;
		gbl.config.ok_tlds = {};
		for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;

		let my_icon = policy("icon",null);
		let site_name = policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			gbl.elm.businessName.innerHTML = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		else gbl.elm.businessName.innerHTML = site_name;

		gbl.cur = policy("currency_symbol","$");
		gbl.cur_iso = policy("currency_iso","USD");

		if ("session" in ctx) {
			callApi("users/details",(ret,reply) => {
				if (ret) {
					if ("user" in reply) ctx.user = reply.user;
					if ("domains" in reply) ctx.domains = reply.domains;
					loggedIn();
					}
				});
			} else { loggedOut(); }
		});
}


function one_search_line(item,block_not_avail)
{
	if ((block_not_avail)&&(!item.avail)) return "";

	let x = "<tr>";
	x += `<td><span title="${item.name}" class=searchDomain>${fromPuny(item.name)}</span>`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${gbl.cur}${item.renew}</span>`;
	x += "</td>";

	if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td align=right>";
			x += btn(`buyOneName('${item.name}')`,`<b>BUY ${gbl.cur}${item.create}</b>`,`Buy '${item.name}' for ${gbl.cur}${item.create}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(ret,data)
{
	let is_multi_search = (("search" in ctx)&&("todo" in ctx.search));

	if ((!ret)&&("error" in data)) { errMsg(data.error,document.searchForm.search); return; }

	for(let item of data) ctx.search.result += one_search_line(item,is_multi_search);
	gbl.elm.output.innerHTML = "<table width=100%>" + ctx.search.result + "</table>";

	if (is_multi_search) {
		if (ctx.search.todo.length <= 0) delete ctx.search.todo; else searchNext();
		}
	else {
		ctx.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buyOneName(name)
{
	callApi("domain/check",(ret,data) => {

		let item = data.shift();
		gbl.elm.output.innerHTML = `<h2>Buy '${item.name}' for ${gbl.cur}${item.create}</h2>`;

		}, { json: { "domain" : name }});
}



function searchNext()
{
	let first = ctx.search.todo.shift();
	let srch = [ ctx.search.term + "." + first.name ];

	let max = gbl.def_max_checks;

	if ((first.provider in gbl.config.providers)&&("max_checks" in gbl.config.providers[first.provider]))
		max = gbl.config.providers[first.provider].max_checks;

	while((ctx.search.todo.length > 0)&&(srch.length < max)&&(first.provider == ctx.search.todo[0].provider)) {
		let nxt = ctx.search.todo.shift();
		srch.push(ctx.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}



function multiSearch(srch,not_me_tld)
{
	ctx.search.todo = [];
	ctx.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) ctx.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
	function do_end() {
		f.search.focus();
		f.search.select();
		return false;
		}

	delete ctx.search;

	gbl.elm.output.innerHTML = "";

	ctx.search = {};
	ctx.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

	f = document.searchForm;
	let srch = toASCII(f.search.value);

	if (srch.indexOf(".") >= 0) {
		if (!fqdnCheck.test(srch)) {
			errMsg("Invald domain name",document.searchForm.search);
			return do_end(); }

		if (!supported_tld(srch)) {
			errMsg("Not a supported TLD",document.searchForm.search);
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		errMsg("Invald domain name",document.searchForm.search);
	else
		multiSearch(srch,null);

	return do_end();
}


function userDomainList()
{
	let x = "<table width=100% border=0>";
	x += "<tr><th>Domain Name</th><th>Expiry Date</th><th>Name Servers</th></tr>";
	if (ctx.domains.length < 30) cls="dataRowBig"; else cls="dataRow";
	for(i in ctx.domains) {
		item = ctx.domains[i];
		x += `<tr onClick="show_one_domain(${i});" class=${cls}><td title="${item.name}">${fromPuny(item.name)}</td>`;
		x += `<td align=center>${item.expiry_dt.split(" ")[0]}</td>`
		x += `<td>${item.name_servers.substr(0,30)}</td>`;
		x += "</tr>";
		}
	return x + "</table>";
}


function myDomains()
{
	gbl.elm.search.style.display = "none";
	gbl.elm.userSpace.style.display = "block";
	gbl.elm.userSpace.innerHTML = "";
	callApi("users/domains",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,document.getElementById("myDomainsBtn"));
			}
		if ("domains" in reply) ctx.domains = reply.domains; else delete ctx.domains;
		gbl.elm.userSpace.innerHTML = userDomainList()
		});
}


function userDetails()
{
	if (ctx.user.email_verified) verified=gbl.tick; else verified=gbl.cross;
	let x = "<table align=center border=0>";
	x += `<tr><td class=promptCell>E-Mail :</td><td class=dataCell>${ctx.user.email}</td></tr>`;
	x += `<tr><td class=promptCell>E-Mail Verified :</td><td class=dataCell>${verified}</td></tr>`;
	x += `<tr><td class=promptCell>Name :</td><td class=dataCell>${ctx.user.name}</td></tr>`;
	x += `<tr><td class=promptCell>Last Login :</td><td class=dataCell>${ctx.user.last_login_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${ctx.user.amended_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Created :</td><td class=dataCell>${ctx.user.created_dt}</td></tr>`;
	return x + "</table>";
}


function myAccount()
{
	gbl.elm.search.style.display = "none";
	gbl.elm.userSpace.style.display = "block";
	gbl.elm.userSpace.innerHTML = "";
	callApi("users/details",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,document.getElementById("myAccountBtn"));
			}
		if ("user" in reply) ctx.user = reply.user; else delete ctx.user;
		gbl.elm.userSpace.innerHTML = userDetails();
		});
}


function one_domain_html(dom)
{
	let x = "<table align=center border=0>";
	let puny = fromPuny(dom.name);
	if (puny != dom.name) puny = puny + `&nbsp;&nbsp;<span class=searchRenew>${dom.name}</span>`;
	x += `<tr title="${dom.name}"><td class=promptCell>Name :</td><td class=dataCell>${puny}</td></tr>`;
	x += `<tr><td class=promptCell>Expiry Date :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Create Date :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	return x + "</table>";
}


function show_one_domain(idx)
{
	gbl.elm.search.style.display = "none";
	gbl.elm.userSpace.style.display = "block";
	gbl.elm.userSpace.innerHTML = one_domain_html(ctx.domains[idx]);
}



function unerrMsg()
{
	let m = document.getElementById("myMsgPop");
	let t1 = m.innerHTML;
	let t2 = ctx.lastErrMsg;
	if (t2 == null) t2 = "";
	if (t1 == t2) m.className = "msgPop msgPopNo";
	delete ctx.lastErrMsg;
	if ("err_msg_tout" in ctx) clearTimeout(ctx.err_msg_tout);
	delete ctx.err_msg_tout;
}



function errMsg(txt,elem,min_width)
{
	let m = document.getElementById("myMsgPop");

	if (elem) {
		let box = elem.getBoundingClientRect();
		m.style.top = box.y + box.height + "px";
		m.style.left = box.x + "px";
		if (!min_width) min_width = box.width - 10;
		m.style.minWidth = min_width + "px";
		m.style.width = min_width + "px";
		}

	m.className = 'msgPop msgPopYes';
	m.innerHTML = `${gbl.warn} ${txt}`;
	ctx.lastErrMsg = m.innerHTML;
	ctx.err_msg_tout = setTimeout(unerrMsg,2500);
}




</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<tr>
<td align=left><span id="businessName" class="businessName">Registrar</span></td>
<td align=right>

<span style="display: none;" id="noLoginBtns">

<div class="popup">
<span style='width: 75px;' tabindex=0 title="Register me" class=myBtn onClick="toggleRegister(); return false;">Register</span>
<span class="popuptext" id="registerPopup">
<form onSubmit='doRegister(); return false;' method=submit action='#' name=formRegister><table>
<tr onClick="toggleRegister();"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 name="email">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Name:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 name="name">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 type=password name="password">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 type=password name="confirm">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleRegister();">Cancel</span>
		<input style='width: 110px;' tabindex=0 type=submit title="Register" class=myBtn value="Register">
	</td>
</tr></form></table>
</span></div>


<div class="popup">
<span style='width: 75px;' tabindex=0 title="Get me logged in" class=myBtn onClick="toggleLogin(); return false;">Login</span>
<span class="popuptext" id="loginPopup">
<table>
<form onSubmit='return doLogin();' action="#" method=post name=formLogin>
	<tr onClick="toggleLogin()"><Td colspan=2><div style="height: 15px;"></div></td></tr>
		<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 name="email">&nbsp;</td></tr>
		<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" size=30 type=password name="password">&nbsp;</td></tr>
	<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
	<tr>
		<td class=btmBtnBar colspan=2>
			<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleLogin()">Cancel</span>
			<input style='width: 110px;' tabindex=0 type=submit title="Login" class=myBtn value="OK">
		</td>
	</tr>
</form>
</table>
</span>
</div>
</span>

<span style="display:none;" id="isLoggedIn">
	<span style='width: 75px;' tabindex=0 title="List my domains" id="myDomainsBtn" class=myBtn onClick="myDomains(); return false;">Domains</span>
	<span style='width: 75px;' tabindex=0 title="My account details" id="myAccountBtn" class=myBtn onClick="myAccount(); return false;">Account</span>
	<span style='width: 75px;' tabindex=0 title="Log me out" class=myBtn onClick="doLogOut(); return false;">Logout</span>
</span>
</td></tr>
</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 75px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
<span style='width: 75px;' tabindex=0 title="Domain name search" class=myBtn onClick="goSearch();">Search</span>
</div>

</td>
<td align=right><span id="userInfo"></span></tr></table>
</div>

<div id="allBottom" onClick="hidePopUp();">
	<div style='height: 30px;'></div>
	<div id="search">
		<div style='height: 30px;'></div>
		<table align=center>
		<form action="#" name=searchForm onSubmit="return doSearch();">
		<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox name=search size=40></td></tr>
		</form>
			<tr><td><div id="output"></div></td></tr>
		</table>
	</div>
	<span id="userSpace" style="display: none;"></div>
</div>

<div><table><tr><td><div id=myMsgPop class='msgPop msgPopNo'></div></td></tr></table></div>
</body>
</html>
