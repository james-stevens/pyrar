<html>
<head>
	<title>Python Registrar</title>
	<meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'>.msgPop { visibility: hidden;}</style>
<script language="Javascript">

debugAPI = false;


elm = {};
gbl = {
	"theme": window.localStorage.getItem("theme"),

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	bin: "&#x2702;",
	warn: "&#x26a0;",
	page: "&#x1F5CE;",
	nsec: "&#x1F512;",
	nsec3: "&#x1F510;",
	clip: "&#x1F4CE;",
	cart: "&#128722;",
	email: "&#128231;",

	cur: "$",
	cur_iso: "USD",

	gap: "<div style='height: 7px;'></div>",

	def_max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="default";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);


gbl.head = document.head || document.getElementsByTagName('head')[0];

function keyEsc(e) {
    if (e.key == "Escape") {
    	hideAllPopUp();
    	unerrMsg();
		if (elm.search.style.display != "none") document.searchForm.search.focus();
    	}
}


function hideAllPopUp()
{
	hidePopUp();
	["loginPopup","registerPopup","themePopup"].forEach(item => {
		let popup = document.getElementById(item);
		popup.classList.remove("show")
		});
}


function changeFavicon(src) {
	var link = document.createElement('link'),
		oldLink = document.getElementById('dynamic-favicon');

	link.id = 'dynamic-favicon';
	link.rel = 'shortcut icon';
	link.href = src;
	if (oldLink) gbl.head.removeChild(oldLink);
	gbl.head.appendChild(link);
	}



function clr_lazy_hide()
{
	if (!("popup" in ctx)) return;
	if ("timer" in ctx.popup) clearTimeout(ctx.popup.timer);
	delete ctx.popup;
}


function togglePopUp(name,tmout)
{
	if ("popup" in ctx) {
		let save_name = ctx.popup.name;
		hidePopUp();
		if (save_name==name) { unerrMsg(); return; }
		}

	let popup = document.getElementById(name);
	popup.classList.toggle("show");

	ctx.popup = {
		"timer": setTimeout(hidePopUp,tmout),
		"name": name
		}

	let e = null;
	if (name=="loginPopup") e = document.formLogin.email;
	if (name=="registerPopup") e = document.formRegister.email;
	if (e) { e.focus(); e.select(); }
}



function hidePopUp()
{
	if (!("popup" in ctx)) return;
	let popup = document.getElementById(ctx.popup.name);
	popup.classList.remove("show")
	clr_lazy_hide();
}



function do_theme_change(value)
{
	clr_lazy_hide();
	if (value in theme_colours) changeTheme(value);
	let popup = document.getElementById("themePopup");
	popup.classList.remove("show")
	if (elm.search.style.display != "none") document.searchForm.search.focus();
}


function toggleLogin() { togglePopUp("loginPopup",30000); }
function toggleRegister() { togglePopUp("registerPopup",30000); }
function toggleTheme() { togglePopUp("themePopup",5000); }

function show_one_space(name)
{
	elm.userSpace.style.display = "none";
	elm.marketPlace.style.display = "none";
	elm.search.style.display = "none";
	elm.basketSpace.style.display = "none";
	elm[name].style.display = "block";
}

function goSearch()
{
	show_one_space("search");
	document.searchForm.search.focus();
}


function loggedIn()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "none";
	e = document.getElementById("isLoggedIn");
	e.style.display = "block";
	user_info();
}


function emptyCart()
{
	delete ctx.basket;
	user_info();
	errMsg(`${gbl.bin} basket emptied`,elm.userInfo,350);
	if (elm.basketSpace.style.display == "block") goSearch();
}



function removeBasketItem(i)
{
	if (ctx.basket.length == 1) {
		delete ctx.basket;
		if (elm.basketSpace.style.display == "block") goSearch();
		}
	else ctx.basket.splice(i,1);

	if (("popup" in ctx)&&("name" in ctx.popup)&&(ctx.popup.name=="basketPopup")) {
		clearTimeout(ctx.popup.timer);
		delete ctx.popup.timer;
		}

	user_info()
	if (elm.basketSpace.style.display == "block") basketCheckout();
}



function start_basket_table()
{
	let x = '<tr><th>Domain</th><th>Action</th><th>Yrs</th><th>Cost</th></tr>';
	for(let i in ctx.basket) {
		item = ctx.basket[i];
		x += `<tr onClick="removeBasketItem(${i});" title="Remove this item" class=dataRow>`
		x += `<td>${fromPuny(item.domain)}</td><td align=center>${item.action}</td>`;
		x += `<td align=center>${item.num_years}</td><td align=right>${gbl.cur}${item.cost}</td></tr>`;
		}
	return x;
}



function user_info()
{
	if (ctx.basket) {
		elm.basketIcon.style.display = "block";
		let x = '<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>' + start_basket_table()
		x += `<tr><td colspan=4>${gbl.gap}</td></tr>`;
		x += "<tr><Td class=btmBtnBar colspan=4 align=center>";
		x += "<button style='width: 110px;' onClick='emptyCart();' class=myBtn>Empty</button>";
		x += "<button style='width: 110px;' onClick='basketCheckout();' class=myBtn>Checkout</button></td></tr>";
		x += "</table>";
		elm.basketPopup.innerHTML = x;
		}
	else
		elm.basketIcon.style.display = "none";

	if (("user" in ctx)&&("name" in ctx.user)) {
		let x = "",style="class=userIcons";

		/*
		if (!ctx.user.email_verified)
			x += `<span title="E-Mail address not yet verified" ${style}>${gbl.email}</span>`;
		*/

		elm.userInfo.innerHTML = `Logged in as: <b>${ctx.user.name}</b>`;
		}
}



function doRegister()
{
	let p = document.getElementById("registerPopup");

	function regErr(err,item)
	{
		errMsg(err,p);
		clr_lazy_hide();
		item.focus();
	}

	let f = document.formRegister;

	if (f.password.value != f.confirm.value) return regErr("Passwords do not match",p);
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",p);

	data = {
		"name":f.name.value,
		"email":f.email.value,
		"password":f.password.value
		};

	callApi("users/register",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";
		f.confirm.value = "";
		f.name.value = "";

		}, { json: data });
}


function doLogin()
{
	function regErr(err,item)
	{
		errMsg(err,document.getElementById("loginPopup"));
		clr_lazy_hide();
		item.focus();
		return false;
	}

	let f = document.formLogin;
	if (!valid_email.test(f.email.value)) return regErr("Invalid email address",f.email);

	data = { "email":f.email.value, "password":f.password.value };

	callApi("users/login",(ret,reply) => {
		if (!ret) {
			let msg="Error logging in";
			if ("error" in reply) msg = reply["error"];
			return regErr(msg,f.email);
			}
		hidePopUp();

		if ("user" in reply) ctx.user = reply.user;
		if ("domains" in reply) ctx.domains = reply.domains;

		loggedIn();

		if (elm.search.style.display != "none") document.searchForm.search.focus();

		f.email.value = "";
		f.password.value = "";

		}, { json: data });

	return false;
}



function doLogOut()
{
	delete ctx.user;
	delete ctx.domains;
	callApi("users/logout",(ret,reply) => {});
	show_one_space("search");
	document.searchForm.search.focus();
	loggedOut();
}



function loggedOut()
{
	let e = document.getElementById("noLoginBtns");
	e.style.display = "block";
	e = document.getElementById("isLoggedIn");
	e.style.display = "none";
	elm.userInfo.innerHTML = "";
}



function bodyLoaded()
{
	["myMsgPop","basketIcon","userInfo","marketPlace","basketSpace","basketPopup",
	"userSpace","output","topSpan","search","businessName"].forEach(i => {
		elm[i] = document.getElementById(i);
		} );

	callApi("config",(ret,reply) => {
		if (!ret) {
			let msg = "Error contacting servers";
			if ("error" in reply) msg = reply["error"];
			return errMsg(msg,document.searchForm.search);
			}

		gbl.config = reply;
		gbl.config.ok_tlds = {};
		for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;

		let my_icon = policy("icon",null);
		let site_name = policy("business_name","Registrar");
		document.title = site_name;
		if (my_icon) {
			changeFavicon("/icons/"+my_icon)
			elm.businessName.innerHTML = `<img height=32 style="vertical-align:bottom" src="/icons/${my_icon}">&nbsp;${site_name}`;
			}
		else elm.businessName.innerHTML = site_name;

		gbl.cur = policy("currency_symbol","$");
		gbl.cur_iso = policy("currency_iso","USD");

		if ("session" in ctx) {
			callApi("users/details",(ret,reply) => {
				if (ret) {
					if ("user" in reply) ctx.user = reply.user;
					if ("domains" in reply) ctx.domains = reply.domains;
					loggedIn();
					}
				});
			} else { loggedOut(); }
		});
}


function one_search_line(item,block_not_avail)
{
	if ((block_not_avail)&&(!item.avail)) return "";

	let x = "<tr class=searchDomain>";
	x += `<td><span title="${item.name}">${fromPuny(item.name)}</span>`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${gbl.cur}${item.renew}</span>`;
	x += "</td>";

	if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td style='vertical-align: middle; text-align: right;'>";
			x += btn(`buy_one_name('${item.name}','create')`,`<b>BUY ${gbl.cur}${item.create}</b>`,`Buy '${item.name}' for ${gbl.cur}${item.create}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(ret,data)
{
	let is_multi_search = (("search" in ctx)&&("todo" in ctx.search));

	if ((!ret)&&("error" in data)) { errMsg(data.error,document.searchForm.search); return; }

	for(let item of data) ctx.search.result += one_search_line(item,is_multi_search);
	elm.output.innerHTML = "<table border=0 cellspacing=0 width=100%>" + ctx.search.result + "</table>";

	if (is_multi_search) {
		if (ctx.search.todo.length <= 0) delete ctx.search.todo; else searchNext();
		}
	else {
		ctx.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buy_one_name(domain,action)
{
	let qry = { "domain" : domain, "num_years": 1 }

	if ("basket" in ctx) {
		for(let item of ctx.basket) {
			if ((item.domain==domain)&&(item.action==action))
				qry.num_years = item.num_years + 1;
			}
		}

	callApi("domain/check",(ret,data) => {
		if (!ret) {
			console.log("PRICE ERROR:",data);
			return;
			}

		let found_it = false;
		let dom = data.shift();

		if (!(action in dom)) {
			let msg = "an error occured";
			if ((action+":err") in dom) msg = dom[action+":err"];
			errMsg(msg,elm.basketIcon,450);
			return;
			}

		let new_item = {
			"domain": dom.name,
			"num_years": dom.num_years,
			 "cost": dom[action],
			 "action": action
			 };

		if (!("basket" in ctx)) { ctx.basket = [new_item]; }
		else {
			for(let item of ctx.basket) {
				if ((item.domain==dom.name)&&(item.action==action)) {
					item.num_years = dom.num_years
					item.cost = dom[action];
					found_it = true;
					}
				}
			if (!found_it) ctx.basket.push(new_item);
			}
		user_info();
		togglePopUp("basketPopup",2500);
		}, { json: qry });
}



function searchNext()
{
	let first = ctx.search.todo.shift();
	let srch = [ ctx.search.term + "." + first.name ];

	let max = gbl.def_max_checks;

	if ((first.registry in gbl.config.registry)&&("max_checks" in gbl.config.registry[first.registry]))
		max = gbl.config.registry[first.registry].max_checks;

	while((ctx.search.todo.length > 0)&&(srch.length < max)&&(first.registry == ctx.search.todo[0].registry)) {
		let nxt = ctx.search.todo.shift();
		srch.push(ctx.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}



function multiSearch(srch,not_me_tld)
{
	ctx.search.todo = [];
	ctx.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) ctx.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
	function do_end() {
		f.search.focus();
		f.search.select();
		return false;
		}

	delete ctx.search;

	elm.output.innerHTML = "";

	ctx.search = {};
	ctx.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

	f = document.searchForm;
	let srch = toASCII(f.search.value);

	if (srch.indexOf(".") >= 0) {
		if (!fqdnCheck.test(srch)) {
			errMsg("Invalid domain name",document.searchForm.search);
			return do_end(); }

		if (!supported_tld(srch)) {
			errMsg("Not a supported TLD",document.searchForm.search);
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		errMsg("Invald domain name",document.searchForm.search);
	else
		multiSearch(srch,null);

	return do_end();
}


function userDomainList()
{
	let x = "<table width=100% border=0>";
	x += "<tr><th>Domain Name</th><th>Expiry Date</th><th>Name Servers</th></tr>";
	if (ctx.domains.length < 30) cls="dataRowBig"; else cls="dataRow";
	for(let i in ctx.domains) {
		item = ctx.domains[i];
		x += `<tr onClick="show_one_domain(${i});" class=${cls}><td title="${item.name}">${item.display_name}</td>`;
		x += `<td align=center>${item.expiry_dt.split(" ")[0]}</td>`
		x += `<td>${item.name_servers.substr(0,30)}</td>`;
		x += "</tr>";
		}
	return x + "</table>";
}


function myDomains()
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";
	callApi("users/domains",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return errMsg(msg,document.getElementById("myDomainsBtn"));
			}
		if ("domains" in reply) {
			ctx.domains = reply.domains;
			for(let dom of ctx.domains) {
				dom.display_name = fromPuny(dom.name);
				}
			}
		else delete ctx.domains;
		elm.userSpace.innerHTML = userDomainList()
		});
}



function postUserDetails()
{
	let f = document.editUserDetails;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	data = {
		"name": f.user_name.value,
		"email": f.user_email.value,
		"auto_renew_all": parseInt(f.elements["user_auto_renew_all"].value)
		};

	if (!valid_email.test(data.email)) return regErr("Invalid email address",f.user_email);

	callApi("users/update",(ret,reply) => {
		if (ret) {
			if ("user" in reply) {
				ctx.user = reply.user;
				user_info();
				elm.userSpace.innerHTML = userDetails();
				}
			}
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: data });

	return false;
}


function postUserPassword()
{
	let f = document.editUserPassword;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);
	if (f.new_password.value=="") return regErr("New password missing",f.new_password);
	if (f.confirm_password.value=="") return regErr("Confirm password missing",f.confirm_password);

	if (f.new_password.value != f.confirm_password.value)
		return regErr("Passwords do not match",f.new_password);

	data = {
		"password": f.password.value,
		"new_password": f.new_password.value,
		};

	callApi("users/password",(ret,reply) => {
		if (ret) {
			errMsg("Password changed",elm.userInfo);
			user_info();
			elm.userSpace.innerHTML = userDetails();
			}
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: data });

	return false;
}


function postCloseAccount()
{
	let f = document.editCloseAccount;
	function regErr(err,item) { errMsg(err,f); item.focus(); return false; }

	if (f.password.value=="") return regErr("Password missing",f.password);

	callApi("users/close",(ret,reply) => {
		if (ret) goSearch();
		else {
			if ("error" in reply) msg=reply["error"]; else msg="Failed";
			errMsg(msg,f);
			}
		}, { json: { "password": f.password.value }});

	return false;
}



function user_settings()
{
	let spacer = "<tr><td>"+gbl.gap+"<br><div class='line'></div><br>"+gbl.gap+"</td></tr>";
	let x="<table align=center border=0>";
	x += "<tr><td class=settingsBanner>Change User Details</td></tr>";
	x += "<tr><td>";
	x += "<form name=editUserDetails method=post action=# onSubmit='postUserDetails(); return false;'>";
	x += "<table width=100%>";
	x += `<tr><td class=formPrompt>E-Mail :</td><td><input style="width: 300px;" id='user_email' value='${ctx.user.email}'></td></tr>`;
	x += `<tr><td class=formPrompt>Name :</td><td><input style="width: 300px;" id='user_name' value='${ctx.user.name}'></td></tr>`;
    x += `<tr><td class=formPrompt>Auto Renew All :</td><td><select id='user_auto_renew_all'>`;

    let yes_chk="",no_chk="";
    if (ctx.user.auto_renew_all) yes_chk="selected"; else no_chk="selected";
    x += `<option ${yes_chk} value=1>Yes<option ${no_chk} value=0>No</select></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += spacer + "<tr><td class=settingsBanner>Control Two-Factor Authentication</td></tr>";
	x += "<tr><td><table width=100%>";
	if (("two_fa" in ctx.user) && (ctx.user.two_fa != null) && (ctx.user.two_fa != "")) {
		x += "<tr><td colspan=2>Disable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Disable 2FA","Disable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	else {
		x += "<tr><td colspan=2>Enable Google Authenticator two-factor authentication</td></tr>";
		x += "<tr><td colspan=2></td><td align=right>"+btn("enable_two_fa()","Enable 2FA","Enable Google Authenticator two-factor authentication",100)+"</td></tr>";
		}
	x += "</table></form></td></tr>";


	x += spacer + "<tr><td class=settingsBanner>Change Your Password</td></tr>";
	x += "<tr><td>";
	x += "<form name=editUserPassword method=post action=# onSubmit='postUserPassword(); return false;'>";
	x += "<table width=100%>";
	x += `<tr><td class=formPrompt>Current Password :</td><td>`;
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += `<tr><td class=formPrompt>New Password :</td><td>`;
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Your new password" type=password id='new_password'></td></tr>`;
	x += `<tr><td class=formPrompt>Confirm Password :</td><td>`;
	x += `<input style="width: 300px;" autocomplete="new-password" placeholder="Confirm your new password" type=password id='confirm_password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Change'></td></tr>";
	x += "</table></form></td></tr>";


	x += spacer + "<tr><td class=settingsBanner>Close This Account</td></tr>";
	x += "<tr><td>";
	x += "<form name=editCloseAccount method=post action=# onSubmit='postCloseAccount(); return false;'>";
	x += "<table width=100%>";
	x += "<tr><td colspan=2>To close your account, please enter your current password</td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += `<tr><td class=formPrompt>Current Password :</td><td>`;
	x += `<input style="width: 300px;" autocomplete="current-password" placeholder="Your current password" type=password id='password'></td></tr>`;
	x += "<tr><td colspan=2></td><td align=right><input style='width: 135px;' type=submit class=myBtn value='Close Account'></td></tr>";
	x += "</table></form></td></tr>";


	elm.userSpace.innerHTML = x+"</table>";

	document.editUserDetails.user_email.focus();
}



function userDetails()
{
	let auto_renew = gbl.cross;
	let verified = gbl.cross;
	let has_twofa = gbl.cross;
	if (ctx.user.auto_renew_all) auto_renew = gbl.tick;
	if (ctx.user.email_verified) verified = gbl.tick;
	if (ctx.user.two_fa) has_twofa = gbl.tick;

	let x = "<table align=center width=50% border=0>";
	x += "<tr><td colspan=2 class=btmBtnBar>"
		+btn("user_settings()","Settings","Change this accounts settings",100)

	if (!ctx.user.email_verified) 
		x += btn("resend_verify_email()","Resend Verify","Resend e-mail verification",100);

	x += "</td></tr>";
	x += "<tr><td colspan=2>"+gbl.gap+"</td></tr>";
	x += `<tr><td class=promptCell>E-Mail :</td><td class=dataCell>${ctx.user.email}</td></tr>`;
	x += `<tr><td class=promptCell>E-Mail Verified :</td><td class=dataCell>${verified}</td></tr>`;
	x += `<tr><td class=promptCell>Name :</td><td class=dataCell>${ctx.user.name}</td></tr>`;
	x += `<tr><td class=promptCell>Last Login :</td><td class=dataCell>${ctx.user.last_login_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${ctx.user.amended_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Created :</td><td class=dataCell>${ctx.user.created_dt}</td></tr>`;
	x += `<tr><td class=promptCell>Auto Renew All :</td><td class=dataCell>${auto_renew}</td></tr>`;
	return x + "</table>";
}



function basketCheckout()
{
	hidePopUp();
	show_one_space("basketSpace");
	let x = '<table align=center style="min-width: 50%;" border=0 cellspacing=2 cellpadding=5>' + start_basket_table();
	let total = 0.0
	for(let item of ctx.basket) {
		total += parseFloat(item.cost);
		}
	x += `<tr><td colspan=4><div class="line"/></td></tr>`;
	x += `<tr><td colspan=3 class=promptCell>Total :</td><td align=right>${gbl.cur}${total.toFixed(2)}</td></tr>`;
	x += `<tr><td colspan=4><div class="line"/></td></tr>`;
	x += "<tr><td colspan=4 align=right>"+btn("something()","Place Order & Pay >>>","Please this order & pay")+"</td></tr>";
	elm.basketSpace.innerHTML = x+"</table>"
}



function myAccount()
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = "";
	callApi("users/details",(ret,reply) => {
		if (!ret) {
			let msg="Error in registration";
			if ("error" in reply) msg = reply["error"];
			return errMsg(msg,document.getElementById("myAccountBtn"));
			}
		if ("user" in reply) ctx.user = reply.user; else delete ctx.user;
		elm.userSpace.innerHTML = userDetails();
		});
}



function one_domain_html(dom)
{
	let auto_renew = gbl.cross;
	if (ctx.user.auto_renew_all) auto_renew = gbl.tick + " by account";
	else if (dom.auto_renew) auto_renew = gbl.tick;

	let x = "<table align=center width=50% border=0>";

	x += "<tr><td colspan=4 class=btmBtnBar>"
		+btn(`buy_one_name('${dom.name}','renew')`,`Renew ${dom.display_name}`,"Renew this domain",100)
		+btn(`domain_settings('${dom.name}')`,"Settings",`Edit the settings for ${dom.display_name}`,100)

	x += "</td></tr>";

	x += "<tr><td colspan=4>"+gbl.gap+"</td></tr>";
	let puny = "";
	let ns = item.name_servers.toLowerCase().split(",").sort().join("<br>")
	let ds = item.ds_recs.toLowerCase().split(",").sort().join("<br>")
	if (dom.display_name != dom.name) puny = `&nbsp;&nbsp;<span class=searchRenew>${dom.name}</span>`;
	x += `<tr title="${dom.name}"><td class=promptCell>Name :</td><td class=dataCell>${dom.display_name}${puny}</td></tr>`;
	x += `<tr><td class=promptCell>Expiry Date :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Create Date :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Last Amended :</td><td class=dataCell>${item.expiry_dt.split(" ")[0]}</td></tr>`;
	x += `<tr><td class=promptCell>Name Servers :</td><td class=dataCell>${ns}</td></tr>`;
	x += `<tr><td class=promptCell>DS Records :</td><td class=dataCell>${ds}</td></tr>`;
	x += `<tr><td class=promptCell>Auto Renew :</td><td class=dataCell>${auto_renew}</td></tr>`;
	return x + "</table>";
}



function show_one_domain(idx)
{
	show_one_space("userSpace");
	elm.userSpace.innerHTML = one_domain_html(ctx.domains[idx]);
}



function unerrMsg()
{
	let t1 = elm.myMsgPop.innerHTML;
	let t2 = ctx.lastErrMsg;
	if (t2 == null) t2 = "";
	if (t1 == t2) elm.myMsgPop.className = "msgPop msgPopNo";
	delete ctx.lastErrMsg;
	if ("err_msg_tout" in ctx) clearTimeout(ctx.err_msg_tout);
	delete ctx.err_msg_tout;
}



function errMsg(txt,elem,min_width)
{
	if (!elem) { console.log("ERROR: ${txt} gave no element to hook to "); return; }

	let m = elm.myMsgPop;
	m.style.width = "auto";
	if (txt.substr(0,1)!="&") txt = gbl.warn + " " + txt;
	m.innerHTML = "&nbsp;"+txt+"&nbsp;";

	let p_box = elem.getBoundingClientRect();
	let m_box = m.getBoundingClientRect();
	let m_width = m_box.width;

	if (m_box.width < p_box.width) {
		m.style.width = p_box.width + "px";
		m_width = p_box.width;
		}
	let centre = p_box.x + (p_box.width/2);
	let x_pos = centre - (m_width / 2)
	m.style.left = x_pos + "px";
	m.style.top = p_box.y + p_box.height + "px";

	m.className = 'msgPop msgPopYes';
	ctx.lastErrMsg = m.innerHTML;
	ctx.err_msg_tout = setTimeout(unerrMsg,2500);
}




</script>
<body onLoad="bodyLoaded();">
<div id="topSpan">
<table border=0 width=100% cellspacing=0 cellpadding=5 style="margin-top: 15px;">
<tr>
<td align=left><span id="businessName" class="businessName">Registrar</span></td>
<td align=right>

<span style="display: none;" id="noLoginBtns">

<div class="popup">
<span style='width: 75px;' tabindex=0 title="Register me" class=myBtn onClick="toggleRegister(); return false;">Register</span>
<span class="popuptext" id="registerPopup">
<form onSubmit='doRegister(); return false;' method=submit action='#' name=formRegister><table>
<tr onClick="toggleRegister();"><Td colspan=2><div style="height: 15px;"></div></td></tr>
	<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Name:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="name">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
	<tr><td class=formPrompt>&nbsp;Confirm:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="confirm">&nbsp;</td></tr>
<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
<tr>
	<td class=btmBtnBar colspan=2>
		<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleRegister();">Cancel</span>
		<input style='width: 110px;' tabindex=0 type=submit title="Register" class=myBtn value="Register">
	</td>
</tr></form></table>
</span></div>


<div class="popup">
<span style='width: 75px;' tabindex=0 title="Get me logged in" class=myBtn onClick="toggleLogin(); return false;">Login</span>
<span class="popuptext" id="loginPopup">
	<table>
		<form onSubmit='return doLogin();' action="#" method=post name=formLogin>
		<tr onClick="toggleLogin()"><Td colspan=2><div style="height: 15px;"></div></td></tr>
			<tr><td class=formPrompt>&nbsp;E-Mail:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" name="email">&nbsp;</td></tr>
			<tr><td class=formPrompt>&nbsp;Password:&nbsp;</td><td><input onkeydown="keyEsc(event);" style="width: 250px;" type=password name="password">&nbsp;</td></tr>
		<tr><td colspan=2><div style='height: 7px;'></div></td></tr>
		<tr>
			<td class=btmBtnBar colspan=2>
				<span style='width: 75px;' tabindex=0 title="Cancel" class=myBtn onClick="toggleLogin()">Cancel</span>
				<input style='width: 110px;' tabindex=0 type=submit title="Login" class=myBtn value="OK">
			</td>
		</tr>
		</form>
	</table>
</span>
</div>
</span>

<span style="display:none;" id="isLoggedIn">
	<span style='width: 75px;' tabindex=0 title="List my domains" id="myDomainsBtn" class=myBtn onClick="myDomains(); return false;">Domains</span>
	<span style='width: 75px;' tabindex=0 title="My account details" id="myAccountBtn" class=myBtn onClick="myAccount(); return false;">Account</span>
	<span style='width: 75px;' tabindex=0 title="Log me out" class=myBtn onClick="doLogOut(); return false;">Logout</span>
</span>
</td></tr>
</td></tr>


<tr><Td>
<div class="popBelow">
<span style='width: 85px;' tabindex=0 title="Change theme" class=myBtn onClick="toggleTheme();">Theme</span>
<span class="popBelowText" id="themePopup">
<table style="width: 120px;" border=0 cellspacing=2 cellpadding=5>
<tr class=dataRow onClick='do_theme_change("dark");'><td>dark</td></tr>
<tr class=dataRow onClick='do_theme_change("light");'><td>light</td></tr>
<tr class=dataRow onClick='do_theme_change("red");'><td>red</td></tr>
<tr class=dataRow onClick='do_theme_change("green");'><td>green</td></tr>
<tr class=dataRow onClick='do_theme_change("blue");'><td>blue</td></tr>
</table>
</span>
<span style='width: 85px;' tabindex=0 title="Domain name search" class=myBtn onClick="goSearch();">Search</span>
<span style='width: 85px;' tabindex=0 title="Go to the domain market place" class=myBtn onClick="goMarketPlace();">Marketplace</span>
</div>

</td>
<td align=right><table border=0>
<tr><td><span id="basketIcon" style="margin-right: 75px; display: none;" class="popup">
<span class=userIcons title="You have items waiting to checkout" ${style} onClick='togglePopUp("basketPopup",30000);'>&#128722;</span>
<span style="margin-left: -250px;" class="popuptext" id="basketPopup">
</span></span></td><td><span id="userInfo"></span></td></tr></table></td>
</tr></table>
</div>

<div id="allBottom" onClick="hidePopUp();">
	<div style='height: 30px;'></div>
	<div id="search">
		<div style='height: 30px;'></div>
		<table align=center width=40% border=0>
		<form action="#" name=searchForm onSubmit="return doSearch();">
			<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox name=search></td></tr>
		</form>
			<tr><td><div id="output"></div></td></tr>
		</table>
	</div>
	<span class="botSapce" id="userSpace" style="display: none;"></span>
	<span class="botSapce" id="basketSpace" style="display: none;"></span>
	<span class="botSapce" id="marketPlace" style="display: none;"></span>
</div>

<div><table><tr><td><div id=myMsgPop class='msgPop msgPopNo'></div></td></tr></table></div>
</body>
</html>
