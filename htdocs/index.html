<html>
<head>
    <title>Python Registrar</title>
    <meta charSet="utf-8"/>
	<script src="/theme.js"></script>
	<script src="/punycode.js"></script>
	<script src="/lib.js"></script>
</head>
<style type='text/css'></style>
<script language="Javascript">

debugAPI = true;


gbl = {
	"server": window.location.host,
	"theme": window.localStorage.getItem("theme"),

    tick: "&#x2611;",
    cross: "&#x2612;",
    timer: "&#x23f3;",
    bin: "&#x2702;",
    warn: "&#x26a0;",
    page: "&#x1F5CE;",
    nsec: "&#x1F512;",
    nsec3: "&#x1F510;",
    clip: "&#x1F4CE;",

    cur: "$",
    cur_iso: "USD",

    gap: "<div style='height: 7px;'></div>",

    max_checks: 2
	};

ctx = {};

if ((gbl.theme == null)||(!(gbl.theme in theme_colours))) {
	gbl.theme="dark";
	window.localStorage.setItem("theme",gbl.theme);
	}

changeTheme(gbl.theme);

function errMsg(line) { console.log("errMsg",line); }
function msg(line)
{
	let e = document.getElementById("output");
	if (e) e.innerHTML = "<h2>" + line + "</h2>";
}


function bodyLoaded()
{
	gbl.elm = {};
	["topSpan","searchForm"].forEach(i => { gbl.elm[i] = document.getElementById(i); } );

	callApi("config",data => {
		gbl.config = data;
		gbl.config.ok_tlds = {}
		for(let item of gbl.config.zones) gbl.config.ok_tlds[item.name] = true;
		console.log(gbl.config);

		let x = `<table style="margin-top: 20px;" width=100%><tr><Td class=businessName>${policy("business_name","Registrar")}</td></tr></table>`
		gbl.elm.topSpan.innerHTML = x;

		gbl.cur = policy("currency_symbol","$");
		gbl.cur_iso = policy("currency_iso","USD");
		});
}


/*
function fromIDN()
{
	let f = document.form1;
	f.puny.value = toASCII(f.idn.value);
	f.idn.value = "";
}



function fromPuny()
{
	let f = document.form1;
	f.idn.value = toUnicode(f.puny.value);
	f.puny.value = "";
}
*/


function one_search_line(item)
{
	if (!item.avail) return "";

	let x = "<tr>";
	x += `<td><span class=searchDomain>${fromPuny(item.name)}`;
	if ("renew" in item)
		x += `<br><span class=searchRenew>renew ${gbl.cur}${item.renew}</span>`;
	x += "</td>";

	if ("reason" in item) x += `<td colspan=2>${item.reason}</td>`;
	else {
		if ("create" in item) {
			x += "<td align=right>";
			x += btn(`buyOneName('${item.name}')`,`<b>BUY ${gbl.cur}${item.create}</b>`,`Buy '${item.name}' for ${gbl.cur}${item.create}`,120);
			x += "</td>";
			}
		}
	x += "</tr>";
	return x;
}



function showSearch(data)
{
	let e = document.getElementById("output");

	if ("error" in data) { msg(data.error); return; }

	for(let item of data) gbl.search.result += one_search_line(item);
	e.innerHTML = "<table width=100%>" + gbl.search.result + "</table>";

	if (("search" in gbl)&&("todo" in gbl.search)) {
		if (gbl.search.todo.length <= 0) delete gbl.search.todo; else searchNext();
		}
	else {
		gbl.search.result += "<tr><Td>" + gbl.gap + "</td></tr>";
		let name = data[0]["name"];
		let pos = name.indexOf(".");
		if (pos > 0) multiSearch(name.substr(0,pos),name.substr(pos+1));
		}
}



function buyOneName(name)
{
	callApi("domain/check",(data) => {

		let item = data.shift();
		let e = document.getElementById("output");
		e.innerHTML = `<h2>Buy '${item.name}' for ${gbl.cur}${item.create}</h2>`;

		}, { json: { "domain" : name }}); 
}



function searchNext()
{
	let first = gbl.search.todo.shift();
	let srch = [ gbl.search.term + "." + first.name ];

	let max = gbl.max_checks;

	if ((first.provider in gbl.config.providers)&&("max_checks" in gbl.config.providers[first.provider]))
		max = gbl.config.providers[first.provider].max_checks;

	while((gbl.search.todo.length > 0)&&(srch.length < max)&&(first.provider == gbl.search.todo[0].provider)) {
		let nxt = gbl.search.todo.shift();
		srch.push(gbl.search.term + "." + nxt.name);
		}

	callApi("domain/check",showSearch, { json: {"domain" : srch }} );
}




function multiSearch(srch,not_me_tld)
{
	gbl.search.todo = [];
	gbl.search.term = srch;
	for(let x of gbl.config.zones) {
		if ((not_me_tld==null)||(x.name!=not_me_tld)) gbl.search.todo.push(x);
		}

	searchNext();
}



function doSearch()
{
    function do_end() {
		f.search.focus();
		f.search.select();
		return false;
    	}

    delete gbl.search;

	let e = document.getElementById("output");
	e.innerHTML = "";

    gbl.search = {};
	gbl.search.result = "<tr><Td>" + gbl.gap + "</td></tr>";

    f = document.searchForm;
    let srch = toASCII(f.search.value);

    if (srch.indexOf(".") >= 0) {
		if (!supported_tld(srch)) {
			msg("Not a supported TLD");
			return do_end(); }

		if (!fqdnCheck.test(srch)) {
			msg("Invald domain name");
			return do_end(); }

		callApi("domain/check",showSearch, { "callErr" : true, json: {"domain" : srch }} );
		return do_end();
		}
	
	if (!hostnameCheck.test(srch))
		msg("Invald domain name");
	else
		multiSearch(srch,null);

	return do_end();
}



function supported_tld(fqdn)
{
	if ((pos = fqdn.indexOf(".")) < 0) return false;
	return (fqdn.substr(pos+1) in gbl.config.ok_tlds);
}

</script>
<body onLoad="bodyLoaded();">
<div id="topSpan"></div>

<div id="searchForm">
<table align=center>
<form action="#" name=searchForm onSubmit="return doSearch();">
<tr><td><input placeholder="Enter a domain to search for" autofocus class=searchBox name=search size=40></td></tr>
</form>
<tr><td><div id="output"></div></div></td></tr>
</table>

</body>
</html>
